<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Barmods Store - Produk</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #020617;
      --bg-soft: #020617;
      --card: #020617;
      --accent: #6366f1;
      --accent-soft: rgba(99,102,241,.16);
      --text: #e5e7eb;
      --text-soft: #94a3b8;
      --border: rgba(148,163,184,.35);
    }
    body.light {
      --bg: #f3f4f6;
      --bg-soft: #e5e7eb;
      --card: #ffffff;
      --accent: #4f46e5;
      --accent-soft: rgba(79,70,229,.1);
      --text: #020617;
      --text-soft: #6b7280;
      --border: rgba(148,163,184,.6);
    }
    *{box-sizing:border-box;}
    body {
      margin:0;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:radial-gradient(circle at top,#1d2538 0,#020617 55%);
      color:var(--text);
    }
    .topbar {
      height:60px;
      background:linear-gradient(90deg,#020617,#0b1120);
      display:flex;
      align-items:center;
      padding:0 14px;
      gap:10px;
      position:fixed;
      top:0;left:0;right:0;
      border-bottom:1px solid rgba(148,163,184,.4);
      z-index:20;
    }
    body.light .topbar {
      background:linear-gradient(90deg,#ffffff,#e5e7eb);
    }
    .brand-title {
      display:flex;
      flex-direction:column;
    }
    .brand-title span:first-child {
      font-weight:700;
      font-size:15px;
    }
    .brand-title span:last-child {
      font-size:11px;
      color:var(--text-soft);
    }
    .spacer {flex:1;}
    .top-actions {
      display:flex;
      align-items:center;
      gap:6px;
    }
    .btn-top {
      border-radius:999px;
      border:1px solid var(--border);
      background:rgba(15,23,42,.6);
      color:var(--text);
      padding:6px 10px;
      font-size:11px;
      display:flex;
      align-items:center;
      gap:4px;
      text-decoration:none;
      cursor:pointer;
    }
    body.light .btn-top {
      background:#f9fafb;
    }
    .main {
      padding:72px 12px 18px;
      max-width:960px;
      margin:0 auto;
    }
    .card {
      background:var(--card);
      border-radius:16px;
      padding:12px 12px 10px;
      border:1px solid var(--border);
      margin-bottom:10px;
      box-shadow:0 12px 30px rgba(15,23,42,.4);
    }
    body.light .card {
      box-shadow:0 14px 30px rgba(15,23,42,.12);
    }
    .card-header {
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:6px;
    }
    .card-header h2 {
      margin:0;
      font-size:15px;
    }
    .card-header small {
      font-size:11px;
      color:var(--text-soft);
    }
    .card p {
      margin:0;
      color:var(--text-soft);
      font-size:12px;
      line-height:1.4;
    }
    .pill-row {
      margin-top:8px;
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      font-size:11px;
    }
    .pill {
      padding:4px 8px;
      border-radius:999px;
      border:1px solid var(--border);
    }
    .admin-contact-big {
      margin-top:10px;
      display:flex;
      flex-wrap:wrap;
      gap:8px;
    }
    .btn-primary {
      background:var(--accent);
      color:#fff;
      border:none;
      border-radius:999px;
      padding:7px 12px;
      font-size:12px;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      gap:6px;
      cursor:pointer;
    }
    .btn-outline {
      border-radius:999px;
      border:1px solid var(--border);
      padding:7px 12px;
      font-size:12px;
      text-decoration:none;
      color:var(--text-soft);
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .search-row {
      margin:6px 0 8px;
      display:flex;
      gap:6px;
    }
    .search-input {
      flex:1;
      padding:7px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background:var(--bg-soft);
      color:var(--text);
      font-size:12px;
    }
    .search-input::placeholder {
      color:var(--text-soft);
    }
    .product-grid {
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:8px;
      margin-top:4px;
    }
    @media(max-width:520px) {
      .product-grid {
        grid-template-columns:1fr 1fr;
      }
    }
    .product-card {
      background:var(--bg-soft);
      border-radius:12px;
      padding:8px;
      border:1px solid rgba(148,163,184,.4);
      font-size:12px;
      display:flex;
      flex-direction:column;
      gap:4px;
      transition:.15s transform,.15s box-shadow,.15s border-color;
    }
    .product-card:hover {
      transform:translateY(-1px);
      border-color:var(--accent);
      box-shadow:0 10px 18px rgba(15,23,42,.45);
    }
    .product-header {
      display:flex;
      align-items:center;
      gap:6px;
    }
    .product-icon {
      width:22px;
      height:22px;
      border-radius:999px;
      background:var(--accent-soft);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:13px;
    }
    .product-title {
      font-weight:600;
      font-size:12px;
    }
    .price-tag {
      color:#22c55e;
      font-weight:700;
      font-size:12px;
    }
    .stock-line {
      color:var(--text-soft);
      font-size:11px;
    }
    .btn-product {
      margin-top:2px;
      align-self:flex-start;
      padding:5px 9px;
      border-radius:999px;
      background:var(--accent);
      color:#fff;
      font-size:11px;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      gap:4px;
      cursor:pointer;
    }
    .btn-product span.icon {
      font-size:12px;
    }
    .admin-table {
      width:100%;
      border-collapse:collapse;
      margin-top:8px;
      font-size:11px;
    }
    .admin-table th,
    .admin-table td {
      padding:5px 4px;
      border-bottom:1px solid var(--border);
      text-align:left;
    }
    .status-text {
      text-transform:lowercase;
      font-weight:600;
      font-size:11px;
    }
    .status-pending { color:#facc15; }
    .status-proses  { color:#3b82f6; }
    .status-eror    { color:#f97373; }
    .status-sukses  { color:#22c55e; }

    /* Modal */
    .modal-backdrop {
      position:fixed;
      inset:0;
      background:rgba(15,23,42,.8);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:40;
    }
    .modal {
      width:90%;
      max-width:320px;
      background:var(--card);
      border-radius:16px;
      padding:14px 14px 12px;
      border:1px solid var(--border);
      box-shadow:0 18px 40px rgba(0,0,0,.7);
    }
    .modal h3 {
      margin:0 0 4px;
      font-size:15px;
    }
    .modal p {
      margin:0 0 8px;
      font-size:12px;
      color:var(--text-soft);
    }
    .modal-input {
      width:100%;
      padding:7px 9px;
      border-radius:999px;
      border:1px solid var(--border);
      background:var(--bg-soft);
      color:var(--text);
      font-size:12px;
      margin-bottom:6px;
    }
    .modal-actions {
      display:flex;
      justify-content:flex-end;
      gap:6px;
      margin-top:6px;
    }
    .btn-cancel {
      border-radius:999px;
      border:1px solid var(--border);
      background:transparent;
      color:var(--text-soft);
      padding:6px 10px;
      font-size:12px;
      cursor:pointer;
    }
    .btn-ok {
      border-radius:999px;
      border:none;
      background:var(--accent);
      color:#fff;
      padding:6px 10px;
      font-size:12px;
      cursor:pointer;
    }
    .modal-msg {
      font-size:11px;
      margin-top:4px;
      min-height:14px;
    }
    .modal-msg.error {color:#f97373;}
    .modal-msg.ok {color:#22c55e;}
  </style>
</head>
<body>

<div class="topbar">
  <div class="brand-title">
    <span>Barmods Store</span>
    <span>Layanan Digital & Sosial Media</span>
  </div>
  <div class="spacer"></div>
  <div class="top-actions">
    <a href="https://wa.me/6283877842721" class="btn-top">üìû Admin</a>
    <button type="button" class="btn-top" onclick="toggleTheme()" id="themeBtn">üåô Gelap</button>
    <button type="button" class="btn-top" id="logoutBtn">üö™ Logout</button>
  </div>
</div>

<div class="main">
  <!-- DASHBOARD / PRODUK -->
  <div id="dashboard" style="display:none;">
    <div class="card">
      <div class="card-header">
        <div>
          <h2>Cara Order</h2>
          <small>Via DANA + form di website + upload bukti</small>
        </div>
      </div>
      <p>
        1. Pastikan sudah <b>login</b> (email & password Barmods).<br>
        2. Pilih produk di bawah.<br>
        3. Tekan tombol <b>Order Sekarang</b> pada produk.<br>
        4. Isi data DANA & data tambahan (username / link / user panel) di form.<br>
        5. Upload <b>SS bukti transfer</b> langsung di form (WAJIB).<br>
        6. Admin akan cek data & mengirim produk melalui riwayat pesanan kamu.
      </p>
      <div class="admin-contact-big">
        <a class="btn-primary" href="https://wa.me/6283877842721">üí¨ Chat WhatsApp Admin</a>
        <a class="btn-outline" href="mailto:holilhsyhd@gmail.com">‚úâÔ∏è Kirim Email Admin</a>
      </div>
      <div class="pill-row">
        <div class="pill">Pembayaran: DANA 083877842721</div>
        <div class="pill">Upload SS bukti transfer di form order</div>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <div>
          <h2>Daftar Produk</h2>
          <small>Scroll ke bawah untuk melihat semua produk</small>
        </div>
      </div>
      <div class="search-row">
        <input id="searchInput" class="search-input" placeholder="Cari produk (misal: Netflix, Spotify, Followers)...">
      </div>
      <div class="product-grid" id="productGrid"></div>
    </div>

    <!-- RIWAYAT PESANAN USER -->
    <div class="card" id="myOrdersCard" style="display:none;">
      <div class="card-header">
        <div>
          <h2>Riwayat Pesanan Saya</h2>
          <small>Hanya order dari akun kamu yang tampil di sini</small>
        </div>
      </div>
      <table class="admin-table" id="myOrderTable">
        <thead>
          <tr>
            <th>#</th>
            <th>Waktu</th>
            <th>Produk</th>
            <th>Status</th>
            <th>Produk dari Admin</th>
            <th>Bukti</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<!-- MODAL ORDER / DANA -->
<div class="modal-backdrop" id="orderModal">
  <div class="modal">
    <h3>Pembayaran via DANA</h3>
    <p>
      Silakan transfer dulu ke DANA:<br>
      <b>083877842721</b><br>
      Setelah bayar, pilih <b>Sudah bayar</b> untuk isi data & upload bukti.
    </p>

    <div id="orderStepButtons">
      <div class="modal-actions">
        <button type="button" class="btn-cancel" onclick="orderBelumBayar()">Belum bayar</button>
        <button type="button" class="btn-ok" onclick="orderSudahBayar()">Sudah bayar</button>
      </div>
    </div>

    <div id="orderStepForm" style="display:none;">
      <p>Isi data DANA kamu:</p>
      <input id="orderDana" class="modal-input" placeholder="Nomor DANA kamu">
      <input id="orderNama" class="modal-input" placeholder="Atas nama di DANA">

      <!-- KHUSUS SOSMED: FOLLOWERS -->
      <div id="sosmedFollowersFields" style="display:none;margin-top:6px;">
        <p style="font-size:11px;color:var(--text-soft);margin:0 0 4px;">
          Data akun untuk <b>followers</b> (akun tidak boleh private):
        </p>
        <input id="sosmedUsernameFollowers" class="modal-input" placeholder="Username akun (tanpa @)">
      </div>

      <!-- KHUSUS SOSMED: LIKES / VIEWERS -->
      <div id="sosmedLikesFields" style="display:none;margin-top:6px;">
        <p style="font-size:11px;color:var(--text-soft);margin:0 0 4px;">
          Data untuk <b>likes / viewers</b>:
        </p>
        <input id="sosmedLink" class="modal-input" placeholder="Link video (harus publik)">
        <input id="sosmedUsernameLikes" class="modal-input" placeholder="Username (opsional, disarankan tidak private)">
      </div>

      <!-- KHUSUS PANEL -->
      <div id="panelFields" style="display:none;margin-top:6px;">
        <p style="font-size:11px;color:var(--text-soft);margin:0 0 4px;">
          Pilih <b>username</b> dan <b>password</b> untuk login panel:
        </p>
        <input id="panelUser" class="modal-input" placeholder="Username panel yang diinginkan">
        <input id="panelPass" class="modal-input" placeholder="Password panel yang diinginkan">
      </div>

      <!-- UPLOAD BUKTI TRANSFER -->
      <div style="margin-top:6px;">
        <p style="font-size:11px;color:var(--text-soft);margin:0 0 4px;">
          Upload <b>Screenshot bukti transfer</b> (jpg/png) ‚Äì wajib:
        </p>
        <input id="orderBukti" class="modal-input" type="file" accept="image/*">
      </div>

      <p style="font-size:11px;color:var(--text-soft);margin:4px 0 0;">
        Setelah data & bukti tersimpan, admin akan cek pembayaran kamu.
      </p>
      <div class="modal-actions">
        <button type="button" class="btn-cancel" onclick="closeOrderModal()">Batal</button>
        <button type="button" class="btn-ok" onclick="orderSekarang()">Order Sekarang</button>
      </div>
      <div id="orderMsg" class="modal-msg"></div>
    </div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import {
    getFirestore,
    collection,
    getDocs,
    doc,
    setDoc,
    updateDoc,
    addDoc,
    query,
    orderBy,
    where
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  import {
    getStorage,
    ref as storageRef,
    uploadBytes,
    getDownloadURL
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";
  import {
    getAuth,
    onAuthStateChanged,
    signOut
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBpsfDmupS9wq-iNge5aYvknmw5bSryd3A",
    authDomain: "toko-barmods.firebaseapp.com",
    projectId: "toko-barmods",
    storageBucket: "toko-barmods.firebasestorage.app",
    messagingSenderId: "284047189012",
    appId: "1:284047189012:web:6ef0c6891adab08a383301"
  };

  const app = initializeApp(firebaseConfig);
  const db  = getFirestore(app);
  const storage = getStorage(app);
  const auth = getAuth(app);

  // ========= DATA PRODUK DASAR =========
  const defaultProducts = [
    {id:1,name:"Alight Motion Private - 1 Tahun (iOS & Android)",price:"Rp 2k",stock:50,category:"editing",icon:"üé®"},
    {id:2,name:"Bulk AM Private - 1 Bulan (10 akun)",price:"Rp 7k",stock:50,category:"editing",icon:"üé®"},
    {id:3,name:"Apple Music Invite - 1 Bulan",price:"Rp 5k",stock:50,category:"music",icon:"üéµ"},
    {id:4,name:"Apple Music Head - 1 Bulan",price:"Rp 8k",stock:50,category:"music",icon:"üéµ"},
    {id:5,name:"Bstation Sharing - 1 Bulan",price:"Rp 5k",stock:50,category:"streaming",icon:"üé¨"},
    {id:6,name:"Bstation Private - 1 Bulan",price:"Rp 32k",stock:50,category:"streaming",icon:"üé¨"},
    {id:7,name:"Canva Member - 1 Bulan",price:"Rp 2k",stock:50,category:"editing",icon:"üé®"},
    {id:8,name:"Canva Member - 1 Tahun",price:"Rp 4k",stock:50,category:"editing",icon:"üé®"},
    {id:9,name:"Canva Owner - 1 Bulan",price:"Rp 5k",stock:50,category:"editing",icon:"üé®"},
    {id:10,name:"Capcut Private - 7 Hari",price:"Rp 2k",stock:50,category:"editing",icon:"üé®"},
    {id:11,name:"Capcut Sharing - 21 Hari",price:"Rp 3k",stock:50,category:"editing",icon:"üé®"},
    {id:12,name:"Capcut Sharing - 1 Bulan",price:"Rp 5k",stock:50,category:"editing",icon:"üé®"},
    {id:13,name:"Capcut Private - 21 Hari",price:"Rp 7k",stock:50,category:"editing",icon:"üé®"},
    {id:14,name:"Capcut Private - 1 Bulan",price:"Rp 8k",stock:50,category:"editing",icon:"üé®"},
    {id:15,name:"ChatGPT Plus Sharing - 1 Bulan (bergaransi)",price:"Rp 7k",stock:50,category:"ai",icon:"ü§ñ"},
    {id:16,name:"ChatGPT Private - 1 Bulan (bergaransi)",price:"Rp 30k",stock:50,category:"ai",icon:"ü§ñ"},
    {id:17,name:"Fizzo Novel Sharing - 1 Bulan",price:"Rp 3k",stock:50,category:"editing",icon:"üé®"},
    {id:18,name:"Iqiyi Sharing Plan Standar - 1 Bulan",price:"Rp 3k",stock:50,category:"streaming",icon:"üé¨"},
    {id:19,name:"Iqiyi Sharing Plan Premium - 1 Bulan",price:"Rp 5k",stock:50,category:"streaming",icon:"üé¨"},
    {id:20,name:"Iqiyi Standar - 1 Bulan (Private)",price:"Rp 30k",stock:50,category:"streaming",icon:"üé¨"},
    {id:21,name:"Iqiyi Premium - 1 Bulan (Private)",price:"Rp 40k",stock:50,category:"streaming",icon:"üé¨"},
    {id:22,name:"Lightroom - 1 Tahun",price:"Rp 7k",stock:50,category:"editing",icon:"üé®"},
    {id:23,name:"Netflix 1p2u",price:"Rp 20k",stock:50,category:"streaming",icon:"üé¨"},
    {id:24,name:"Netflix 1p1u",price:"Rp 30k",stock:50,category:"streaming",icon:"üé¨"},
    {id:25,name:"Picsart Sharing - 1 Bulan",price:"Rp 3k",stock:50,category:"editing",icon:"üé®"},
    {id:26,name:"Picsart Private - 1 Bulan",price:"Rp 7k",stock:50,category:"editing",icon:"üé®"},
    {id:27,name:"Spotify Premium - 1 Bulan (bergaransi)",price:"Rp 8k",stock:50,category:"music",icon:"üéµ"},
    {id:28,name:"Vidio Platinum Sharing - 1 Bulan",price:"Rp 17k",stock:50,category:"streaming",icon:"üé¨"},
    {id:29,name:"Vidio Platinum Private - 1 Bulan",price:"Rp 28k",stock:50,category:"streaming",icon:"üé¨"},
    {id:30,name:"Vision Ultimate Private - 1 Bulan",price:"Rp 40k",stock:50,category:"streaming",icon:"üé¨"},
    {id:31,name:"Viu Antilimit - 200 Tahun",price:"Rp 2k",stock:50,category:"streaming",icon:"üé¨"},
    {id:32,name:"Wetv Sharing - 1 Bulan (8u)",price:"Rp 6k",stock:50,category:"streaming",icon:"üé¨"},
    {id:33,name:"Wetv Sharing - 1 Bulan (5u)",price:"Rp 8k",stock:50,category:"streaming",icon:"üé¨"},
    {id:34,name:"Wetv Private - 1 Bulan",price:"Rp 30k",stock:50,category:"streaming",icon:"üé¨"},
    {id:35,name:"Wink Premium Private Android - 7 Hari",price:"Rp 7k",stock:50,category:"editing",icon:"üé®"},
    {id:36,name:"Youku Sharing - 1 Bulan",price:"Rp 4k",stock:50,category:"streaming",icon:"üé¨"},
    {id:37,name:"Youku Private - 1 Bulan",price:"Rp 24k",stock:50,category:"streaming",icon:"üé¨"},
    {id:38,name:"YouTube Famplan",price:"Rp 3k",stock:50,category:"streaming",icon:"üé¨"},
    {id:39,name:"YouTube Indplan - 1 Bulan",price:"Rp 8k",stock:50,category:"streaming",icon:"üé¨"},
    {id:40,name:"YouTube Indplan - 2 Bulan",price:"Rp 9k",stock:50,category:"streaming",icon:"üé¨"},
    {id:41,name:"YouTube Head - 1 Bulan",price:"Rp 10k",stock:50,category:"streaming",icon:"üé¨"},
    {id:42,name:"YouTube Indplan - 3 Bulan",price:"Rp 11k",stock:50,category:"streaming",icon:"üé¨"},
    {id:43,name:"Panel Pterodactyl 1GB",price:"Rp 1k",stock:50,category:"panel",icon:"üñ•Ô∏è"},
    {id:44,name:"Panel Pterodactyl 2GB",price:"Rp 2k",stock:50,category:"panel",icon:"üñ•Ô∏è"},
    {id:45,name:"Panel Pterodactyl 3GB",price:"Rp 3k",stock:50,category:"panel",icon:"üñ•Ô∏è"},
    {id:46,name:"Panel Pterodactyl 4GB",price:"Rp 4k",stock:50,category:"panel",icon:"üñ•Ô∏è"},
    {id:47,name:"Panel Pterodactyl 5GB",price:"Rp 5k",stock:50,category:"panel",icon:"üñ•Ô∏è"},
    {id:48,name:"Panel Pterodactyl 6GB",price:"Rp 6k",stock:50,category:"panel",icon:"üñ•Ô∏è"},
    {id:49,name:"Panel Pterodactyl 7GB",price:"Rp 7k",stock:50,category:"panel",icon:"üñ•Ô∏è"},
    {id:50,name:"Panel Pterodactyl 8GB",price:"Rp 8k",stock:50,category:"panel",icon:"üñ•Ô∏è"},
    {id:51,name:"Panel Pterodactyl 9GB",price:"Rp 9k",stock:50,category:"panel",icon:"üñ•Ô∏è"},
    {id:52,name:"Panel Pterodactyl Unlimited",price:"Rp 10k",stock:50,category:"panel",icon:"üñ•Ô∏è"},
    {id:53,name:"Tracking Camera",price:"Rp 20k",stock:50,category:"tools",icon:"üõ†Ô∏è"},
    {id:54,name:"Instagram Likes 1.000",price:"Rp 3k",stock:50,category:"sosmed",icon:"üì±"},
    {id:55,name:"Instagram Likes 2.000",price:"Rp 6k",stock:50,category:"sosmed",icon:"üì±"},
    {id:56,name:"Instagram Likes 3.000",price:"Rp 9k",stock:50,category:"sosmed",icon:"üì±"},
    {id:57,name:"Instagram Likes 4.000",price:"Rp 12k",stock:50,category:"sosmed",icon:"üì±"},
    {id:58,name:"Instagram Likes 5.000",price:"Rp 15k",stock:50,category:"sosmed",icon:"üì±"},
    {id:59,name:"Instagram Likes 6.000",price:"Rp 18k",stock:50,category:"sosmed",icon:"üì±"},
    {id:60,name:"Instagram Likes 7.000",price:"Rp 21k",stock:50,category:"sosmed",icon:"üì±"},
    {id:61,name:"Instagram Likes 8.000",price:"Rp 24k",stock:50,category:"sosmed",icon:"üì±"},
    {id:62,name:"Instagram Likes 9.000",price:"Rp 27k",stock:50,category:"sosmed",icon:"üì±"},
    {id:63,name:"Instagram Likes 10.000",price:"Rp 30k",stock:50,category:"sosmed",icon:"üì±"},
    {id:64,name:"TikTok Likes 100",price:"Rp 5k",stock:50,category:"sosmed",icon:"üì±"},
    {id:65,name:"TikTok Likes 200",price:"Rp 10k",stock:50,category:"sosmed",icon:"üì±"},
    {id:66,name:"TikTok Likes 300",price:"Rp 15k",stock:50,category:"sosmed",icon:"üì±"},
    {id:67,name:"TikTok Likes 400",price:"Rp 20k",stock:50,category:"sosmed",icon:"üì±"},
    {id:68,name:"TikTok Likes 500",price:"Rp 25k",stock:50,category:"sosmed",icon:"üì±"},
    {id:69,name:"TikTok Likes 600",price:"Rp 30k",stock:50,category:"sosmed",icon:"üì±"},
    {id:70,name:"TikTok Likes 700",price:"Rp 35k",stock:50,category:"sosmed",icon:"üì±"},
    {id:71,name:"TikTok Likes 800",price:"Rp 40k",stock:50,category:"sosmed",icon:"üì±"},
    {id:72,name:"TikTok Likes 900",price:"Rp 45k",stock:50,category:"sosmed",icon:"üì±"},
    {id:73,name:"TikTok Likes 1.000",price:"Rp 50k",stock:50,category:"sosmed",icon:"üì±"},
    {id:74,name:"Instagram Followers 100",price:"Rp 5k",stock:50,category:"sosmed",icon:"üì±"},
    {id:75,name:"Instagram Followers 200",price:"Rp 10k",stock:50,category:"sosmed",icon:"üì±"},
    {id:76,name:"Instagram Followers 300",price:"Rp 15k",stock:50,category:"sosmed",icon:"üì±"},
    {id:77,name:"Instagram Followers 400",price:"Rp 20k",stock:50,category:"sosmed",icon:"üì±"},
    {id:78,name:"Instagram Followers 500",price:"Rp 25k",stock:50,category:"sosmed",icon:"üì±"},
    {id:79,name:"Instagram Followers 600",price:"Rp 30k",stock:50,category:"sosmed",icon:"üì±"},
    {id:80,name:"Instagram Followers 700",price:"Rp 35k",stock:50,category:"sosmed",icon:"üì±"},
    {id:81,name:"Instagram Followers 800",price:"Rp 40k",stock:50,category:"sosmed",icon:"üì±"},
    {id:82,name:"Instagram Followers 900",price:"Rp 45k",stock:50,category:"sosmed",icon:"üì±"},
    {id:83,name:"Instagram Followers 1.000",price:"Rp 50k",stock:50,category:"sosmed",icon:"üì±"},
    {id:84,name:"TikTok Followers 100",price:"Rp 5k",stock:50,category:"sosmed",icon:"üì±"},
    {id:85,name:"TikTok Followers 200",price:"Rp 10k",stock:50,category:"sosmed",icon:"üì±"},
    {id:86,name:"TikTok Followers 300",price:"Rp 15k",stock:50,category:"sosmed",icon:"üì±"},
    {id:87,name:"TikTok Followers 400",price:"Rp 20k",stock:50,category:"sosmed",icon:"üì±"},
    {id:88,name:"TikTok Followers 500",price:"Rp 25k",stock:50,category:"sosmed",icon:"üì±"},
    {id:89,name:"TikTok Followers 600",price:"Rp 30k",stock:50,category:"sosmed",icon:"üì±"},
    {id:90,name:"TikTok Followers 700",price:"Rp 35k",stock:50,category:"sosmed",icon:"üì±"},
    {id:91,name:"TikTok Followers 800",price:"Rp 40k",stock:50,category:"sosmed",icon:"üì±"},
    {id:92,name:"TikTok Followers 900",price:"Rp 45k",stock:50,category:"sosmed",icon:"üì±"},
    {id:93,name:"TikTok Followers 1.000",price:"Rp 50k",stock:50,category:"sosmed",icon:"üì±"},
    {id:94,name:"Instagram Viewers 1.000",price:"Rp 3k",stock:50,category:"sosmed",icon:"üì±"},
    {id:95,name:"Instagram Viewers 2.000",price:"Rp 6k",stock:50,category:"sosmed",icon:"üì±"},
    {id:96,name:"Instagram Viewers 3.000",price:"Rp 9k",stock:50,category:"sosmed",icon:"üì±"},
    {id:97,name:"Instagram Viewers 4.000",price:"Rp 12k",stock:50,category:"sosmed",icon:"üì±"},
    {id:98,name:"Instagram Viewers 5.000",price:"Rp 15k",stock:50,category:"sosmed",icon:"üì±"},
    {id:99,name:"Instagram Viewers 6.000",price:"Rp 18k",stock:50,category:"sosmed",icon:"üì±"},
    {id:100,name:"Instagram Viewers 7.000",price:"Rp 21k",stock:50,category:"sosmed",icon:"üì±"},
    {id:101,name:"Instagram Viewers 8.000",price:"Rp 24k",stock:50,category:"sosmed",icon:"üì±"},
    {id:102,name:"Instagram Viewers 9.000",price:"Rp 27k",stock:50,category:"sosmed",icon:"üì±"},
    {id:103,name:"Instagram Viewers 10.000",price:"Rp 30k",stock:50,category:"sosmed",icon:"üì±"},
    {id:104,name:"TikTok Viewers 1.000",price:"Rp 3k",stock:50,category:"sosmed",icon:"üì±"},
    {id:105,name:"TikTok Viewers 2.000",price:"Rp 6k",stock:50,category:"sosmed",icon:"üì±"},
    {id:106,name:"TikTok Viewers 3.000",price:"Rp 9k",stock:50,category:"sosmed",icon:"üì±"},
    {id:107,name:"TikTok Viewers 4.000",price:"Rp 12k",stock:50,category:"sosmed",icon:"üì±"},
    {id:108,name:"TikTok Viewers 5.000",price:"Rp 15k",stock:50,category:"sosmed",icon:"üì±"},
    {id:109,name:"TikTok Viewers 6.000",price:"Rp 18k",stock:50,category:"sosmed",icon:"üì±"},
    {id:110,name:"TikTok Viewers 7.000",price:"Rp 21k",stock:50,category:"sosmed",icon:"üì±"},
    {id:111,name:"TikTok Viewers 8.000",price:"Rp 24k",stock:50,category:"sosmed",icon:"üì±"},
    {id:112,name:"TikTok Viewers 9.000",price:"Rp 27k",stock:50,category:"sosmed",icon:"üì±"},
    {id:113,name:"TikTok Viewers 10.000",price:"Rp 30k",stock:50,category:"sosmed",icon:"üì±"}
  ];

  let products = [];
  let myOrders = [];
  let currentOrderId = null;

  async function loadProductsFromDB() {
    const colRef = collection(db, 'products');
    const snap   = await getDocs(colRef);
    if (snap.empty) {
      for (const p of defaultProducts) {
        await setDoc(doc(colRef, String(p.id)), p);
      }
      return JSON.parse(JSON.stringify(defaultProducts));
    } else {
      const arr = [];
      snap.forEach(d => arr.push(d.data()));
      arr.sort((a,b) => a.id - b.id);
      return arr;
    }
  }
  async function updateProductField(id, field, value) {
    const colRef = collection(db, 'products');
    await updateDoc(doc(colRef, String(id)), { [field]: value });
  }
  async function loadOrdersForUser(uid) {
    const colRef = collection(db, 'orders');
    const qRef   = query(colRef, where('userUid','==',uid), orderBy('time','asc'));
    const snap   = await getDocs(qRef);
    const arr    = [];
    snap.forEach(d => arr.push({ docId:d.id, ...d.data() }));
    return arr;
  }

  function createProductCard(p) {
    const card = document.createElement('div');
    card.className = 'product-card';
    card.setAttribute('data-id', p.id);

    const header = document.createElement('div');
    header.className = 'product-header';

    const icon = document.createElement('div');
    icon.className = 'product-icon';
    icon.innerHTML = p.icon || '‚≠ê';

    const title = document.createElement('div');
    title.className = 'product-title';
    title.textContent = p.name;

    header.appendChild(icon);
    header.appendChild(title);

    const price = document.createElement('div');
    price.className = 'price-tag';
    price.textContent = p.price;

    const stock = document.createElement('div');
    stock.className = 'stock-line';
    stock.textContent = 'Stok: ' + p.stock;

    const btn = document.createElement('a');
    btn.className = 'btn-product';
    btn.href = '#';

    if (p.stock <= 0) {
      btn.style.opacity = '0.6';
      btn.style.pointerEvents = 'none';
      btn.textContent = 'Stok habis';
    } else {
      btn.onclick = function(e) {
        e.preventDefault();
        openOrderModal(p.id);
      };
      const spanIcon = document.createElement('span');
      spanIcon.className = 'icon';
      spanIcon.textContent = 'üõí';
      const spanText = document.createElement('span');
      spanText.textContent = 'Order Sekarang';
      btn.appendChild(spanIcon);
      btn.appendChild(spanText);
    }

    card.appendChild(header);
    card.appendChild(price);
    card.appendChild(stock);
    card.appendChild(btn);

    return card;
  }

  function renderProducts() {
    const grid = document.getElementById('productGrid');
    if (!grid) return;
    grid.innerHTML = '';
    const searchValEl = document.getElementById('searchInput');
    const val = searchValEl ? searchValEl.value.toLowerCase() : '';
    for (const p of products) {
      const nameStr = (p.name + ' ' + p.category).toLowerCase();
      if (!val || nameStr.indexOf(val) !== -1) {
        grid.appendChild(createProductCard(p));
      }
    }
  }

  function renderMyOrders() {
    const card = document.getElementById('myOrdersCard');
    const table = document.getElementById('myOrderTable');
    if (!card || !table) return;
    const tbody = table.getElementsByTagName('tbody')[0];
    tbody.innerHTML = '';

    if (!myOrders.length) {
      card.style.display = 'none';
      return;
    }
    card.style.display = 'block';

    myOrders.forEach((o, i) => {
      const tr = document.createElement('tr');

      const tdIdx = document.createElement('td');
      tdIdx.textContent = i + 1;

      const tdTime = document.createElement('td');
      const d = new Date(o.time);
      tdTime.textContent = d.toLocaleString('id-ID');

      const tdProd = document.createElement('td');
      tdProd.textContent = o.productName;

      const tdStatus = document.createElement('td');
      const spanStatus = document.createElement('span');
      const st = (o.status || 'pending').toLowerCase();
      spanStatus.className = 'status-text status-' + st;
      spanStatus.textContent = st;
      tdStatus.appendChild(spanStatus);

      const tdDelivery = document.createElement('td');
      tdDelivery.textContent = o.delivery ? o.delivery : '-';

      const tdBukti = document.createElement('td');
      if (o.buktiUrl) {
        const a = document.createElement('a');
        a.href = o.buktiUrl;
        a.target = '_blank';
        a.rel = 'noopener noreferrer';
        a.textContent = 'Lihat';
        tdBukti.appendChild(a);
      } else {
        tdBukti.textContent = '-';
      }

      tr.appendChild(tdIdx);
      tr.appendChild(tdTime);
      tr.appendChild(tdProd);
      tr.appendChild(tdStatus);
      tr.appendChild(tdDelivery);
      tr.appendChild(tdBukti);

      tbody.appendChild(tr);
    });
  }

  // ========= AUTH =========
  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      window.location.href = 'login.html';
      return;
    }
    document.getElementById('dashboard').style.display = 'block';

    products = await loadProductsFromDB();
    renderProducts();

    myOrders = await loadOrdersForUser(user.uid);
    renderMyOrders();
  });

  document.getElementById('logoutBtn').onclick = async () => {
    await signOut(auth);
    window.location.href = 'login.html';
  };

  // ========= ORDER FLOW =========
  window.openOrderModal = function(id) {
    currentOrderId = id;
    document.getElementById('orderDana').value = '';
    document.getElementById('orderNama').value = '';
    document.getElementById('orderMsg').innerHTML = '';

    document.getElementById('sosmedUsernameFollowers').value = '';
    document.getElementById('sosmedLink').value = '';
    document.getElementById('sosmedUsernameLikes').value = '';
    document.getElementById('panelUser').value = '';
    document.getElementById('panelPass').value = '';
    const buktiInput = document.getElementById('orderBukti');
    if (buktiInput) buktiInput.value = '';

    document.getElementById('sosmedFollowersFields').style.display = 'none';
    document.getElementById('sosmedLikesFields').style.display = 'none';
    document.getElementById('panelFields').style.display = 'none';

    const p = products.find(prod => prod.id === id);
    if (p) {
      const lowerName = p.name.toLowerCase();
      if (p.category === 'sosmed') {
        if (lowerName.includes('followers')) {
          document.getElementById('sosmedFollowersFields').style.display = 'block';
        } else if (lowerName.includes('likes') || lowerName.includes('viewers')) {
          document.getElementById('sosmedLikesFields').style.display = 'block';
        }
      } else if (p.category === 'panel') {
        document.getElementById('panelFields').style.display = 'block';
      }
    }

    document.getElementById('orderStepButtons').style.display = 'block';
    document.getElementById('orderStepForm').style.display = 'none';
    document.getElementById('orderModal').style.display = 'flex';
  };

  window.closeOrderModal = function() {
    document.getElementById('orderModal').style.display = 'none';
  };
  window.orderBelumBayar = function() {
    window.closeOrderModal();
  };
  window.orderSudahBayar = function() {
    document.getElementById('orderStepButtons').style.display = 'none';
    document.getElementById('orderStepForm').style.display = 'block';
  };

  window.orderSekarang = async function() {
    const dana = document.getElementById('orderDana').value.trim();
    const nama = document.getElementById('orderNama').value.trim();
    const msg  = document.getElementById('orderMsg');
    msg.className = 'modal-msg';
    msg.innerHTML = '';

    if (!dana || !nama) {
      msg.className += ' error';
      msg.innerHTML = 'Nomor DANA dan atas nama wajib diisi.';
      return;
    }

    let p = null;
    for (const prod of products) {
      if (prod.id === currentOrderId) { p = prod; break; }
    }
    if (!p) {
      window.closeOrderModal();
      return;
    }

    let extraInfoText = '';

    if (p.category === 'sosmed') {
      const lowerName = p.name.toLowerCase();
      if (lowerName.includes('followers')) {
        const userFollowers = document.getElementById('sosmedUsernameFollowers').value.trim();
        if (!userFollowers) {
          msg.className += ' error';
          msg.innerHTML = 'Username akun wajib diisi untuk order followers.';
          return;
        }
        extraInfoText =
          'Data Sosial Media (Followers):\n' +
          'Username akun       : ' + userFollowers + '\n' +
          'Catatan             : Akun tidak boleh private selama proses.\n';
      } else if (lowerName.includes('likes') || lowerName.includes('viewers')) {
        const linkVideo = document.getElementById('sosmedLink').value.trim();
        const userLikes = document.getElementById('sosmedUsernameLikes').value.trim();
        if (!linkVideo) {
          msg.className += ' error';
          msg.innerHTML = 'Link video wajib diisi untuk order likes/viewers.';
          return;
        }
        extraInfoText =
          'Data Sosial Media (Likes / Viewers):\n' +
          'Link video          : ' + linkVideo + '\n' +
          'Username (opsional) : ' + (userLikes || '-') + '\n' +
          'Catatan             : Video harus publik, akun jangan private.\n';
      }
    } else if (p.category === 'panel') {
      const panelUser = document.getElementById('panelUser').value.trim();
      const panelPass = document.getElementById('panelPass').value.trim();
      if (!panelUser || !panelPass) {
        msg.className += ' error';
        msg.innerHTML = 'Username dan password panel wajib diisi.';
        return;
      }
      extraInfoText =
        'Data Login Panel:\n' +
        'Username panel : ' + panelUser + '\n' +
        'Password panel : ' + panelPass + '\n';
    }

    const buktiInput = document.getElementById('orderBukti');
    let buktiUrl = '';
    if (buktiInput && buktiInput.files && buktiInput.files[0]) {
      try {
        const file = buktiInput.files[0];
        const orderId = 'ORD-' + p.id + '-' + Date.now();
        const refPath = 'bukti-transfer/' + orderId + '-' + file.name;
        const fileRef = storageRef(storage, refPath);
        await uploadBytes(fileRef, file);
        buktiUrl = await getDownloadURL(fileRef);
      } catch (e) {
        console.error('Gagal upload bukti transfer:', e);
        msg.className += ' error';
        msg.innerHTML = 'Gagal mengupload bukti transfer. Coba lagi atau kirim ke admin via chat.';
        return;
      }
    } else {
      msg.className += ' error';
      msg.innerHTML = 'Bukti transfer (screenshot) wajib diupload.';
      return;
    }

    const user = auth.currentUser;
    if (!user) {
      msg.className += ' error';
      msg.innerHTML = 'Sesi login habis. Silakan login ulang.';
      return;
    }

    if (p.stock > 0) p.stock = p.stock - 1;
    await updateProductField(p.id, 'stock', p.stock);
    renderProducts();

    const nowISO = new Date().toISOString();
    const orderObj = {
      time: nowISO,
      productId: p.id,
      productName: p.name,
      price: p.price,
      danaNumber: dana,
      danaName: nama,
      stockAfter: p.stock,
      extraInfo: extraInfoText,
      buktiUrl: buktiUrl,
      userUid: user.uid,
      userEmail: user.email || null,
      status: 'pending',
      delivery: ''
    };

    const docRef = await addDoc(collection(db, 'orders'), orderObj);
    const fullOrder = { docId: docRef.id, ...orderObj };
    myOrders.push(fullOrder);
    renderMyOrders();

    msg.className = 'modal-msg ok';
    msg.innerHTML =
      '‚úÖ Order & bukti transfer berhasil disimpan.<br>' +
      'Status awal: <b>pending</b>. Admin akan mengubah menjadi <b>proses/sukses</b> setelah dicek.';

    setTimeout(() => {
      window.closeOrderModal();
    }, 2500);
  };

  document.getElementById('orderModal').addEventListener('click', function(e){
    if (e.target === this) { window.closeOrderModal(); }
  });

  // search
  const searchInputEl = document.getElementById('searchInput');
  if (searchInputEl) {
    searchInputEl.oninput = function() { renderProducts(); };
  }

  // theme
  function applyTheme(t) {
    const btn = document.getElementById('themeBtn');
    if (t === 'light') {
      if (document.body.className.indexOf('light') === -1) {
        document.body.className += (document.body.className ? ' ' : '') + 'light';
      }
      btn.innerHTML = '‚òÄÔ∏è Terang';
    } else {
      document.body.className = document.body.className.replace('light','').trim();
      btn.innerHTML = 'üåô Gelap';
    }
  }
  let savedTheme;
  try { savedTheme = localStorage.getItem('ds-theme-hp'); } catch(e) {}
  if (!savedTheme) savedTheme = 'dark';
  applyTheme(savedTheme);
  window.toggleTheme = function() {
    const isLight = document.body.className.indexOf('light') !== -1;
    const now = isLight ? 'dark' : 'light';
    applyTheme(now);
    try { localStorage.setItem('ds-theme-hp', now); } catch(e) {}
  };
</script>

</body>
</html>
