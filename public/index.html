<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Barmods Store - Produk</title>
  <style>
    body{
      font-family: sans-serif;
      margin:0;
      background:#0d1117;
      color:white;
      padding-bottom:80px;
    }
    h1{text-align:center;margin:20px 0;font-size:22px;}

    .card{
      background:#161b22;
      margin:12px;
      padding:15px;
      border-radius:14px;
      box-shadow:0 0 12px rgba(0,0,0,0.4);
    }

    .card:hover{background:#1b212c;}

    .prod-title{font-size:16px;font-weight:bold;}
    .prod-cat{font-size:12px;color:#9ca3af;}
    .prod-price{margin-top:8px;font-size:15px;font-weight:bold;color:#58a6ff;}

    button{
      margin-top:10px;
      width:100%;
      padding:12px;
      border:none;
      border-radius:8px;
      background:#007bff;
      color:white;
      font-weight:bold;
      font-size:14px;
    }

    .nav{
      position:fixed;bottom:0;left:0;right:0;
      background:#161b22;
      display:flex;
      justify-content:space-around;
      padding:10px 0;
      box-shadow:0 -4px 12px rgba(0,0,0,0.4);
    }
    .nav a{color:#58a6ff;text-decoration:none;font-size:14px;}

    .input-box{
      width:100%;
      padding:10px;
      margin-top:10px;
      background:#0f141a;
      border:1px solid #30363d;
      border-radius:8px;
      color:white;
    }
  </style>
</head>

<body>

<h1>Produk</h1>
<div id="list"></div>

<div class="nav">
  <a href="index.html">Produk</a>
  <a href="wallet.html">Wallet</a>
  <a href="orders.html">Orders</a>
  <a href="profile.html">Profile</a>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

<script>
// =========================
// FIREBASE INIT
// =========================
const firebaseConfig={
  apiKey:"AIzaSyBpsfDmupS9wq-iNge5aYvknmw5bSryd3A",
  authDomain:"toko-barmods.firebaseapp.com",
  projectId:"toko-barmods"
};
firebase.initializeApp(firebaseConfig);
const auth=firebase.auth();
const db=firebase.firestore();

// =========================
// FUNGSI BERSIHKAN ANGKA
// Bisa handle: "2000", "Rp 2k", "2k", 2000, "10.000", dll
// =========================
function parseAmount(raw){
  const cleaned = String(raw ?? "0").replace(/[^0-9]/g,"");
  return Number(cleaned) || 0;
}

// Format ke Rupiah
function rupiah(num){
  return "Rp" + Number(num).toLocaleString("id-ID");
}

// =========================
// CEK LOGIN
// =========================
auth.onAuthStateChanged(u=>{
  if(!u){
    window.location.href="login.html";
    return;
  }
  loadProducts();
});

// =========================
// LOAD LIST PRODUK
// =========================
function loadProducts(){
  const listEl = document.getElementById("list");
  listEl.innerHTML = "<div class='card'>Memuat produk...</div>";

  db.collection("products").get()
  .then(snap=>{
    if(snap.empty){
      listEl.innerHTML = "<div class='card'>Belum ada produk.</div>";
      return;
    }
    listEl.innerHTML = "";
    snap.forEach(doc=>{
      const p = doc.data();
      const hargaNumber = parseAmount(p.price);
      const showPrice   = (typeof p.price==="string" && p.price.trim()!=="")
        ? p.price
        : rupiah(hargaNumber);

      listEl.innerHTML += `
        <div class="card">
          <div class="prod-title">${p.icon || ""} ${p.name || "(tanpa nama)"}</div>
          <div class="prod-cat">${p.category || ""}</div>
          <div class="prod-price">${showPrice}</div>
          <button onclick="orderForm('${doc.id}')">Beli</button>
        </div>
      `;
    });
  })
  .catch(err=>{
    alert("Gagal load produk: "+err.message);
  });
}

// =========================
// FORM INPUT ORDER
// =========================
function orderForm(id){
  const listEl = document.getElementById("list");

  db.collection("products").doc(id).get()
  .then(d=>{
    if(!d.exists) throw new Error("Produk tidak ditemukan");

    const p = d.data();
    const hargaNumber = parseAmount(p.price);

    if(hargaNumber <= 0){
      alert("Harga produk ini belum di-set dengan benar. Hubungi admin.");
      return;
    }

    let extraInput = "";

    if(p.category==="sosmed"){
      extraInput = `
        <input id="inputData" class="input-box"
               placeholder="Masukkan link / username / video (IG/TikTok dll)">
      `;
    }else if(p.category==="panel"){
      extraInput = `
        <input id="inputData" class="input-box"
               placeholder="username:password panel">
      `;
    }else if(p.category==="premium"){
      extraInput = `
        <input id="inputData" class="input-box"
               placeholder="Catatan (opsional)">
      `;
    }else{
      extraInput = `
        <input id="inputData" class="input-box"
               placeholder="Keterangan order (opsional)">
      `;
    }

    listEl.innerHTML = `
      <div class="card">
        <div class="prod-title">${p.icon || ""} ${p.name || "(tanpa nama)"}</div>
        <div class="prod-cat">${p.category || ""}</div>
        <div class="prod-price">Harga: ${rupiah(hargaNumber)}</div>
        ${extraInput}
        <button onclick="makeOrder('${id}')">Konfirmasi Order</button>
        <button style="background:#4b5563;margin-top:6px" onclick="loadProducts()">Batal</button>
      </div>
    `;
  })
  .catch(err=>{
    alert("Gagal membuka form order: "+err.message);
  });
}

// =========================
// PROSES ORDER
// - Cek saldo (pakai parseAmount)
// - Tolak kalau saldo < harga
// - Kurangi saldo di Firestore
// - Simpan order ke Firestore
// =========================
function makeOrder(id){
  const user = auth.currentUser;
  if(!user){
    alert("Silakan login ulang.");
    window.location.href="login.html";
    return;
  }

  const uid   = user.uid;
  const input = (document.getElementById("inputData")?.value || "").trim();

  // 1. Ambil produk
  db.collection("products").doc(id).get()
  .then(doc=>{
    if(!doc.exists) throw new Error("Produk tidak ditemukan");
    const p = doc.data();

    const hargaNumber = parseAmount(p.price);
    if(hargaNumber <= 0){
      throw new Error("Harga produk tidak valid. Hubungi admin.");
    }

    // 2. Ambil saldo user
    return db.collection("users").doc(uid).get()
      .then(uDoc=>{
        if(!uDoc.exists) throw new Error("Data user tidak ditemukan.");

        const u = uDoc.data();
        const saldoNumber = parseAmount(u.balance);   // <- PENTING, pakai parseAmount

        if(saldoNumber < hargaNumber){
          alert(
            "Saldo tidak cukup.\n" +
            "Saldo kamu: " + rupiah(saldoNumber) + "\n" +
            "Harga produk: " + rupiah(hargaNumber) + "\n" +
            "Silakan topup di menu Wallet."
          );
          return null; // stop di sini
        }

        const saldoBaru = saldoNumber - hargaNumber;

        // 3. Update saldo & buat order (chain biasa)
        return db.collection("users").doc(uid).update({
          balance: saldoBaru
        })
        .then(()=>{
          return db.collection("orders").add({
            userId       : uid,
            productDocId : id,
            productName  : p.name || "",
            price        : hargaNumber,
            inputUser    : input,
            status       : "pending",
            adminProduct : "",
            createdAt    : Date.now()
          });
        })
        .then(()=>{
          alert("Order berhasil dibuat! Saldo baru: " + rupiah(saldoBaru));
          loadProducts();
        });
      });
  })
  .catch(err=>{
    alert("Gagal membuat order: "+err.message);
  });
}
</script>

</body>
</html>
