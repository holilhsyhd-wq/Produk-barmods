<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Barmods Digital Store</title>

<style>
  body {
    margin: 0;
    background: #0f0f17;
    font-family: Arial, sans-serif;
    color: #fff;
  }

  header {
    padding: 16px;
    background: #141421;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 17px;
  }

  .btn-header {
    color: #fff;
    background: #303043;
    padding: 6px 12px;
    border-radius: 8px;
    text-decoration: none;
    font-size: 14px;
  }

  .product-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    padding: 12px;
    gap: 12px;
  }

  .product-card {
    background: #181828;
    padding: 12px;
    border-radius: 10px;
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .price-tag {
    color: #4d9dff;
    font-size: 15px;
    font-weight: bold;
  }

  .btn-product {
    margin-top: 8px;
    padding: 8px;
    background: #5568ff;
    color: #fff;
    border: none;
    border-radius: 8px;
    font-size: 14px;
  }

  /* MODAL */
  .modal-backdrop {
    position: fixed;
    inset: 0;
    display: none;
    background: rgba(0,0,0,0.65);
    justify-content: center;
    align-items: center;
    padding: 20px;
  }

  .modal {
    background: #181828;
    padding: 16px;
    width: 100%;
    max-width: 380px;
    border-radius: 12px;
  }

  .modal-input {
    width: 100%;
    padding: 8px;
    background: #202033;
    border: 1px solid #333;
    border-radius: 8px;
    color: #fff;
  }

  .modal-actions {
    display: flex;
    justify-content: space-between;
    margin-top: 14px;
  }

  .btn-cancel {
    padding: 8px 15px;
    background: #444;
    border-radius: 8px;
    border: none;
    color: white;
  }

  .btn-ok {
    padding: 8px 15px;
    background: #5568ff;
    border-radius: 8px;
    border: none;
    color: white;
  }

  .modal-msg {
    font-size: 13px;
    margin-top: 10px;
    color: #ff4d4d;
    text-align: center;
  }

  .modal-msg.ok {
    color: #57ff8f;
  }
</style>
</head>

<body>

<header>
  <div><b>Barmods Digital Store</b></div>
  <div>
    <a href="profile.html" class="btn-header">Profil Saya</a>
    <a href="admin.html" class="btn-header">Admin</a>
  </div>
</header>

<h3 style="padding: 12px;">Daftar Produk</h3>

<div id="productGrid" class="product-grid"></div>

<!-- ========================== -->
<!--   MODAL ORDER / DANA       -->
<!-- ========================== -->
<div id="orderModal" class="modal-backdrop">
  <div class="modal">
    <h3>Pembayaran via DANA</h3>
    <p>Transfer ke DANA:<br><b>083877842721</b></p>

    <label>Nomor DANA kamu</label>
    <input id="orderDana" class="modal-input" placeholder="Contoh: 081234xxxxxx">

    <label style="margin-top:6px;">Atas nama DANA</label>
    <input id="orderNama" class="modal-input" placeholder="Nama di aplikasi DANA">

    <p style="font-size:11px;margin-top:10px;">
      Untuk order sosmed, isi username/link.<br>
      Untuk panel, isi user & password panel.
    </p>

    <input id="orderSosmedUser" class="modal-input" placeholder="Username sosmed (opsional)">
    <input id="orderSosmedLink" class="modal-input" placeholder="Link video/profil (opsional)">
    <input id="orderPanelUser" class="modal-input" placeholder="User panel (opsional)">
    <input id="orderPanelPass" class="modal-input" placeholder="Password panel (opsional)">

    <label style="margin-top:8px;">Upload bukti transfer</label>
    <input id="orderProof" type="file" accept="image/*" style="margin-top:4px;color:#fff;">

    <div class="modal-actions">
      <button id="orderCancelBtn" class="btn-cancel">Batal</button>
      <button id="orderSubmitBtn" class="btn-ok">Order Sekarang</button>
    </div>

    <div id="orderMsg" class="modal-msg"></div>
  </div>
</div>

<!-- ================================= -->
<!--  FIREBASE + ORDER SCRIPT FIX      -->
<!-- ================================= -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import {
    getFirestore, collection, getDocs, addDoc,
    doc, updateDoc
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  import {
    getAuth, onAuthStateChanged
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import {
    getStorage, ref, uploadBytes, getDownloadURL
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBpsfDmupS9wq-iNge5aYvknmw5bSryd3A",
    authDomain: "toko-barmods.firebaseapp.com",
    projectId: "toko-barmods",
    storageBucket: "toko-barmods.firebasestorage.app",
    messagingSenderId: "284047189012",
    appId: "1:284047189012:web:6ef0c6891adab08a383301"
  };

  const app = initializeApp(firebaseConfig);
  const db  = getFirestore(app);
  const auth = getAuth(app);
  const storage = getStorage(app);

  let currentUser = null;
  let products = [];
  let currentProduct = null;

  const grid = document.getElementById("productGrid");
  const orderModal = document.getElementById("orderModal");
  const msg = document.getElementById("orderMsg");

  const danaEl  = document.getElementById("orderDana");
  const namaEl  = document.getElementById("orderNama");
  const sUserEl = document.getElementById("orderSosmedUser");
  const sLinkEl = document.getElementById("orderSosmedLink");
  const pUserEl = document.getElementById("orderPanelUser");
  const pPassEl = document.getElementById("orderPanelPass");
  const proofEl = document.getElementById("orderProof");

  onAuthStateChanged(auth, async (user)=>{
    if (!user) {
      window.location.href = "login.html";
      return;
    }
    currentUser = user;
    loadProducts();
  });

  async function loadProducts(){
    const snap = await getDocs(collection(db,"products"));
    products = [];
    snap.forEach(d=> products.push(d.data()));
    products.sort((a,b)=> (a.id||0)-(b.id||0));

    grid.innerHTML = "";
    products.forEach(p=>{
      const card = document.createElement("div");
      card.className = "product-card";

      card.innerHTML = `
        <div><b>${p.name}</b></div>
        <div class="price-tag">${p.price}</div>
        <div>Stok: ${p.stock}</div>
      `;

      const btn = document.createElement("button");
      btn.className = "btn-product";
      btn.textContent = p.stock > 0 ? "Order Sekarang" : "Stok habis";
      btn.disabled = p.stock <= 0;

      btn.addEventListener("click", ()=> openModal(p.id));
      card.appendChild(btn);
      grid.appendChild(card);
    });
  }

  function openModal(productId){
    currentProduct = products.find(p=> p.id === productId);
    if (!currentProduct) return;

    danaEl.value = "";
    namaEl.value = "";
    sUserEl.value = "";
    sLinkEl.value = "";
    pUserEl.value = "";
    pPassEl.value = "";
    proofEl.value = "";
    msg.textContent = "";

    orderModal.style.display = "flex";
  }

  document.getElementById("orderCancelBtn").onclick = ()=>{
    orderModal.style.display = "none";
  };
  orderModal.onclick = e=>{
    if (e.target === orderModal) orderModal.style.display = "none";
  };

  document.getElementById("orderSubmitBtn").onclick = async ()=>{
    if (!currentProduct) return;

    msg.textContent = "";

    const dana = danaEl.value.trim();
    const nama = namaEl.value.trim();
    const file = proofEl.files[0];

    if (!dana || !nama){
      msg.textContent = "Nomor DANA & Atas nama wajib diisi.";
      return;
    }
    if (!file){
      msg.textContent = "Bukti transfer wajib diupload.";
      return;
    }

    try {
      const fileName = `${currentUser.uid}_${Date.now()}_${file.name}`;
      const storageRef = ref(storage, "proofs/"+fileName);
      await uploadBytes(storageRef,file);
      const proofUrl = await getDownloadURL(storageRef);

      await updateDoc(doc(db,"products",String(currentProduct.id)), {
        stock: currentProduct.stock - 1
      });

      await addDoc(collection(db,"orders"), {
        userUid: currentUser.uid,
        userEmail: currentUser.email,
        productId: currentProduct.id,
        productName: currentProduct.name,
        price: currentProduct.price,
        category: currentProduct.category || "",
        danaNumber: dana,
        danaName: nama,
        sosmedUsername: sUserEl.value.trim() || null,
        sosmedLink: sLinkEl.value.trim() || null,
        panelUser: pUserEl.value.trim() || null,
        panelPass: pPassEl.value.trim() || null,
        proofUrl: proofUrl,
        status: "pending",
        createdAt: new Date().toISOString()
      });

      msg.className = "modal-msg ok";
      msg.textContent = "Order berhasil! Status: pending.";

      setTimeout(()=>{
        orderModal.style.display = "none";
        loadProducts();
      }, 800);

    } catch(err) {
      console.log(err);
      msg.textContent = "Terjadi kesalahan saat memproses order.";
    }
  };
</script>

</body>
</html>
