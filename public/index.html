<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Barmods Store - Produk</title>
  <style>
    body{
      font-family: sans-serif;
      margin:0;
      background:#0d1117;
      color:white;
      padding-bottom:80px;
    }
    h1{text-align:center;margin:20px 0;font-size:22px;}

    .card{
      background:#161b22;
      margin:12px;
      padding:15px;
      border-radius:14px;
      box-shadow:0 0 12px rgba(0,0,0,0.4);
    }

    .card:hover{background:#1b212c;}

    .prod-title{font-size:16px;font-weight:bold;}
    .prod-cat{font-size:12px;color:#9ca3af;}
    .prod-price{margin-top:8px;font-size:15px;font-weight:bold;color:#58a6ff;}

    button{
      margin-top:10px;
      width:100%;
      padding:12px;
      border:none;
      border-radius:8px;
      background:#007bff;
      color:white;
      font-weight:bold;
      font-size:14px;
    }

    .nav{
      position:fixed;bottom:0;left:0;right:0;
      background:#161b22;
      display:flex;
      justify-content:space-around;
      padding:10px 0;
      box-shadow:0 -4px 12px rgba(0,0,0,0.4);
    }
    .nav a{color:#58a6ff;text-decoration:none;font-size:14px;}

    .input-box{
      width:100%;
      padding:10px;
      margin-top:10px;
      background:#0f141a;
      border:1px solid #30363d;
      border-radius:8px;
      color:white;
    }
  </style>
</head>

<body>

<h1>Produk</h1>
<div id="list"></div>

<div class="nav">
  <a href="index.html">Produk</a>
  <a href="wallet.html">Wallet</a>
  <a href="orders.html">Orders</a>
  <a href="profile.html">Profile</a>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

<script>
// =========================
// FIREBASE INIT
// =========================
const firebaseConfig={
  apiKey:"AIzaSyBpsfDmupS9wq-iNge5aYvknmw5bSryd3A",
  authDomain:"toko-barmods.firebaseapp.com",
  projectId:"toko-barmods"
};
firebase.initializeApp(firebaseConfig);
const auth=firebase.auth();
const db=firebase.firestore();

// =========================
// PRICE PARSER
// Support "Rp 2k", "2k", "2000", 2000
// =========================
function parsePrice(raw){
  const cleaned = String(raw ?? "0").replace(/[^0-9]/g,"");
  return Number(cleaned) || 0;
}

// =========================
// RUPIAH FORMATTER
// =========================
function rupiah(num){
  return "Rp" + Number(num).toLocaleString("id-ID");
}

// =========================
// ON LOGIN
// =========================
auth.onAuthStateChanged(u=>{
  if(!u){
    window.location.href="login.html";
    return;
  }
  loadProducts();
});

// =========================
// LOAD PRODUCT LIST
// =========================
function loadProducts(){
  const listEl = document.getElementById("list");
  listEl.innerHTML = "<div class='card'>Memuat produk...</div>";

  db.collection("products").get()
  .then(snap=>{
    if(snap.empty){
      listEl.innerHTML = "<div class='card'>Belum ada produk.</div>";
      return;
    }
    listEl.innerHTML = "";
    snap.forEach(doc=>{
      const p=doc.data();
      const harga = parsePrice(p.price);
      const show  = (typeof p.price==="string" && p.price.trim()!=="")
        ? p.price
        : rupiah(harga);

      listEl.innerHTML+=`
        <div class="card">
          <div class="prod-title">${p.icon || ""} ${p.name}</div>
          <div class="prod-cat">${p.category || ""}</div>
          <div class="prod-price">${show}</div>
          <button onclick="orderForm('${doc.id}')">Beli</button>
        </div>
      `;
    });
  })
  .catch(err=>{
    alert("Gagal load produk: "+err.message);
  });
}

// =========================
// OPEN ORDER INPUT
// =========================
function orderForm(id){
  const listEl = document.getElementById("list");

  db.collection("products").doc(id).get()
  .then(d=>{
    if(!d.exists) throw new Error("Produk tidak ditemukan");

    const p=d.data();
    const harga=parsePrice(p.price);

    let extraInput="";

    if(p.category==="sosmed"){
      extraInput = `
        <input id="inputData" class="input-box" placeholder="Masukkan link / username / video">
      `;
    }else if(p.category==="panel"){
      extraInput = `
        <input id="inputData" class="input-box" placeholder="username:password panel">
      `;
    }else if(p.category==="premium"){
      extraInput = `
        <input id="inputData" class="input-box" placeholder="Catatan (opsional)">
      `;
    }else{
      extraInput = `
        <input id="inputData" class="input-box" placeholder="Keterangan order (opsional)">
      `;
    }

    listEl.innerHTML=`
      <div class="card">
        <div class="prod-title">${p.icon || ""} ${p.name}</div>
        <div class="prod-cat">${p.category || ""}</div>
        <div class="prod-price">Harga: ${rupiah(harga)}</div>
        ${extraInput}
        <button onclick="makeOrder('${id}')">Konfirmasi Order</button>
        <button style="background:#4b5563;margin-top:6px" onclick="loadProducts()">Batal</button>
      </div>
    `;
  })
  .catch(err=>{
    alert("Gagal membuka form order: "+err.message);
  });
}

// =========================
// MAKE ORDER (POTONG SALDO + SIMPAN ORDER)
// =========================
function makeOrder(id){
  const user = auth.currentUser;
  if(!user){
    alert("Silakan login ulang.");
    window.location.href="login.html";
    return;
  }

  const input = (document.getElementById("inputData")?.value || "").trim();
  const uid   = user.uid;

  // Ambil produk
  db.collection("products").doc(id).get()
  .then(doc=>{
    if(!doc.exists) throw new Error("Produk tidak ditemukan");
    const p = doc.data();
    const harga = parsePrice(p.price);

    if(harga<=0 || isNaN(harga)) throw new Error("Harga produk tidak valid.");

    // Ambil saldo user
    return db.collection("users").doc(uid).get()
      .then(uDoc=>{
        if(!uDoc.exists) throw new Error("Data user tidak ditemukan.");
        const u = uDoc.data();
        const saldo = Number(u.balance || 0);

        if(saldo < harga){
          alert("Saldo tidak cukup. Silakan topup di menu Wallet.");
          return null; // stop
        }

        const newSaldo = saldo - harga;

        // Update saldo + buat order (pakai batch atau chain)
        return db.collection("users").doc(uid).update({balance:newSaldo})
          .then(()=>{
            return db.collection("orders").add({
              userId       : uid,
              productDocId : id,
              productName  : p.name || "",
              price        : harga,
              inputUser    : input,
              status       : "pending",
              adminProduct : "",
              createdAt    : Date.now()
            });
          })
          .then(()=>{
            alert("Order berhasil dibuat!");
            loadProducts();
          });
      });
  })
  .catch(err=>{
    alert("Gagal membuat order: "+err.message);
  });
}
</script>

</body>
</html>
