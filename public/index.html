<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Barmods Digital Store</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body{
      margin:0;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:#020617;
      color:#e5e7eb;
    }
    .topbar{
      height:56px;
      background:#020617;
      border-bottom:1px solid #1f2937;
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:0 14px;
    }
    .brand{
      display:flex;
      flex-direction:column;
    }
    .brand-title{font-size:15px;font-weight:700;}
    .brand-sub{font-size:11px;color:#94a3b8;}
    .top-links{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    .link-btn{
      padding:6px 10px;
      border-radius:999px;
      border:1px solid #374151;
      background:#111827;
      color:#e5e7eb;
      font-size:12px;
      text-decoration:none;
      cursor:pointer;
    }
    .link-btn.logout{
      background:#b91c1c;
      border-color:#7f1d1d;
    }

    .main{
      max-width:1080px;
      margin:0 auto;
      padding:12px;
    }
    .card{
      background:#020617;
      border-radius:14px;
      border:1px solid #1f2937;
      padding:12px;
      margin-bottom:12px;
    }
    .card-header{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:6px;
    }
    .card-header h2{
      margin:0;
      font-size:15px;
    }
    .card-header small{
      font-size:11px;
      color:#94a3b8;
    }
    .info-text{
      font-size:12px;
      color:#9ca3af;
      margin-top:4px;
    }
    .saldo-text{
      font-size:14px;
      margin-top:4px;
    }

    .search-input{
      width:100%;
      margin-top:8px;
      padding:8px 11px;
      border-radius:999px;
      border:1px solid #1f2937;
      background:#020617;
      color:#e5e7eb;
      font-size:13px;
      box-sizing:border-box;
    }

    .product-grid{
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(170px,1fr));
      gap:10px;
      margin-top:12px;
    }
    .product-card{
      background:#0f172a;
      border-radius:12px;
      border:1px solid #1f2937;
      padding:9px;
      font-size:12px;
    }
    .pc-title{
      font-size:13px;
      font-weight:600;
    }
    .pc-price{
      color:#22c55e;
      font-weight:700;
      font-size:13px;
      margin-top:4px;
    }
    .pc-stock{
      font-size:11px;
      color:#9ca3af;
      margin-top:2px;
    }
    .btn-order{
      margin-top:8px;
      padding:6px 9px;
      border-radius:999px;
      border:none;
      background:#2563eb;
      color:#fff;
      font-size:12px;
      cursor:pointer;
    }
    .btn-order:disabled{
      background:#1f2937;
      color:#6b7280;
      cursor:not-allowed;
    }

    /* MODAL */
    .modal-bg{
      position:fixed;
      inset:0;
      background:rgba(15,23,42,.75);
      display:none;
      justify-content:center;
      align-items:center;
      padding:14px;
      z-index:40;
    }
    .modal{
      background:#020617;
      border-radius:16px;
      border:1px solid #1f2937;
      padding:14px;
      max-width:420px;
      width:100%;
      box-shadow:0 18px 40px rgba(0,0,0,.75);
    }
    .modal h3{
      margin:0 0 6px;
      font-size:15px;
    }
    .modal p{
      font-size:12px;
      color:#9ca3af;
      margin:0 0 8px;
    }
    .modal label{
      display:block;
      font-size:12px;
      margin-top:8px;
    }
    .modal input, .modal textarea{
      width:100%;
      padding:7px 9px;
      border-radius:9px;
      border:1px solid #1f2937;
      background:#020617;
      color:#e5e7eb;
      font-size:12px;
      margin-top:4px;
      box-sizing:border-box;
    }
    .modal textarea{
      resize:vertical;
    }
    .modal-footer{
      display:flex;
      justify-content:flex-end;
      gap:8px;
      margin-top:12px;
    }
    .btn-cancel{
      border-radius:999px;
      border:1px solid #374151;
      background:#111827;
      color:#e5e7eb;
      font-size:12px;
      padding:7px 11px;
      cursor:pointer;
    }
    .btn-ok{
      border-radius:999px;
      border:none;
      background:#2563eb;
      color:#fff;
      font-size:12px;
      padding:7px 11px;
      cursor:pointer;
    }
    .msg{
      font-size:12px;
      margin-top:6px;
      min-height:16px;
    }
    .msg.err{color:#f97373;}
    .msg.ok{color:#22c55e;}
  </style>
</head>
<body>

<!-- TOPBAR -->
<div class="topbar">
  <div class="brand">
    <span class="brand-title">Barmods Digital Store</span>
    <span class="brand-sub">Saldo • Produk Digital • Sosmed</span>
  </div>
  <div class="top-links">
    <a href="wallet.html" class="link-btn">Saldo</a>
    <a href="orders.html" class="link-btn">Pesanan Saya</a>
    <a href="profile.html" class="link-btn">Profil</a>
    <a href="admin.html" class="link-btn">Admin</a>
    <button id="logoutBtn" class="link-btn logout" type="button">Logout</button>
  </div>
</div>

<div class="main">
  <!-- SALDO -->
  <div class="card">
    <div class="card-header">
      <div>
        <h2>Saldo Saya</h2>
        <small>Gunakan saldo untuk order produk</small>
      </div>
    </div>
    <div class="saldo-text">
      Saldo: <b id="saldoText">Rp 0</b>
    </div>
    <div class="info-text">
      Akun: <span id="userEmail">-</span><br>
      Topup lewat menu <b>Saldo</b>, admin akan menambahkan saldo setelah cek pembayaran.
    </div>
  </div>

  <!-- PRODUK -->
  <div class="card">
    <div class="card-header">
      <div>
        <h2>Daftar Produk</h2>
        <small>Saldo akan otomatis terpotong saat order</small>
      </div>
    </div>
    <input id="searchInput" class="search-input" placeholder="Cari produk (misal: Netflix, TikTok, Panel, Followers)...">
    <div id="productGrid" class="product-grid"></div>
  </div>
</div>

<!-- MODAL ORDER -->
<div id="orderModal" class="modal-bg">
  <div class="modal">
    <h3 id="modalTitle">Order Produk</h3>
    <p id="modalInfo"></p>

    <div id="modalFields"></div>

    <div id="orderMsg" class="msg"></div>

    <div class="modal-footer">
      <button class="btn-cancel" type="button" onclick="closeOrderModal()">Batal</button>
      <button class="btn-ok" type="button" onclick="submitOrder()">Order Sekarang</button>
    </div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import {
    getFirestore,
    collection,
    getDocs,
    doc,
    getDoc,
    setDoc,
    updateDoc,
    addDoc
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  import {
    getAuth,
    onAuthStateChanged,
    signOut
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBpsfDmupS9wq-iNge5aYvknmw5bSryd3A",
    authDomain: "toko-barmods.firebaseapp.com",
    projectId: "toko-barmods",
    storageBucket: "toko-barmods.appspot.com",
    messagingSenderId: "284047189012",
    appId: "1:284047189012:web:6ef0c6891adab08a383301"
  };

  const app  = initializeApp(firebaseConfig);
  const db   = getFirestore(app);
  const auth = getAuth(app);

  const saldoTextEl = document.getElementById('saldoText');
  const userEmailEl = document.getElementById('userEmail');
  const productGrid = document.getElementById('productGrid');
  const searchInput = document.getElementById('searchInput');
  const orderModal  = document.getElementById('orderModal');
  const modalTitle  = document.getElementById('modalTitle');
  const modalInfo   = document.getElementById('modalInfo');
  const modalFields = document.getElementById('modalFields');
  const orderMsgEl  = document.getElementById('orderMsg');

  let currentUser = null;
  let userBalance = 0;
  let products    = [];
  let selectedProduct = null;

  // Format rupiah
  function formatRupiah(num){
    num = Math.floor(num || 0);
    return 'Rp ' + num.toString().replace(/\B(?=(\d{3})+(?!\d))/g,'.');
  }

  // Konversi "Rp 2k" / "2k" / "2000" → number
  function parsePriceToNumber(str){
    if(!str) return 0;
    let s = String(str).toLowerCase();
    s = s.replace('rp','').trim();
    s = s.replace(/\s/g,'');
    if(s.endsWith('k')){
      const n = parseFloat(s.slice(0,-1));
      return isNaN(n)?0:n*1000;
    }
    s = s.replace(/\./g,'').replace(/,/g,'');
    const n = parseInt(s,10);
    return isNaN(n)?0:n;
  }

  // Cek login
  onAuthStateChanged(auth, async (user)=>{
    if(!user){
      window.location.href = 'login.html';
      return;
    }
    currentUser = user;
    userEmailEl.textContent = user.email || '-';
    await loadUserBalance();
    await loadProducts();
  });

  document.getElementById('logoutBtn').onclick = async ()=>{
    try{ await signOut(auth); }catch(e){}
  };

  // Load saldo user
  async function loadUserBalance(){
    if(!currentUser) return;
    const ref = doc(db,'users',currentUser.uid);
    const snap = await getDoc(ref);
    if(!snap.exists()){
      await setDoc(ref,{
        email: currentUser.email || '',
        balance: 0,
        createdAt: new Date().toISOString()
      });
      userBalance = 0;
    } else {
      const d = snap.data();
      userBalance = d.balance || 0;
    }
    saldoTextEl.textContent = formatRupiah(userBalance);
  }

  // Load produk
  async function loadProducts(){
    const snap = await getDocs(collection(db,'products'));
    const arr = [];
    snap.forEach(d=> arr.push(d.data()));
    arr.sort((a,b)=>(a.id||0)-(b.id||0));
    products = arr;
    renderProducts();
  }

  function renderProducts(){
    const val = searchInput.value.toLowerCase();
    productGrid.innerHTML = '';
    products.forEach(p=>{
      const combined = (p.name + ' ' + (p.category||'')).toLowerCase();
      if(val && !combined.includes(val)) return;

      const card = document.createElement('div');
      card.className = 'product-card';

      const priceValue = parsePriceToNumber(p.price);

      card.innerHTML = `
        <div class="pc-title">${p.name}</div>
        <div class="pc-price">${p.price}</div>
        <div class="pc-stock">Stok: ${p.stock ?? 0}</div>
      `;

      const btn = document.createElement('button');
      btn.className = 'btn-order';
      btn.textContent = 'Order';
      if((p.stock ?? 0) <= 0){
        btn.disabled = true;
        btn.textContent = 'Stok habis';
      }
      btn.onclick = ()=> openOrderModal(p);

      card.appendChild(btn);
      productGrid.appendChild(card);
    });
  }

  searchInput.oninput = renderProducts;

  // Buka modal
  function openOrderModal(p){
    selectedProduct = p;
    modalTitle.textContent = 'Order: ' + (p.name || '');
    modalInfo.textContent  =
      'Harga: ' + (p.price || '-') +
      ' • Saldo kamu: ' + formatRupiah(userBalance) +
      ' • Kategori: ' + (p.category || '-');

    modalFields.innerHTML = '';
    orderMsgEl.textContent = '';
    orderMsgEl.className = 'msg';

    // Field umum DANA (untuk data pembayaran / identitas)
    const danaHtml = `
      <label>Nomor DANA kamu</label>
      <input id="orderDanaNumber" placeholder="Contoh: 0838xxxxxxx">
      <label>Atas nama DANA</label>
      <input id="orderDanaName" placeholder="Nama sesuai akun DANA">
    `;
    modalFields.insertAdjacentHTML('beforeend', danaHtml);

    // Kalau kategori sosmed → username & link
    if(p.category === 'sosmed'){
      const sosHtml = `
        <label>Username akun (tidak boleh private)</label>
        <input id="orderSosUser" placeholder="contoh: @username">
        <label>Link postingan / profil (jika likes / views)</label>
        <input id="orderSosLink" placeholder="https://...">
      `;
      modalFields.insertAdjacentHTML('beforeend', sosHtml);
    }

    // Kalau kategori panel → user & pass wajib
    if(p.category === 'panel'){
      const panelHtml = `
        <label>User panel</label>
        <input id="orderPanelUser" placeholder="User panel">
        <label>Password panel</label>
        <input id="orderPanelPass" placeholder="Password panel">
      `;
      modalFields.insertAdjacentHTML('beforeend', panelHtml);
    }

    orderModal.style.display = 'flex';
  }

  window.closeOrderModal = function(){
    orderModal.style.display = 'none';
  };

  // Submit order
  window.submitOrder = async function(){
    if(!currentUser || !selectedProduct) return;

    const msg = orderMsgEl;
    msg.textContent = '';
    msg.className = 'msg';

    const danaNumber = (document.getElementById('orderDanaNumber')?.value || '').trim();
    const danaName   = (document.getElementById('orderDanaName')?.value   || '').trim();
    const sosUser    = (document.getElementById('orderSosUser')?.value    || '').trim();
    const sosLink    = (document.getElementById('orderSosLink')?.value    || '').trim();
    const panelUser  = (document.getElementById('orderPanelUser')?.value  || '').trim();
    const panelPass  = (document.getElementById('orderPanelPass')?.value  || '').trim();

    if(!danaNumber || !danaName){
      msg.textContent = 'Nomor DANA dan Atas nama wajib diisi.';
      msg.className = 'msg err';
      return;
    }

    if(selectedProduct.category === 'sosmed' && !sosUser){
      msg.textContent = 'Username sosmed wajib diisi untuk pesanan sosmed.';
      msg.className = 'msg err';
      return;
    }

    if(selectedProduct.category === 'panel' && (!panelUser || !panelPass)){
      msg.textContent = 'User & Password panel wajib diisi untuk pesanan panel.';
      msg.className = 'msg err';
      return;
    }

    const priceValue = parsePriceToNumber(selectedProduct.price);
    if(userBalance < priceValue){
      msg.textContent = 'Saldo tidak cukup. Silakan topup saldo di menu Saldo.';
      msg.className = 'msg err';
      return;
    }

    try{
      // Kurangi saldo user
      const newBalance = userBalance - priceValue;
      const userRef = doc(db,'users',currentUser.uid);
      await updateDoc(userRef,{balance:newBalance});
      userBalance = newBalance;
      saldoTextEl.textContent = formatRupiah(userBalance);

      // Simpan order
      const orderObj = {
        userUid: currentUser.uid,
        userEmail: currentUser.email || '',
        productId: selectedProduct.id,
        productName: selectedProduct.name,
        price: selectedProduct.price,
        priceValue,
        category: selectedProduct.category || '',
        danaNumber,
        danaName,
        sosmedUsername: sosUser || '',
        sosmedLink: sosLink || '',
        panelUser: panelUser || '',
        panelPass: panelPass || '',
        proofUrl: '',            // bisa dipakai nanti kalau pakai upload bukti
        status: 'pending',
        deliveryMsg: '',
        createdAt: new Date().toISOString(),
        balanceAfter: newBalance
      };

      await addDoc(collection(db,'orders'), orderObj);

      msg.textContent = 'Order berhasil dibuat. Status: pending.';
      msg.className = 'msg ok';

      setTimeout(()=>{
        orderModal.style.display = 'none';
        window.location.href = 'orders.html';
      }, 800);

    } catch(e){
      console.error(e);
      msg.textContent = 'Gagal membuat order. Coba lagi.';
      msg.className = 'msg err';
    }
  };
</script>

</body>
</html>
