<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Barmods Store</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
    body {
        background: #0f0f0f;
        color: white;
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
    }

    .navbar {
        background: #111;
        padding: 12px;
        text-align: center;
        font-size: 20px;
        font-weight: bold;
    }

    #productList {
        padding: 15px;
    }

    .card {
        background: #1a1a1a;
        padding: 15px;
        border-radius: 12px;
        margin-bottom: 15px;
    }

    .title {
        font-size: 18px;
        font-weight: bold;
        margin-bottom: 5px;
    }

    .btn-beli {
        background: #007bff;
        padding: 10px 15px;
        border-radius: 8px;
        color: white;
        border: none;
        margin-top: 10px;
    }
</style>
</head>

<body>

<div class="navbar">Barmods Store</div>

<h3 style="padding-left:15px;">Daftar Produk</h3>
<div id="productList">Memuat produk...</div>

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyBpsfDmupS9wq-iNge5aYvknmw5bSryd3A",
  authDomain: "toko-barmods.firebaseapp.com",
  projectId: "toko-barmods",
  storageBucket: "toko-barmods.appspot.com",
  messagingSenderId: "284047189012",
  appId: "1:284047189012:web:6ef0c6891adab08a383301"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

/* ===== FORMAT UANG ===== */
function rupiah(n){
    return "Rp " + Number(n || 0).toLocaleString("id-ID");
}

function parseAmount(raw){
    if(!raw) return 0;
    let s = raw.toString().trim().toLowerCase();

    if(s.endsWith("k")){
        return Number(s.replace("k","")) * 1000;
    }

    s = s.replace(/[^0-9]/g,"");
    return Number(s);
}

/* ===== LOAD PRODUK ===== */
function loadProducts(){
    const listEl = document.getElementById("productList");

    db.collection("products").get().then(snap=>{
        listEl.innerHTML = "";

        if(snap.empty){
            listEl.innerHTML = "<p>Tidak ada produk.</p>";
            return;
        }

        snap.forEach(doc=>{
            const p = doc.data();
            const price = parseAmount(p.price);

            listEl.innerHTML += `
                <div class="card">
                    <div class="title">${p.name}</div>
                    <div>Kategori: ${p.category}</div>
                    <div>Harga: ${rupiah(price)}</div>
                    <button class="btn-beli"
                        onclick="beliProduk('${doc.id}','${encodeURIComponent(p.name)}','${p.category}','${p.price}')">
                        Beli Sekarang
                    </button>
                </div>
            `;
        });
    });
}

/* ===== BELI PRODUK ===== */
function beliProduk(productDocId, encodedName, category, rawPrice){
    const user = auth.currentUser;
    if(!user){
        alert("Silakan login dulu.");
        location.href = "login.html";
        return;
    }

    const productName = decodeURIComponent(encodedName);
    const priceNumber = parseAmount(rawPrice);

    const input = prompt("Masukkan data untuk pesanan ini (username/email/link):");
    if(!input || !input.trim()){
        alert("Input tidak boleh kosong.");
        return;
    }

    const userRef = db.collection("users").doc(user.uid);

    db.runTransaction(async tx=>{
        const u = await tx.get(userRef);
        const saldo = Number(u.data().balance || 0);

        if(saldo < priceNumber) throw new Error("Saldo kurang!");

        tx.update(userRef,{ balance: saldo - priceNumber });

        tx.set(db.collection("orders").doc(), {
            userId: user.uid,
            userEmail: user.email,
            productId: productDocId,
            productName: productName,
            price: priceNumber,
            category: category,
            inputUser: input,
            status: "pending",
            adminProduct: "",
            userReceived: false,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
    })
    .then(()=>{
        alert("Pesanan berhasil dibuat!");
        location.href = "orders.html";
    })
    .catch(e=>{
        alert("Gagal: " + e.message);
    });
}

auth.onAuthStateChanged(user=>{
    if(!user){
        location.href = "login.html";
    } else {
        loadProducts();
    }
});
</script>

</body>
</html>
