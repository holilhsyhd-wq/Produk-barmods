<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Barmods Digital Store</title>

<style>
  body {
    margin: 0;
    background: #020617;
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    color: #e5e7eb;
  }

  header {
    padding: 14px;
    background: #020617;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid #1f2937;
  }

  .brand-title {
    font-size: 15px;
    font-weight: 600;
  }
  .brand-sub {
    font-size: 11px;
    color: #9ca3af;
  }

  .header-left {
    display: flex;
    flex-direction: column;
  }

  .header-right {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
  }

  .btn-header {
    color: #e5e7eb;
    background: #111827;
    padding: 6px 11px;
    border-radius: 999px;
    text-decoration: none;
    font-size: 12px;
    border: 1px solid #374151;
  }

  main {
    padding: 12px;
    max-width: 960px;
    margin: 0 auto;
  }

  h3 {
    margin: 8px 0;
    font-size: 15px;
  }

  .card-info {
    background: #020617;
    border-radius: 14px;
    padding: 10px 12px;
    border: 1px solid #1f2937;
    font-size: 12px;
    margin-bottom: 12px;
  }

  .pill-row {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin-top: 6px;
  }
  .pill {
    border-radius: 999px;
    padding: 4px 8px;
    border: 1px solid #1f2937;
    font-size: 11px;
  }

  .product-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 10px;
  }

  @media (max-width: 560px) {
    .product-grid {
      grid-template-columns: 1fr 1fr;
    }
  }

  .product-card {
    background: #020617;
    border-radius: 12px;
    padding: 9px 9px 10px;
    border: 1px solid #1f2937;
    font-size: 12px;
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .product-title {
    font-weight: 600;
    font-size: 12px;
  }

  .price-tag {
    color: #22c55e;
    font-weight: 700;
    font-size: 13px;
  }

  .stock-line {
    font-size: 11px;
    color: #9ca3af;
  }

  .btn-product {
    margin-top: 5px;
    padding: 7px;
    border-radius: 999px;
    border: none;
    font-size: 12px;
    background: #4f46e5;
    color: #fff;
  }

  .btn-product[disabled] {
    background: #1f2937;
    color: #9ca3af;
  }

  /* MODAL */
  .modal-backdrop {
    position: fixed;
    inset: 0;
    background: rgba(15,23,42,.78);
    display: none;
    align-items: center;
    justify-content: center;
    padding: 18px;
    z-index: 30;
  }

  .modal {
    background: #020617;
    width: 100%;
    max-width: 420px;
    border-radius: 16px;
    padding: 14px 14px 12px;
    border: 1px solid #1f2937;
    box-shadow: 0 18px 50px rgba(0,0,0,.75);
  }

  .modal h3 {
    margin: 0 0 6px;
    font-size: 15px;
  }

  .modal p {
    margin: 0 0 8px;
    font-size: 12px;
    color: #9ca3af;
  }

  .modal label {
    font-size: 12px;
    display: block;
    margin: 6px 0 3px;
  }

  .modal-input {
    width: 100%;
    padding: 7px 9px;
    border-radius: 10px;
    border: 1px solid #1f2937;
    background: #020617;
    color: #e5e7eb;
    font-size: 12px;
  }

  .modal-actions {
    display: flex;
    justify-content: space-between;
    margin-top: 12px;
    gap: 8px;
  }

  .btn-cancel {
    padding: 7px 12px;
    border-radius: 999px;
    border: none;
    font-size: 12px;
    background: #374151;
    color: #e5e7eb;
  }

  .btn-ok {
    padding: 7px 12px;
    border-radius: 999px;
    border: none;
    font-size: 12px;
    background: #4f46e5;
    color: #ffffff;
  }

  .modal-msg {
    font-size: 11px;
    margin-top: 6px;
    text-align: center;
    color: #f97373;
    min-height: 14px;
  }

  .modal-msg.ok {
    color: #22c55e;
  }
</style>
</head>

<body>
<header>
  <div class="header-left">
    <span class="brand-title">Barmods Digital Store</span>
    <span class="brand-sub">Layanan Digital & Sosial Media</span>
  </div>
  <div class="header-right">
    <a href="orders.html" class="btn-header">Pesanan Saya</a>
    <a href="profile.html" class="btn-header">Profil Saya</a>
    <a href="admin.html" class="btn-header">Admin</a>
  </div>
</header>

<main>
  <div class="card-info">
    <b>Cara order singkat:</b><br>
    1. Pilih produk di bawah lalu klik <b>Order Sekarang</b>.<br>
    2. Transfer via DANA ke <b>083877842721</b>.<br>
    3. Isi data DANA + (username / link / panel) di form.<br>
    4. Boleh upload bukti transfer (opsional).<br>
    5. Order masuk status <b>pending</b>, admin ubah ke <b>proses / sukses / eror</b>.
    <div class="pill-row">
      <div class="pill">Pembayaran: DANA 083877842721</div>
      <div class="pill">Order sosmed: akun jangan private</div>
    </div>
  </div>

  <h3>Daftar Produk</h3>
  <div id="productGrid" class="product-grid"></div>
</main>

<!-- ============== MODAL ORDER ============== -->
<div id="orderModal" class="modal-backdrop">
  <div class="modal">
    <h3>Pembayaran via DANA</h3>
    <p>Transfer dulu ke DANA: <b>083877842721</b></p>

    <label>Nomor DANA kamu</label>
    <input id="orderDana" class="modal-input" placeholder="Contoh: 0838xxxxxxx">

    <label>Atas nama DANA</label>
    <input id="orderNama" class="modal-input" placeholder="Nama di aplikasi DANA">

    <p style="font-size:11px;margin-top:8px;color:#9ca3af;">
      Untuk order <b>sosmed</b>, isi username & link.<br>
      Untuk <b>panel</b>, isi user & password panel.
    </p>

    <input id="orderSosmedUser" class="modal-input" placeholder="Username sosmed (opsional)">
    <input id="orderSosmedLink" class="modal-input" placeholder="Link video/profil (opsional)">
    <input id="orderPanelUser" class="modal-input" placeholder="User panel (opsional)">
    <input id="orderPanelPass" class="modal-input" placeholder="Password panel (opsional)">

    <label>Upload bukti transfer (opsional)</label>
    <input id="orderProof" type="file" accept="image/*" style="font-size:11px;color:#e5e7eb;">

    <div class="modal-actions">
      <button type="button" id="orderCancelBtn" class="btn-cancel">Batal</button>
      <button type="button" id="orderSubmitBtn" class="btn-ok">Order Sekarang</button>
    </div>

    <div id="orderMsg" class="modal-msg"></div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import {
    getFirestore, collection, getDocs, addDoc,
    doc, updateDoc
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  import {
    getAuth, onAuthStateChanged
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import {
    getStorage, ref, uploadBytes, getDownloadURL
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBpsfDmupS9wq-iNge5aYvknmw5bSryd3A",
    authDomain: "toko-barmods.firebaseapp.com",
    projectId: "toko-barmods",
    storageBucket: "toko-barmods.firebasestorage.app",
    messagingSenderId: "284047189012",
    appId: "1:284047189012:web:6ef0c6891adab08a383301"
  };

  const app = initializeApp(firebaseConfig);
  const db  = getFirestore(app);
  const auth = getAuth(app);
  const storage = getStorage(app);

  let currentUser = null;
  let products = [];
  let currentProduct = null;

  const grid = document.getElementById("productGrid");
  const orderModal = document.getElementById("orderModal");
  const msgEl = document.getElementById("orderMsg");

  const danaEl  = document.getElementById("orderDana");
  const namaEl  = document.getElementById("orderNama");
  const sUserEl = document.getElementById("orderSosmedUser");
  const sLinkEl = document.getElementById("orderSosmedLink");
  const pUserEl = document.getElementById("orderPanelUser");
  const pPassEl = document.getElementById("orderPanelPass");
  const proofEl = document.getElementById("orderProof");

  onAuthStateChanged(auth, async (user)=>{
    if (!user) {
      window.location.href = "login.html";
      return;
    }
    currentUser = user;
    await loadProducts();
  });

  async function loadProducts(){
    const snap = await getDocs(collection(db,"products"));
    products = [];
    snap.forEach(d=> products.push(d.data()));
    products.sort((a,b)=> (a.id||0)-(b.id||0));

    grid.innerHTML = "";
    products.forEach(p=>{
      const card = document.createElement("div");
      card.className = "product-card";

      const title = document.createElement("div");
      title.className = "product-title";
      title.textContent = p.name;

      const price = document.createElement("div");
      price.className = "price-tag";
      price.textContent = p.price;

      const stok = document.createElement("div");
      stok.className = "stock-line";
      stok.textContent = "Stok: " + (p.stock ?? 0);

      const btn = document.createElement("button");
      btn.className = "btn-product";
      btn.textContent = (p.stock ?? 0) > 0 ? "Order Sekarang" : "Stok habis";
      btn.disabled = (p.stock ?? 0) <= 0;

      if (!btn.disabled) {
        btn.addEventListener("click", ()=> openModal(p.id));
      }

      card.appendChild(title);
      card.appendChild(price);
      card.appendChild(stok);
      card.appendChild(btn);
      grid.appendChild(card);
    });
  }

  function openModal(productId){
    currentProduct = products.find(p=> p.id === productId);
    if (!currentProduct) return;

    danaEl.value = "";
    namaEl.value = "";
    sUserEl.value = "";
    sLinkEl.value = "";
    pUserEl.value = "";
    pPassEl.value = "";
    proofEl.value = "";
    msgEl.textContent = "";
    msgEl.className = "modal-msg";

    orderModal.style.display = "flex";
  }

  function closeModal(){
    orderModal.style.display = "none";
  }

  document.getElementById("orderCancelBtn").onclick = closeModal;
  orderModal.onclick = e=>{
    if (e.target === orderModal) closeModal();
  };

  document.getElementById("orderSubmitBtn").onclick = async ()=>{
    if (!currentProduct || !currentUser) return;

    const dana = danaEl.value.trim();
    const nama = namaEl.value.trim();
    const file = proofEl.files[0];

    msgEl.className = "modal-msg";
    msgEl.textContent = "";

    if (!dana || !nama) {
      msgEl.textContent = "Nomor DANA & Atas nama wajib diisi.";
      return;
    }

    try {
      document.getElementById("orderSubmitBtn").disabled = true;
      document.getElementById("orderSubmitBtn").textContent = "Memproses...";

      let proofUrl = null;
      if (file) {
        const fileName = `${currentUser.uid}_${Date.now()}_${file.name}`;
        const storageRef = ref(storage,"proofs/"+fileName);
        await uploadBytes(storageRef,file);
        proofUrl = await getDownloadURL(storageRef);
      }

      // kurangi stok
      const newStock = Math.max((currentProduct.stock ?? 0) - 1,0);
      await updateDoc(doc(db,"products",String(currentProduct.id)), {
        stock: newStock
      });
      currentProduct.stock = newStock;

      const now = new Date().toISOString();
      await addDoc(collection(db,"orders"),{
        userUid: currentUser.uid,
        userEmail: currentUser.email || "",
        productId: currentProduct.id,
        productName: currentProduct.name,
        price: currentProduct.price,
        category: currentProduct.category || "",
        danaNumber: dana,
        danaName: nama,
        sosmedUsername: sUserEl.value.trim() || null,
        sosmedLink: sLinkEl.value.trim() || null,
        panelUser: pUserEl.value.trim() || null,
        panelPass: pPassEl.value.trim() || null,
        proofUrl: proofUrl,
        deliveryMsg: null,
        status: "pending",
        createdAt: now,
        updatedAt: now
      });

      msgEl.className = "modal-msg ok";
      msgEl.textContent = "Order berhasil tersimpan (status: pending).";

      await loadProducts();
      setTimeout(closeModal, 900);

    } catch(err) {
      console.error(err);
      msgEl.textContent = "Terjadi kesalahan saat memproses order.";
    } finally {
      const btn = document.getElementById("orderSubmitBtn");
      btn.disabled = false;
      btn.textContent = "Order Sekarang";
    }
  };
</script>
</body>
</html>
