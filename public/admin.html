<script type="module">
  import {
    initializeApp
  } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";

  import {
    getFirestore,
    collection,
    doc,
    getDocs,
    getDoc,
    setDoc,
    updateDoc,
    query,
    orderBy
  } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";

  // ================== CONFIG FIREBASE (SUDAH DIGANTI) ==================
  const firebaseConfig = {
    apiKey: "AIzaSyBpsfDmupS9wq-iNge5aYvknmw5bSryd3A",
    authDomain: "toko-barmods.firebaseapp.com",
    projectId: "toko-barmods",
    storageBucket: "toko-barmods.firebasestorage.app",
    messagingSenderId: "284047189012",
    appId: "1:284047189012:web:6ef0c6891adab08a383301"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // ========= KOLEKSI FIRESTORE =========
  const TOPUP_COLLECTION = "topups";
  const ORDERS_COLLECTION = "orders";
  const USERS_COLLECTION = "users";
  const PRODUCTS_COLLECTION = "products";

  // ================== LOGIN ADMIN ==================
  const ADMIN_USER = "barmods";
  const ADMIN_PASS = "barmods21";

  function ensureAdminLogin() {
    const logged = localStorage.getItem("adminLoggedIn") === "true";
    if (logged) return;
    const u = prompt("Username admin:");
    const p = prompt("Password admin:");
    if (u === ADMIN_USER && p === ADMIN_PASS) {
      localStorage.setItem("adminLoggedIn", "true");
    } else {
      alert("Username / password salah.");
      window.location.href = "login.html";
    }
  }

  ensureAdminLogin();

  document.getElementById("logoutBtn").addEventListener("click", () => {
    localStorage.removeItem("adminLoggedIn");
    window.location.href = "login.html";
  });

  // ================== TAB ==================
  const tabButtons = {
    produk: document.getElementById("tab-produk"),
    saldo: document.getElementById("tab-saldo"),
    topup: document.getElementById("tab-topup"),
    pesanan: document.getElementById("tab-pesanan")
  };

  const sections = {
    produk: document.getElementById("section-produk"),
    saldo: document.getElementById("section-saldo"),
    topup: document.getElementById("section-topup"),
    pesanan: document.getElementById("section-pesanan")
  };

  function showTab(name) {
    for (const key in sections) {
      sections[key].style.display = key === name ? "block" : "none";
      tabButtons[key].classList.toggle("active", key === name);
    }
    if (name === "produk") loadProducts();
    if (name === "saldo") loadUserBalances();
    if (name === "topup") loadTopups();
    if (name === "pesanan") loadOrders();
  }

  tabButtons.produk.addEventListener("click", () => showTab("produk"));
  tabButtons.saldo.addEventListener("click", () => showTab("saldo"));
  tabButtons.topup.addEventListener("click", () => showTab("topup"));
  tabButtons.pesanan.addEventListener("click", () => showTab("pesanan"));

  showTab("produk");

  // ================== PRODUK ==================
  async function loadProducts() {
    const tbody = document.getElementById("produk-body");
    tbody.innerHTML = `<tr><td colspan="5">Memuat produk...</td></tr>`;
    try {
      const q = query(collection(db, PRODUCTS_COLLECTION), orderBy("id", "asc"));
      const snap = await getDocs(q);
      if (snap.empty) {
        tbody.innerHTML = `<tr><td colspan="5">Belum ada produk.</td></tr>`;
        return;
      }
      tbody.innerHTML = "";
      snap.forEach((d) => {
        const data = d.data();
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${data.id ?? ""}</td>
          <td><input value="${data.name ?? ""}" data-id="${d.id}" data-field="name"></td>
          <td><input value="${data.price ?? ""}" data-id="${d.id}" data-field="price"></td>
          <td><input type="number" value="${data.stock ?? 0}" data-id="${d.id}" data-field="stock"></td>
          <td><button class="btn-save" data-id="${d.id}">Simpan</button></td>
        `;
        tbody.appendChild(tr);
      });

      tbody.querySelectorAll(".btn-save").forEach((btn) => {
        btn.addEventListener("click", async () => {
          const id = btn.dataset.id;
          const inputs = tbody.querySelectorAll(`input[data-id="${id}"]`);
          const payload = {};
          inputs.forEach((inp) => {
            payload[inp.dataset.field] =
              inp.type === "number" ? Number(inp.value || 0) : inp.value;
          });
          await updateDoc(doc(db, PRODUCTS_COLLECTION, id), payload);
          alert("Produk disimpan.");
        });
      });
    } catch (err) {
      tbody.innerHTML = `<tr><td colspan="5">Gagal memuat produk: ${err.message}</td></tr>`;
    }
  }

  // ================== SALDO PENGGUNA ==================
  async function loadUserBalances() {
    const tbody = document.getElementById("saldo-body");
    tbody.innerHTML = `<tr><td colspan="4">Memuat data...</td></tr>`;
    try {
      const snap = await getDocs(collection(db, USERS_COLLECTION));
      if (snap.empty) {
        tbody.innerHTML = `<tr><td colspan="4">Belum ada user.</td></tr>`;
        return;
      }
      tbody.innerHTML = "";
      snap.forEach((d) => {
        const data = d.data();
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${data.email ?? ""}</td>
          <td>${data.username ?? "-"}</td>
          <td><input type="number" value="${data.balance ?? 0}" data-id="${d.id}" class="saldo-input"></td>
          <td><button class="btn-saldo" data-id="${d.id}">Simpan</button></td>
        `;
        tbody.appendChild(tr);
      });

      tbody.querySelectorAll(".btn-saldo").forEach((btn) => {
        btn.addEventListener("click", async () => {
          const id = btn.dataset.id;
          const input = tbody.querySelector(
            `input.saldo-input[data-id="${id}"]`
          );
          const nominal = Number(input.value || 0);
          await updateDoc(doc(db, USERS_COLLECTION, id), { balance: nominal });
          alert("Saldo diperbarui.");
        });
      });
    } catch (err) {
      tbody.innerHTML = `<tr><td colspan="4">Gagal memuat saldo: ${err.message}</td></tr>`;
    }
  }

  // ================== TOPUP SALDO ==================
  async function loadTopups() {
    const tbody = document.getElementById("topup-body");
    tbody.innerHTML = `<tr><td colspan="6">Memuat permintaan topup...</td></tr>`;
    try {
      const q = query(
        collection(db, TOPUP_COLLECTION),
        orderBy("createdAt", "desc")
      );
      const snap = await getDocs(q);
      if (snap.empty) {
        tbody.innerHTML = `<tr><td colspan="6">Belum ada permintaan topup.</td></tr>`;
        return;
      }
      tbody.innerHTML = "";
      snap.forEach((d) => {
        const t = d.data();
        const waktu = t.createdAt?.toDate
          ? t.createdAt.toDate().toLocaleString()
          : "-";
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${waktu}</td>
          <td>${t.userEmail ?? "-"}</td>
          <td>Rp ${Number(t.amount ?? 0).toLocaleString("id-ID")}</td>
          <td>${t.danaNumber ?? "-"}</td>
          <td>
            <select data-id="${d.id}" class="status-topup">
              <option value="pending" ${t.status === "pending" ? "selected" : ""}>pending</option>
              <option value="proses" ${t.status === "proses" ? "selected" : ""}>proses</option>
              <option value="sukses" ${t.status === "sukses" ? "selected" : ""}>sukses</option>
              <option value="error" ${t.status === "error" ? "selected" : ""}>error</option>
            </select>
          </td>
          <td><button class="btn-topup" data-id="${d.id}">Simpan</button></td>
        `;
        tbody.appendChild(tr);
      });

      tbody.querySelectorAll(".btn-topup").forEach((btn) => {
        btn.addEventListener("click", async () => {
          const id = btn.dataset.id;
          const select = tbody.querySelector(
            `select.status-topup[data-id="${id}"]`
          );
          const newStatus = select.value;

          const ref = doc(db, TOPUP_COLLECTION, id);
          const snap = await getDoc(ref);
          if (!snap.exists()) return;
          const data = snap.data();

          await updateDoc(ref, { status: newStatus });

          if (newStatus === "sukses" && data.userId) {
            const userRef = doc(db, USERS_COLLECTION, data.userId);
            const userSnap = await getDoc(userRef);
            if (userSnap.exists()) {
              const u = userSnap.data();
              const current = Number(u.balance ?? 0);
              const plus = Number(data.amount ?? 0);
              await updateDoc(userRef, { balance: current + plus });
            }
          }

          alert("Topup diperbarui.");
          loadTopups();
        });
      });
    } catch (err) {
      tbody.innerHTML = `<tr><td colspan="6">Gagal memuat topup: ${err.message}</td></tr>`;
    }
  }

  // ================== PESANAN ==================
  async function loadOrders() {
    const tbody = document.getElementById("pesanan-body");
    tbody.innerHTML = `<tr><td colspan="7">Memuat pesanan...</td></tr>`;
    try {
      const q = query(
        collection(db, ORDERS_COLLECTION),
        orderBy("createdAt", "desc")
      );
      const snap = await getDocs(q);
      if (snap.empty) {
        tbody.innerHTML = `<tr><td colspan="7">Belum ada pesanan.</td></tr>`;
        return;
      }
      tbody.innerHTML = "";
      snap.forEach((d) => {
        const o = d.data();
        const waktu = o.createdAt?.toDate
          ? o.createdAt.toDate().toLocaleString()
          : "-";
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${waktu}</td>
          <td>${o.userEmail ?? "-"}</td>
          <td>${o.productName ?? "-"}</td>
          <td>Rp ${Number(o.price ?? 0).toLocaleString("id-ID")}</td>
          <td>
            <select data-id="${d.id}" class="status-order">
              <option value="pending" ${o.status === "pending" ? "selected" : ""}>pending</option>
              <option value="proses" ${o.status === "proses" ? "selected" : ""}>proses</option>
              <option value="sukses" ${o.status === "sukses" ? "selected" : ""}>sukses</option>
              <option value="error" ${o.status === "error" ? "selected" : ""}>error</option>
            </select>
          </td>
          <td>
            <textarea data-id="${d.id}" class="produk-admin" rows="2" placeholder="Isi produk yang dikirim">${o.adminProduct ?? ""}</textarea>
          </td>
          <td><button class="btn-order" data-id="${d.id}">Simpan</button></td>
        `;
        tbody.appendChild(tr);
      });

      tbody.querySelectorAll(".btn-order").forEach((btn) => {
        btn.addEventListener("click", async () => {
          const id = btn.dataset.id;
          const select = tbody.querySelector(
            `select.status-order[data-id="${id}"]`
          );
          const textarea = tbody.querySelector(
            `textarea.produk-admin[data-id="${id}"]`
          );
          await updateDoc(doc(db, ORDERS_COLLECTION, id), {
            status: select.value,
            adminProduct: textarea.value
          });
          alert("Pesanan diperbarui.");
        });
      });
    } catch (err) {
      tbody.innerHTML = `<tr><td colspan="7">Gagal memuat pesanan: ${err.message}</td></tr>`;
    }
  }
</script>
