<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Admin - Barmods Digital Store</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  body{
    margin:0;
    font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
    background:#f3f4f6;
  }
  .topbar{
    height:54px;
    background:#111827;
    color:#f9fafb;
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding:0 14px;
  }
  .topbar-left{
    display:flex;
    flex-direction:column;
  }
  .topbar-title{font-size:14px;font-weight:600;}
  .topbar-sub{font-size:11px;color:#9ca3af;}
  .topbar-right{
    display:flex;
    gap:8px;
    flex-wrap:wrap;
  }
  .btn-top{
    border:none;
    border-radius:999px;
    padding:6px 10px;
    font-size:11px;
    background:#374151;
    color:#f9fafb;
    cursor:pointer;
  }
  .btn-top.logout{background:#ef4444;}
  .main{
    max-width:1080px;
    margin:0 auto;
    padding:12px 10px 18px;
  }
  .card{
    background:#ffffff;
    border-radius:14px;
    padding:14px;
    margin-bottom:12px;
    box-shadow:0 8px 20px rgba(15,23,42,.08);
    border:1px solid #e5e7eb;
  }
  .card-header{
    display:flex;
    justify-content:space-between;
    align-items:center;
    flex-wrap:wrap;
    gap:4px;
    margin-bottom:6px;
  }
  .card-header h2{margin:0;font-size:15px;}
  .card-header small{font-size:11px;color:#6b7280;}
  .info{font-size:12px;color:#4b5563;}
  .pill-row{display:flex;flex-wrap:wrap;gap:6px;margin-top:6px;font-size:11px;}
  .pill{padding:4px 7px;border-radius:999px;background:#f3f4f6;border:1px solid #e5e7eb;}

  table{width:100%;border-collapse:collapse;font-size:12px;margin-top:6px;}
  th,td{border-bottom:1px solid #e5e7eb;padding:5px 4px;text-align:left;vertical-align:top;}
  th{background:#f9fafb;font-size:11px;}
  .small-input{
    width:100%;box-sizing:border-box;padding:4px 6px;border-radius:6px;
    border:1px solid #d1d5db;font-size:11px;background:#f9fafb;
  }
  .textarea{
    width:100%;min-height:40px;resize:vertical;padding:4px 6px;border-radius:6px;
    border:1px solid #d1d5db;font-size:11px;background:#f9fafb;
  }
  .select{
    width:100%;padding:4px 6px;border-radius:6px;border:1px solid #d1d5db;
    font-size:11px;background:#f9fafb;
  }
  .btn-sm{
    border:none;border-radius:999px;padding:4px 8px;font-size:11px;cursor:pointer;margin-top:3px;
  }
  .btn-save{background:#2563eb;color:#fff;}
  .btn-send{background:#16a34a;color:#fff;}
  .badge{
    display:inline-block;border-radius:999px;padding:2px 6px;font-size:10px;margin-top:3px;
  }
  .status-pending{background:#facc15;color:#111827;}
  .status-proses{background:#3b82f6;color:#fff;}
  .status-eror{background:#f97373;color:#111827;}
  .status-sukses{background:#22c55e;color:#fff;}
  .msg{font-size:12px;margin-top:6px;min-height:16px;}
  .msg.ok{color:#16a34a;}
  .msg.err{color:#ef4444;}
  .link{color:#2563eb;text-decoration:none;font-size:11px;}
  .link:hover{text-decoration:underline;}
  #notAdminMsg{text-align:center;margin-top:40px;display:none;}
  #adminOnly{display:none;}
</style>
</head>
<body>

<div class="topbar">
  <div class="topbar-left">
    <span class="topbar-title">Admin - Barmods Digital Store</span>
    <span class="topbar-sub">Panel khusus pemilik toko</span>
  </div>
  <div class="topbar-right">
    <button class="btn-top" onclick="location.href='index.html'">‚Üê Halaman Produk</button>
    <button id="logoutBtnTop" class="btn-top logout">Logout</button>
  </div>
</div>

<div class="main">
  <!-- Loading / login prompt -->
  <div id="loadingCard" class="card">
    <div class="card-header">
      <h2>Memeriksa sesi admin...</h2>
    </div>
    <p class="info">Mohon tunggu sebentar.</p>
  </div>

  <div id="notAdminMsg">
    <div class="card">
      <div class="card-header">
        <h2>Akses ditolak</h2>
      </div>
      <p class="info">
        Hanya email <b>holilhsyhd@gmail.com</b> yang bisa mengakses panel admin.<br>
        Silakan login dengan akun Google admin.
      </p>
      <button id="loginAdminBtn" class="btn-sm btn-save" type="button">Login dengan Google</button>
    </div>
  </div>

  <div id="adminOnly">
    <!-- Info Admin -->
    <div class="card">
      <div class="card-header">
        <div>
          <h2>Selamat datang, Admin</h2>
          <small>Kelola produk & order Barmods Digital Store</small>
        </div>
      </div>
      <p class="info">
        Login sebagai: <b><span id="adminEmail"></span></b>
      </p>
      <div class="pill-row">
        <div class="pill">Admin: <b>holilhsyhd@gmail.com</b></div>
        <div class="pill">Status: <b id="adminStatus">Aktif</b></div>
      </div>
    </div>

    <!-- Produk -->
    <div class="card">
      <div class="card-header">
        <div>
          <h2>Daftar Produk</h2>
          <small>Edit nama, harga, stok</small>
        </div>
      </div>
      <p class="info">
        Perubahan langsung disimpan ke Firestore dan mempengaruhi halaman produk user.
      </p>
      <div id="productMsg" class="msg"></div>
      <table id="productTable">
        <thead>
          <tr>
            <th>ID</th>
            <th>Produk</th>
            <th>Harga</th>
            <th>Stok</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Orders -->
    <div class="card">
      <div class="card-header">
        <div>
          <h2>Daftar Order</h2>
          <small>Kelola status dan kirim produk ke pembeli</small>
        </div>
      </div>
      <p class="info">
        Status order:
        <b>pending</b> = baru masuk,
        <b>proses</b> = sedang dikerjakan,
        <b>eror</b> = gagal / ada kendala,
        <b>sukses</b> = produk sudah dikirim ke pembeli.<br>
        Tombol <b>Kirim Produk</b> akan otomatis mengubah status ke <b>sukses</b>.
      </p>
      <div id="orderMsg" class="msg"></div>
      <table id="orderTable">
        <thead>
          <tr>
            <th>#</th>
            <th>Waktu</th>
            <th>Produk</th>
            <th>Pembeli</th>
            <th>DANA</th>
            <th>Sosmed/Panel</th>
            <th>Bukti</th>
            <th>Status</th>
            <th>Produk ke Pembeli</th>
            <th>Aksi</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import {
    getFirestore, collection, getDocs, doc, updateDoc,
    query, orderBy
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  import {
    getAuth, onAuthStateChanged, signOut,
    GoogleAuthProvider, signInWithPopup
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBpsfDmupS9wq-iNge5aYvknmw5bSryd3A",
    authDomain: "toko-barmods.firebaseapp.com",
    projectId: "toko-barmods",
    storageBucket: "toko-barmods.firebasestorage.app",
    messagingSenderId: "284047189012",
    appId: "1:284047189012:web:6ef0c6891adab08a383301"
  };

  const ADMIN_EMAILS = ["holilhsyhd@gmail.com"];

  const app  = initializeApp(firebaseConfig);
  const db   = getFirestore(app);
  const auth = getAuth(app);
  const provider = new GoogleAuthProvider();

  const loadingCard = document.getElementById("loadingCard");
  const notAdminBox = document.getElementById("notAdminMsg");
  const adminOnly   = document.getElementById("adminOnly");
  const loginAdminBtn = document.getElementById("loginAdminBtn");

  const adminEmailEl = document.getElementById("adminEmail");
  const productTableBody = document.querySelector("#productTable tbody");
  const orderTableBody   = document.querySelector("#orderTable tbody");
  const productMsgEl = document.getElementById("productMsg");
  const orderMsgEl   = document.getElementById("orderMsg");

  function setMsg(el,text,ok=false){
    el.textContent = text || "";
    el.className = "msg" + (text ? (ok?" ok":" err") : "");
  }

  async function ensureAdmin(user){
    if (!user){
      // belum login -> tampilkan tombol login
      loadingCard.style.display = "none";
      notAdminBox.style.display = "block";
      adminOnly.style.display = "none";
      loginAdminBtn.onclick = async ()=>{
        try { await signInWithPopup(auth, provider); }
        catch(e){ setMsg(orderMsgEl,"Gagal login Google admin."); }
      };
      return false;
    }
    const email = user.email || "";
    if (!ADMIN_EMAILS.includes(email)){
      loadingCard.style.display = "none";
      notAdminBox.style.display = "block";
      adminOnly.style.display = "none";
      return false;
    }

    adminEmailEl.textContent = email;
    loadingCard.style.display = "none";
    notAdminBox.style.display = "none";
    adminOnly.style.display = "block";
    return true;
  }

  async function loadProducts(){
    productTableBody.innerHTML = "";
    try{
      const snap = await getDocs(collection(db,"products"));
      const arr = [];
      snap.forEach(d=>arr.push(d.data()));
      arr.sort((a,b)=>(a.id||0)-(b.id||0));

      arr.forEach(p=>{
        const tr = document.createElement("tr");

        const tdId = document.createElement("td");
        tdId.textContent = p.id;

        const tdName = document.createElement("td");
        const inpName = document.createElement("input");
        inpName.className = "small-input";
        inpName.value = p.name || "";
        inpName.dataset.id = p.id;
        inpName.dataset.field = "name";
        tdName.appendChild(inpName);

        const tdPrice = document.createElement("td");
        const inpPrice = document.createElement("input");
        inpPrice.className = "small-input";
        inpPrice.value = p.price || "";
        inpPrice.dataset.id = p.id;
        inpPrice.dataset.field = "price";
        tdPrice.appendChild(inpPrice);

        const tdStock = document.createElement("td");
        const inpStock = document.createElement("input");
        inpStock.className = "small-input";
        inpStock.type = "number";
        inpStock.min = "0";
        inpStock.value = p.stock ?? 0;
        inpStock.dataset.id = p.id;
        inpStock.dataset.field = "stock";
        tdStock.appendChild(inpStock);

        tr.appendChild(tdId);
        tr.appendChild(tdName);
        tr.appendChild(tdPrice);
        tr.appendChild(tdStock);
        productTableBody.appendChild(tr);
      });

      productTableBody.querySelectorAll("input.small-input").forEach(inp=>{
        inp.addEventListener("change", async function(){
          const id = this.dataset.id;
          const field = this.dataset.field;
          let val = this.value;
          if (field === "stock"){
            let v = parseInt(val,10);
            if (isNaN(v)||v<0) v=0;
            val = v;
            this.value = v;
          }
          try{
            await updateDoc(doc(db,"products",String(id)),{
              [field]: val,
              updatedAt: new Date().toISOString()
            });
            setMsg(productMsgEl,"Produk tersimpan.",true);
          }catch(e){
            console.error(e);
            setMsg(productMsgEl,"Gagal menyimpan produk.");
          }
        });
      });

    }catch(e){
      console.error(e);
      setMsg(productMsgEl,"Gagal memuat produk.");
    }
  }

  async function loadOrders(){
    orderTableBody.innerHTML = "";
    try{
      const qRef = query(collection(db,"orders"), orderBy("createdAt","desc"));
      const snap = await getDocs(qRef);
      const arr = [];
      snap.forEach(d=>arr.push({docId:d.id, ...d.data()}));

      arr.forEach((o,idx)=>{
        const tr = document.createElement("tr");

        const tdIdx = document.createElement("td");
        tdIdx.textContent = idx+1;

        const tdTime = document.createElement("td");
        if (o.createdAt){
          const d = new Date(o.createdAt);
          tdTime.textContent = d.toLocaleString("id-ID");
        } else tdTime.textContent = "-";

        const tdProd = document.createElement("td");
        tdProd.textContent = o.productName || "-";

        const tdBuyer = document.createElement("td");
        tdBuyer.innerHTML =
          (o.userEmail?("Email: "+o.userEmail+"<br>"):"")+
          (o.userUid?("UID: "+o.userUid+"<br>"):"");

        const tdDana = document.createElement("td");
        tdDana.innerHTML =
          "No: "+(o.danaNumber||"-")+"<br>"+
          "a.n: "+(o.danaName||"-");

        const tdSos = document.createElement("td");
        const lines = [];
        if (o.sosmedUsername) lines.push("User sosmed: "+o.sosmedUsername);
        if (o.sosmedLink) lines.push("Link: "+o.sosmedLink);
        if (o.panelUser) lines.push("User panel: "+o.panelUser);
        if (o.panelPass) lines.push("Pass panel: "+o.panelPass);
        tdSos.innerHTML = lines.length?lines.join("<br>"):"-";

        const tdProof = document.createElement("td");
        if (o.proofUrl){
          const a = document.createElement("a");
          a.href = o.proofUrl;
          a.target = "_blank";
          a.rel = "noopener noreferrer";
          a.className = "link";
          a.textContent = "Lihat";
          tdProof.appendChild(a);
        } else tdProof.textContent = "-";

        const tdStatus = document.createElement("td");
        const select = document.createElement("select");
        select.className = "select";
        const stNow = (o.status || "pending").toLowerCase();
        ["pending","proses","sukses","eror"].forEach(st=>{
          const opt = document.createElement("option");
          opt.value = st;
          opt.textContent = st;
          if (st===stNow) opt.selected = true;
          select.appendChild(opt);
        });
        const badge = document.createElement("div");
        badge.className = "badge status-"+stNow;
        badge.textContent = stNow;
        tdStatus.appendChild(select);
        tdStatus.appendChild(badge);

        const tdDelivery = document.createElement("td");
        const ta = document.createElement("textarea");
        ta.className = "textarea";
        ta.value = o.deliveryMsg || "";
        ta.placeholder = "Isi produk (akun, kode, catatan, dll)...";
        tdDelivery.appendChild(ta);

        const tdAction = document.createElement("td");
        const btnSave = document.createElement("button");
        btnSave.className = "btn-sm btn-save";
        btnSave.textContent = "Simpan";
        const btnSend = document.createElement("button");
        btnSend.className = "btn-sm btn-send";
        btnSend.textContent = "Kirim Produk";
        tdAction.appendChild(btnSave);
        tdAction.appendChild(btnSend);

        tr.appendChild(tdIdx);
        tr.appendChild(tdTime);
        tr.appendChild(tdProd);
        tr.appendChild(tdBuyer);
        tr.appendChild(tdDana);
        tr.appendChild(tdSos);
        tr.appendChild(tdProof);
        tr.appendChild(tdStatus);
        tr.appendChild(tdDelivery);
        tr.appendChild(tdAction);
        orderTableBody.appendChild(tr);

        select.addEventListener("change", ()=>{
          const st = select.value;
          badge.className = "badge status-"+st;
          badge.textContent = st;
        });

        btnSave.addEventListener("click", async ()=>{
          try{
            await updateDoc(doc(db,"orders",o.docId),{
              status: select.value,
              deliveryMsg: ta.value.trim() || null,
              updatedAt: new Date().toISOString()
            });
            setMsg(orderMsgEl,"Order tersimpan.",true);
          }catch(e){
            console.error(e);
            setMsg(orderMsgEl,"Gagal menyimpan order.");
          }
        });

        btnSend.addEventListener("click", async ()=>{
          const text = ta.value.trim();
          if (!text){
            alert("Isi dulu kolom 'Produk ke pembeli' sebelum kirim.");
            return;
          }
          try{
            await updateDoc(doc(db,"orders",o.docId),{
              status: "sukses",
              deliveryMsg: text,
              updatedAt: new Date().toISOString()
            });
            select.value = "sukses";
            badge.className = "badge status-sukses";
            badge.textContent = "sukses";
            setMsg(orderMsgEl,"Produk dikirim ke pembeli (status sukses).",true);
          }catch(e){
            console.error(e);
            setMsg(orderMsgEl,"Gagal mengirim produk.");
          }
        });
      });

    }catch(e){
      console.error(e);
      setMsg(orderMsgEl,"Gagal memuat order.");
    }
  }

  onAuthStateChanged(auth, async (user)=>{
    const ok = await ensureAdmin(user);
    if (!ok) return;
    await loadProducts();
    await loadOrders();
  });

  document.getElementById("logoutBtnTop").onclick = async ()=>{
    try{ await signOut(auth); }catch(e){}
    window.location.href = "login.html";
  };
</script>

</body>
</html>
