<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Admin Panel Barmods</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #020617;
      --card: #020617;
      --card-soft: #0b1220;
      --primary: #2563eb;
      --accent: #22c55e;
      --danger: #ef4444;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --radius-xl: 18px;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      min-height: 100vh;
      color: var(--text);
      background:
        radial-gradient(circle at top left, #1d4ed8 0, transparent 55%),
        radial-gradient(circle at bottom right, #0f766e 0, transparent 55%),
        #020617;
      padding-bottom: 80px;
    }

    .page {
      max-width: 900px;
      margin: 0 auto;
      padding: 16px 16px 100px;
    }

    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 14px;
      margin-top: 6px;
    }

    h1 {
      font-size: 22px;
      font-weight: 800;
    }

    .admin-email {
      font-size: 12px;
      color: var(--muted);
      margin-top: 2px;
    }

    .logout-btn {
      border: none;
      border-radius: 999px;
      padding: 8px 16px;
      font-size: 12px;
      font-weight: 600;
      background: linear-gradient(135deg,#ef4444,#f97316);
      color: #fff;
      cursor: pointer;
      box-shadow: 0 8px 20px rgba(248,113,113,0.4);
    }

    .tabs {
      display: flex;
      gap: 10px;
      margin: 10px 0 18px;
      flex-wrap: wrap;
    }

    .tab-btn {
      border-radius: 999px;
      padding: 8px 18px;
      font-size: 13px;
      border: 1px solid rgba(148,163,184,0.6);
      background: rgba(15,23,42,0.9);
      color: var(--muted);
      cursor: pointer;
    }

    .tab-btn.active {
      background: radial-gradient(circle at top, #1d4ed8, #1e293b);
      color: #e5e7eb;
      box-shadow: 0 0 0 1px rgba(96,165,250,0.7);
    }

    .tab-content { display: none; }
    .tab-content.active { display: block; }

    .card {
      background: radial-gradient(circle at top left, rgba(15,23,42,0.96), rgba(15,23,42,0.98));
      border-radius: var(--radius-xl);
      border: 1px solid rgba(37,99,235,0.5);
      box-shadow: 0 18px 40px rgba(15,23,42,0.9);
      padding: 14px 16px;
      margin-bottom: 12px;
    }

    .section-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 10px;
    }

    .field-row {
      display: grid;
      grid-template-columns: 110px 1fr;
      gap: 6px;
      margin-bottom: 4px;
      font-size: 12px;
    }

    .field-row label { color: var(--muted); }

    .field-row input,
    .field-row select,
    .field-row textarea {
      border-radius: 10px;
      border: 1px solid rgba(31,41,55,0.9);
      background: rgba(15,23,42,0.95);
      color: var(--text);
      padding: 6px 8px;
      font-size: 12px;
      width: 100%;
    }

    textarea { resize: vertical; min-height: 60px; }

    .badge {
      display: inline-block;
      border-radius: 999px;
      padding: 3px 9px;
      font-size: 10px;
      border: 1px solid rgba(148,163,184,0.6);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      margin-bottom: 6px;
    }

    .badge.success { border-color: #22c55e; color:#bbf7d0; }
    .badge.pending { border-color: #facc15; color:#fef9c3; }
    .badge.process { border-color: #38bdf8; color:#e0f2fe; }

    .btn {
      border-radius: 999px;
      border: none;
      padding: 7px 16px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 8px;
    }

    .btn-primary {
      background: linear-gradient(135deg,#2563eb,#1d4ed8);
      color: #e5e7eb;
      box-shadow: 0 10px 24px rgba(37,99,235,0.7);
    }

    .btn-danger {
      background: linear-gradient(135deg,#ef4444,#b91c1c);
      color: #fee2e2;
    }

    .pill {
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 11px;
      background: rgba(15,23,42,0.9);
      border: 1px solid rgba(148,163,184,0.5);
      display: inline-block;
      margin-bottom: 4px;
    }

    .toast {
      position: fixed;
      left: 50%;
      bottom: 80px;
      transform: translateX(-50%);
      padding: 8px 14px;
      border-radius: 999px;
      font-size: 12px;
      background: rgba(15,23,42,0.96);
      color: #e5e7eb;
      border: 1px solid rgba(148,163,184,0.7);
      box-shadow: 0 16px 40px rgba(15,23,42,0.95);
      display: none;
      z-index: 1000;
    }

    .toast.show {
      display: block;
      animation: fadeInOut 2.4s ease forwards;
    }

    @keyframes fadeInOut {
      0% { opacity: 0; transform: translate(-50%, 10px); }
      10% { opacity: 1; transform: translate(-50%, 0); }
      80% { opacity: 1; transform: translate(-50%, 0); }
      100% { opacity: 0; transform: translate(-50%, 10px); }
    }

    .empty-text {
      text-align: center;
      font-size: 13px;
      color: var(--muted);
      margin-top: 12px;
    }
  </style>
</head>
<body>
  <div class="page">
    <div class="top-bar">
      <div>
        <h1>Admin Panel Barmods</h1>
        <div id="adminEmail" class="admin-email">Memuat admin...</div>
      </div>
      <button class="logout-btn" id="btnLogout">Logout Admin</button>
    </div>

    <div class="tabs">
      <button class="tab-btn active" data-tab="produk">Produk</button>
      <button class="tab-btn" data-tab="topup">Topup</button>
      <button class="tab-btn" data-tab="saldo">Saldo User</button>
      <button class="tab-btn" data-tab="orders">Orders</button>
    </div>

    <!-- PRODUK -->
    <div id="tab-produk" class="tab-content active">
      <div class="section-title">Daftar Produk</div>
      <div class="card">
        <div class="badge">Tambah / Edit Produk</div>
        <div class="field-row">
          <label>Nama produk</label>
          <input id="prodName" placeholder="Nama produk" />
        </div>
        <div class="field-row">
          <label>Harga (angka)</label>
          <input id="prodPrice" placeholder="6000" type="number" />
        </div>
        <div class="field-row">
          <label>Stok</label>
          <input id="prodStock" placeholder="100" type="number" />
        </div>
        <div class="field-row">
          <label>Kategori</label>
          <input id="prodCategory" placeholder="premium / sosmed / panel / lainnya" />
        </div>
        <div class="field-row">
          <label>Icon (emoji)</label>
          <input id="prodIcon" placeholder="üî• / üé¨ / ‚≠ê" />
        </div>
        <input type="hidden" id="prodIdEdit" />
        <button class="btn btn-primary" id="btnSaveProduct">Simpan Produk</button>
        <button class="btn btn-danger" id="btnResetProduct" style="margin-left:8px;">Reset Form</button>
      </div>

      <div id="produkList"></div>
    </div>

    <!-- TOPUP -->
    <div id="tab-topup" class="tab-content">
      <div class="section-title">Daftar Topup</div>
      <div id="topupList"></div>
    </div>

    <!-- SALDO USER -->
    <div id="tab-saldo" class="tab-content">
      <div class="section-title">Saldo User</div>
      <div id="userBalanceList"></div>
    </div>

    <!-- ORDERS -->
    <div id="tab-orders" class="tab-content">
      <div class="section-title">Daftar Orders</div>
      <div id="ordersList"></div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <!-- Firebase compat SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

  <script>
    // --- CONFIG FIREBASE (SAMA DENGAN FILE LAIN) ---
    const firebaseConfig = {
      apiKey: "AIzaSyBpsfDmupS9wq-iNge5aYvknmw5bSryd3A",
      authDomain: "toko-barmods.firebaseapp.com",
      projectId: "toko-barmods",
      storageBucket: "toko-barmods.firebasestorage.app",
      messagingSenderId: "284047189012",
      appId: "1:284047189012:web:6ef0c6891adab08a383301"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db   = firebase.firestore();

    const adminEmailEl   = document.getElementById("adminEmail");
    const toastEl        = document.getElementById("toast");
    const produkListEl   = document.getElementById("produkList");
    const topupListEl    = document.getElementById("topupList");
    const userBalanceEl  = document.getElementById("userBalanceList");
    const ordersListEl   = document.getElementById("ordersList");

    function showToast(msg) {
      toastEl.textContent = msg;
      toastEl.classList.remove("show");
      void toastEl.offsetWidth;
      toastEl.classList.add("show");
    }

    function formatRupiah(num) {
      if (typeof num === "string") {
        const cleaned = num.replace(/[^0-9]/g, "");
        if (!cleaned) return num;
        num = parseInt(cleaned, 10);
      }
      if (isNaN(num)) return "Rp 0";
      return "Rp " + num.toLocaleString("id-ID");
    }

    // ---------- AUTH ----------
    auth.onAuthStateChanged(async (user) => {
      if (!user) {
        // kalau belum login, lempar ke admin-login.html
        window.location.href = "admin-login.html";
        return;
      }
      adminEmailEl.textContent = (user.email || "Admin") + " (Admin)";
      await Promise.all([
        loadProducts(),
        loadTopups(),
        loadUserBalances(),
        loadOrders()
      ]);
    });

    document.getElementById("btnLogout").addEventListener("click", async () => {
      try {
        await auth.signOut();
        window.location.href = "admin-login.html";
      } catch (e) {
        console.error(e);
        showToast("Gagal logout.");
      }
    });

    // ---------- TAB ----------
    document.querySelectorAll(".tab-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        const tab = btn.dataset.tab;
        document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
        document.querySelectorAll(".tab-content").forEach(c => c.classList.remove("active"));
        btn.classList.add("active");
        document.getElementById("tab-" + tab).classList.add("active");
      });
    });

    // ---------- PRODUK ----------
    async function loadProducts() {
      produkListEl.innerHTML = "<p class='empty-text'>Memuat produk...</p>";
      try {
        const snap = await db.collection("products").orderBy("name").get();
        if (snap.empty) {
          produkListEl.innerHTML = "<p class='empty-text'>Belum ada produk.</p>";
          return;
        }
        produkListEl.innerHTML = "";
        snap.forEach(doc => {
          const data = doc.data();
          const card = document.createElement("div");
          card.className = "card";
          const price = data.price ?? 0;
          const stock = data.stock ?? 0;
          const icon  = data.icon || "‚≠ê";
          card.innerHTML = `
            <div class="pill">${icon} ${data.name || "(tanpa nama)"} ¬∑ ${data.category || "lainnya"}</div>
            <div class="field-row">
              <label>Harga</label>
              <div>${formatRupiah(price)}</div>
            </div>
            <div class="field-row">
              <label>Stok</label>
              <div>${stock}</div>
            </div>
            <button class="btn btn-primary btn-edit">Edit</button>
            <button class="btn btn-danger btn-delete" style="margin-left:8px;">Hapus</button>
          `;
          card.querySelector(".btn-edit").addEventListener("click", () => {
            document.getElementById("prodIdEdit").value   = doc.id;
            document.getElementById("prodName").value     = data.name || "";
            document.getElementById("prodPrice").value    = price;
            document.getElementById("prodStock").value    = stock;
            document.getElementById("prodCategory").value = data.category || "";
            document.getElementById("prodIcon").value     = data.icon || "";
            showToast("Mode edit produk.");
          });
          card.querySelector(".btn-delete").addEventListener("click", async () => {
            if (!confirm("Yakin hapus produk ini?")) return;
            try {
              await db.collection("products").doc(doc.id).delete();
              showToast("Produk dihapus.");
              loadProducts();
            } catch (e) {
              console.error(e);
              showToast("Gagal menghapus produk.");
            }
          });
          produkListEl.appendChild(card);
        });
      } catch (e) {
        console.error(e);
        produkListEl.innerHTML = "<p class='empty-text'>Gagal memuat produk.</p>";
      }
    }

    document.getElementById("btnResetProduct").addEventListener("click", () => {
      document.getElementById("prodIdEdit").value = "";
      document.getElementById("prodName").value = "";
      document.getElementById("prodPrice").value = "";
      document.getElementById("prodStock").value = "";
      document.getElementById("prodCategory").value = "";
      document.getElementById("prodIcon").value = "";
    });

    document.getElementById("btnSaveProduct").addEventListener("click", async () => {
      const idEdit  = document.getElementById("prodIdEdit").value.trim();
      const name    = document.getElementById("prodName").value.trim();
      const price   = parseInt(document.getElementById("prodPrice").value || "0", 10);
      const stock   = parseInt(document.getElementById("prodStock").value || "0", 10);
      const category= document.getElementById("prodCategory").value.trim();
      const icon    = document.getElementById("prodIcon").value.trim();

      if (!name) {
        showToast("Nama produk wajib diisi.");
        return;
      }

      const payload = {
        name,
        price: isNaN(price) ? 0 : price,
        stock: isNaN(stock) ? 0 : stock,
        category: category || "lainnya",
        icon: icon || "‚≠ê"
      };

      try {
        if (idEdit) {
          await db.collection("products").doc(idEdit).update(payload);
          showToast("Produk berhasil diupdate.");
        } else {
          await db.collection("products").add(payload);
          showToast("Produk baru ditambahkan.");
        }
        document.getElementById("btnResetProduct").click();
        loadProducts();
      } catch (e) {
        console.error(e);
        showToast("Gagal menyimpan produk.");
      }
    });

    // ---------- TOPUP ----------
    async function loadTopups() {
      topupListEl.innerHTML = "<p class='empty-text'>Memuat topup...</p>";
      try {
        const snap = await db.collection("topups")
          .orderBy("createdAt", "desc")
          .limit(50)
          .get();

        if (snap.empty) {
          topupListEl.innerHTML = "<p class='empty-text'>Belum ada permintaan topup.</p>";
          return;
        }

        topupListEl.innerHTML = "";
        snap.forEach(doc => {
          const data = doc.data();
          const amount = data.amount ?? data.nominal ?? 0;
          const method = data.method ?? data.metode ?? "-";
          const status = (data.status || "pending").toLowerCase();
          const userEmail = data.userEmail || "-";
          let tglText = "-";
          const ts = data.createdAt || data.tanggal;
          if (ts && ts.toDate) {
            const d = ts.toDate();
            tglText = d.toLocaleString("id-ID");
          }

          const card = document.createElement("div");
          card.className = "card";
          card.innerHTML = `
            <div class="pill">Topup - ${userEmail}</div>
            <div class="field-row">
              <label>Nominal</label>
              <div>${formatRupiah(amount)}</div>
            </div>
            <div class="field-row">
              <label>Metode</label>
              <div>${method}</div>
            </div>
            <div class="field-row">
              <label>Tanggal</label>
              <div>${tglText}</div>
            </div>
            <div class="field-row">
              <label>Status</label>
              <select class="status-select">
                <option value="pending">PENDING</option>
                <option value="success">SUCCESS</option>
                <option value="failed">FAILED</option>
              </select>
            </div>
            <button class="btn btn-primary btn-save">Simpan Status</button>
          `;

          const select = card.querySelector(".status-select");
          select.value = status;
          select.dataset.prevStatus = status;
          select.dataset.amount = amount;
          select.dataset.userId = data.userId || "";
          select.dataset.topupId = doc.id;

          card.querySelector(".btn-save").addEventListener("click", () => {
            saveTopupStatus(select);
          });

          topupListEl.appendChild(card);
        });
      } catch (e) {
        console.error(e);
        topupListEl.innerHTML = "<p class='empty-text'>Gagal memuat topup.</p>";
      }
    }

    async function saveTopupStatus(selectEl) {
      const newStatus  = selectEl.value;
      const prevStatus = selectEl.dataset.prevStatus || "pending";
      const amount     = parseInt(selectEl.dataset.amount || "0", 10);
      const userId     = selectEl.dataset.userId || "";
      const topupId    = selectEl.dataset.topupId;

      if (!topupId) {
        showToast("Data topup tidak valid.");
        return;
      }

      try {
        const topupRef = db.collection("topups").doc(topupId);

        if (newStatus === "success" && prevStatus !== "success" && userId && amount > 0) {
          // tambah saldo user satu kali saja
          const userRef = db.collection("users").doc(userId);
          await db.runTransaction(async (tx) => {
            const userSnap = await tx.get(userRef);
            const userData = userSnap.data() || {};
            const balance  = userData.balance || 0;
            tx.update(userRef, { balance: balance + amount });
            tx.update(topupRef, { status: newStatus });
          });
        } else {
          await topupRef.update({ status: newStatus });
        }

        selectEl.dataset.prevStatus = newStatus;
        showToast("Status topup disimpan.");
      } catch (e) {
        console.error(e);
        showToast("Gagal menyimpan status topup.");
      }
    }

    // ---------- SALDO USER ----------
    async function loadUserBalances() {
      userBalanceEl.innerHTML = "<p class='empty-text'>Memuat user...</p>";
      try {
        const snap = await db.collection("users").orderBy("email").get();
        if (snap.empty) {
          userBalanceEl.innerHTML = "<p class='empty-text'>Belum ada user.</p>";
          return;
        }
        userBalanceEl.innerHTML = "";
        snap.forEach(doc => {
          const data = doc.data();
          const bal  = data.balance || 0;
          const card = document.createElement("div");
          card.className = "card";
          card.innerHTML = `
            <div class="pill">${data.email || "(tanpa email)"}</div>
            <div class="field-row">
              <label>Saldo sekarang</label>
              <div>${formatRupiah(bal)}</div>
            </div>
            <div class="field-row">
              <label>Saldo baru</label>
              <input class="input-balance" type="number" value="${bal}">
            </div>
            <button class="btn btn-primary btn-save-balance">Simpan Saldo</button>
          `;
          const input = card.querySelector(".input-balance");
          card.querySelector(".btn-save-balance").addEventListener("click", async () => {
            const newBal = parseInt(input.value || "0", 10);
            try {
              await db.collection("users").doc(doc.id).update({ balance: isNaN(newBal) ? 0 : newBal });
              showToast("Saldo user diupdate.");
              loadUserBalances();
            } catch (e) {
              console.error(e);
              showToast("Gagal update saldo user.");
            }
          });
          userBalanceEl.appendChild(card);
        });
      } catch (e) {
        console.error(e);
        userBalanceEl.innerHTML = "<p class='empty-text'>Gagal memuat user.</p>";
      }
    }

    // ---------- ORDERS ----------
    async function loadOrders() {
      ordersListEl.innerHTML = "<p class='empty-text'>Memuat orders...</p>";
      try {
        const snap = await db.collection("orders")
          .orderBy("createdAt", "desc")
          .limit(50)
          .get();

        if (snap.empty) {
          ordersListEl.innerHTML = "<p class='empty-text'>Belum ada pesanan.</p>";
          return;
        }

        ordersListEl.innerHTML = "";
        snap.forEach(doc => {
          const data = doc.data();
          const status = (data.status || "pending").toLowerCase();
          let tglText = "-";
          const ts = data.createdAt;
          if (ts && ts.toDate) {
            tglText = ts.toDate().toLocaleString("id-ID");
          }

          const card = document.createElement("div");
          card.className = "card";

          let badgeClass = "pending";
          if (status === "success") badgeClass = "success";
          else if (status === "process") badgeClass = "process";

          card.innerHTML = `
            <div class="badge ${badgeClass}">${(data.productName || "Produk")} ¬∑ ${status.toUpperCase()}</div>
            <div class="field-row">
              <label>Tanggal</label>
              <div>${tglText}</div>
            </div>
            <div class="field-row">
              <label>Harga</label>
              <div>${formatRupiah(data.price || 0)}</div>
            </div>
            <div class="field-row">
              <label>Data user</label>
              <div>${data.dataOrder || "-"}</div>
            </div>
            <div class="field-row">
              <label>Status</label>
              <select class="order-status">
                <option value="pending">PENDING</option>
                <option value="process">PROCESS</option>
                <option value="success">SUCCESS</option>
                <option value="failed">FAILED</option>
              </select>
            </div>
            <div class="field-row">
              <label>Produk / Respon</label>
              <textarea class="order-admin">${data.adminProduct || ""}</textarea>
            </div>
            <button class="btn btn-primary btn-save-order">Simpan Perubahan</button>
            <button class="btn btn-danger btn-delete-order" style="margin-left:8px;">Hapus</button>
          `;

          const select = card.querySelector(".order-status");
          select.value = status;
          const adminInput = card.querySelector(".order-admin");

          card.querySelector(".btn-save-order").addEventListener("click", async () => {
            try {
              await db.collection("orders").doc(doc.id).update({
                status: select.value,
                adminProduct: adminInput.value
              });
              showToast("Order diupdate.");
              loadOrders();
            } catch (e) {
              console.error(e);
              showToast("Gagal menyimpan order.");
            }
          });

          card.querySelector(".btn-delete-order").addEventListener("click", async () => {
            if (!confirm("Yakin hapus pesanan ini?")) return;
            try {
              await db.collection("orders").doc(doc.id).delete();
              showToast("Order dihapus.");
              loadOrders();
            } catch (e) {
              console.error(e);
              showToast("Gagal menghapus order.");
            }
          });

          ordersListEl.appendChild(card);
        });
      } catch (e) {
        console.error(e);
        ordersListEl.innerHTML = "<p class='empty-text'>Gagal memuat pesanan.</p>";
      }
    }
  </script>
</body>
</html>
