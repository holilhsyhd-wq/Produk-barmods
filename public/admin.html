<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Panel Barmods</title>
  <style>
    body{
      margin:0;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:#020617;
      color:#e5e7eb;
    }
    header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:12px 14px;
      background:#020617;
      border-bottom:1px solid #1f2937;
    }
    header h1{
      font-size:16px;
      margin:0;
      font-weight:700;
    }
    .btn-logout{
      background:#dc2626;
      border:none;
      color:white;
      padding:8px 12px;
      border-radius:999px;
      font-size:12px;
      font-weight:600;
      cursor:pointer;
    }

    .tabs{
      display:flex;
      border-bottom:1px solid #1f2937;
      background:#020617;
    }
    .tab-btn{
      flex:1;
      text-align:center;
      padding:10px 0;
      font-size:13px;
      border:none;
      background:none;
      color:#9ca3af;
      cursor:pointer;
    }
    .tab-btn.active{
      color:#2563eb;
      border-bottom:2px solid #2563eb;
      font-weight:600;
    }

    .section{
      display:none;
      padding:10px;
    }
    .section.active{
      display:block;
    }

    .card{
      background:#0f172a;
      border-radius:12px;
      border:1px solid #1f2937;
      padding:10px;
      margin-top:8px;
      box-shadow:0 0 10px rgba(0,0,0,0.4);
      font-size:13px;
    }
    .title{
      font-weight:600;
      margin-bottom:4px;
    }
    .label{
      font-size:11px;
      color:#9ca3af;
      margin-top:4px;
    }
    .value{
      font-size:13px;
      margin-top:2px;
      word-break:break-word;
    }

    .status-pill{
      display:inline-block;
      padding:2px 8px;
      border-radius:999px;
      font-size:11px;
      margin-top:4px;
    }
    .st-pending{background:#facc15;color:#111827;}
    .st-process{background:#60a5fa;color:#111827;}
    .st-success{background:#22c55e;color:#052e16;}

    .form-row{
      margin-bottom:6px;
    }
    .form-row label{
      font-size:11px;
      color:#9ca3af;
      display:block;
      margin-bottom:2px;
    }
    .input, select, textarea{
      width:100%;
      padding:8px;
      border-radius:8px;
      border:1px solid #1f2937;
      background:#020617;
      color:#e5e7eb;
      font-size:13px;
      box-sizing:border-box;
    }
    textarea{
      min-height:60px;
      resize:vertical;
    }

    .btn{
      border:none;
      border-radius:999px;
      padding:8px 12px;
      font-size:12px;
      font-weight:600;
      cursor:pointer;
      margin-right:6px;
      margin-top:6px;
    }
    .btn-primary{background:#2563eb;color:white;}
    .btn-secondary{background:#1f2937;color:#e5e7eb;}
    .btn-success{background:#16a34a;color:white;}
    .btn-danger{background:#dc2626;color:white;}

    .small{
      font-size:11px;
      color:#9ca3af;
      margin-top:2px;
    }
  </style>
</head>
<body>

<header>
  <h1>Admin Panel Barmods</h1>
  <button class="btn-logout" onclick="logoutAdmin()">Logout Admin</button>
</header>

<div class="tabs">
  <button class="tab-btn active" data-tab="produk">Produk</button>
  <button class="tab-btn" data-tab="topup">Topup</button>
  <button class="tab-btn" data-tab="saldo">Saldo User</button>
  <button class="tab-btn" data-tab="orders">Orders</button>
</div>

<!-- ========== SECTION PRODUK ========== -->
<section id="tab-produk" class="section active">
  <div class="card">
    <div class="title">Tambah / Edit Produk</div>
    <div class="form-row">
      <label>Nama produk</label>
      <input id="p-name" class="input" placeholder="Nama produk">
    </div>
    <div class="form-row">
      <label>Harga (angka, contoh: 6000)</label>
      <input id="p-price" class="input" type="number" min="0" placeholder="6000">
      <div class="small">Harga akan ditampilkan sebagai Rupiah otomatis.</div>
    </div>
    <div class="form-row">
      <label>Stock</label>
      <input id="p-stock" class="input" type="number" min="0" placeholder="Stock">
    </div>
    <div class="form-row">
      <label>Kategori (premium / sosmed / panel)</label>
      <input id="p-category" class="input" placeholder="premium / sosmed / panel">
    </div>
    <div class="form-row">
      <label>Icon (emoji, opsional)</label>
      <input id="p-icon" class="input" placeholder="Contoh: ðŸ”¥">
    </div>
    <div class="small" id="productMode">Mode: tambah baru</div>
    <button class="btn btn-primary" onclick="saveProduct()">Simpan Produk</button>
    <button class="btn btn-secondary" onclick="resetProductForm()">Reset Form</button>
  </div>

  <div id="productList" class="small" style="margin-top:10px;">Memuat produk...</div>
</section>

<!-- ========== SECTION TOPUP ========== -->
<section id="tab-topup" class="section">
  <div id="topupList" class="small">Memuat topup...</div>
</section>

<!-- ========== SECTION SALDO USER ========== -->
<section id="tab-saldo" class="section">
  <div id="userList" class="small">Memuat user...</div>
</section>

<!-- ========== SECTION ORDERS ========== -->
<section id="tab-orders" class="section">
  <div id="orderList" class="small">Memuat orders...</div>
</section>

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

<script>
/* ================== INIT & CONFIG ================== */
const firebaseConfig = {
  apiKey: "AIzaSyBpsfDmupS9wq-iNge5aYvknmw5bSryd3A",
  authDomain: "toko-barmods.firebaseapp.com",
  projectId: "toko-barmods",
  storageBucket: "toko-barmods.appspot.com",
  messagingSenderId: "284047189012",
  appId: "1:284047189012:web:6ef0c6891adab08a383301"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* ====== ADMIN GUARD (LOCALSTORAGE) ====== */
if (localStorage.getItem("adminLoggedIn") !== "true") {
  window.location.href = "login-admin.html";
}

/* ====== HELPER ====== */
function logoutAdmin(){
  localStorage.removeItem("adminLoggedIn");
  window.location.href = "login-admin.html";
}

function rupiah(n){
  n = Number(n || 0);
  return "Rp " + n.toLocaleString("id-ID");
}

function getMillis(createdAt){
  if(!createdAt) return 0;
  if(typeof createdAt.toMillis === "function") return createdAt.toMillis();
  if(typeof createdAt.toDate === "function") return createdAt.toDate().getTime();
  if(typeof createdAt === "number") return createdAt;
  if(typeof createdAt === "string"){
    const d = new Date(createdAt);
    if(!isNaN(d.getTime())) return d.getTime();
  }
  return 0;
}

/* ================== TABS ================== */
document.querySelectorAll(".tab-btn").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    document.querySelectorAll(".tab-btn").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    const tab = btn.getAttribute("data-tab");
    document.querySelectorAll(".section").forEach(sec=>sec.classList.remove("active"));
    document.getElementById("tab-"+tab).classList.add("active");
  });
});

/* ================== PRODUK ================== */
let editProductId = null;

function resetProductForm(){
  editProductId = null;
  document.getElementById("p-name").value = "";
  document.getElementById("p-price").value = "";
  document.getElementById("p-stock").value = "";
  document.getElementById("p-category").value = "";
  document.getElementById("p-icon").value = "";
  document.getElementById("productMode").textContent = "Mode: tambah baru";
}

function saveProduct(){
  const name = document.getElementById("p-name").value.trim();
  const price = Number(document.getElementById("p-price").value || 0);
  const stock = Number(document.getElementById("p-stock").value || 0);
  const category = document.getElementById("p-category").value.trim();
  const icon = document.getElementById("p-icon").value.trim();

  if(!name || !category){
    alert("Nama & kategori wajib diisi");
    return;
  }

  const data = { name, price, stock, category, icon };
  if(editProductId){
    db.collection("products").doc(editProductId).update(data)
      .then(()=>{ alert("Produk diupdate"); resetProductForm(); })
      .catch(err=>alert("Gagal update: "+err.message));
  } else {
    // bikin id sederhana: timestamp
    data.createdAt = firebase.firestore.FieldValue.serverTimestamp();
    db.collection("products").add(data)
      .then(()=>{ alert("Produk ditambah"); resetProductForm(); })
      .catch(err=>alert("Gagal tambah: "+err.message));
  }
}

function loadProducts(){
  const list = document.getElementById("productList");
  list.innerHTML = "Memuat produk...";

  db.collection("products").orderBy("name").onSnapshot(snap=>{
    if(snap.empty){
      list.innerHTML = "Belum ada produk.";
      return;
    }
    let html = "";
    snap.forEach(doc=>{
      const p = doc.data();
      html += `
        <div class="card">
          <div class="title">${p.icon || ""} ${p.name || "(tanpa nama)"}</div>
          <div class="label">Harga</div>
          <div class="value">${rupiah(p.price || 0)}</div>
          <div class="label">Stock</div>
          <div class="value">${p.stock || 0}</div>
          <div class="label">Kategori</div>
          <div class="value">${p.category || "-"}</div>
          <button class="btn btn-secondary" onclick="editProduct('${doc.id}')">Edit</button>
          <button class="btn btn-danger" onclick="deleteProduct('${doc.id}')">Hapus</button>
        </div>
      `;
    });
    list.innerHTML = html;
  }, err=>{
    list.innerHTML = "Gagal memuat produk: "+err.message;
  });
}

function editProduct(id){
  db.collection("products").doc(id).get().then(doc=>{
    if(!doc.exists) return;
    const p = doc.data();
    editProductId = id;
    document.getElementById("p-name").value = p.name || "";
    document.getElementById("p-price").value = p.price || "";
    document.getElementById("p-stock").value = p.stock || "";
    document.getElementById("p-category").value = p.category || "";
    document.getElementById("p-icon").value = p.icon || "";
    document.getElementById("productMode").textContent = "Mode: edit produk";
    window.scrollTo({top:0,behavior:"smooth"});
  });
}

function deleteProduct(id){
  if(!confirm("Hapus produk ini?")) return;
  db.collection("products").doc(id).delete()
    .catch(err=>alert("Gagal hapus: "+err.message));
}

/* ================== TOPUP ================== */
function loadTopups(){
  const list = document.getElementById("topupList");
  list.innerHTML = "Memuat topup...";

  db.collection("topups").orderBy("createdAt","desc").onSnapshot(snap=>{
    if(snap.empty){
      list.innerHTML = "Belum ada request topup.";
      return;
    }
    let html = "";
    snap.forEach(doc=>{
      const t = doc.data();
      const nominal = Number(t.nominal || 0);
      const status = t.status || "pending";
      let stClass="st-pending";
      if(status==="process") stClass="st-process";
      if(status==="success") stClass="st-success";

      let tgl="-";
      if(t.createdAt){
        if(typeof t.createdAt.toDate==="function") tgl=t.createdAt.toDate().toLocaleString("id-ID");
      }

      html += `
        <div class="card">
          <div class="title">Topup ${rupiah(nominal)}</div>
          <div class="status-pill ${stClass}">${status.toUpperCase()}</div>
          <div class="label">UserID</div>
          <div class="value">${t.userId || "-"}</div>
          <div class="label">Pengirim DANA</div>
          <div class="value">${t.dana || "-"}</div>
          <div class="label">Tanggal</div>
          <div class="value">${tgl}</div>
          <button class="btn btn-secondary" onclick="processTopup('${doc.id}')">Process</button>
          <button class="btn btn-success" onclick="successTopup('${doc.id}')">Success (+saldo)</button>
          <button class="btn btn-danger" onclick="deleteTopup('${doc.id}')">Hapus</button>
        </div>
      `;
    });
    list.innerHTML = html;
  }, err=>{
    list.innerHTML = "Gagal memuat topup: "+err.message;
  });
}

function processTopup(id){
  db.collection("topups").doc(id).update({status:"process"})
    .catch(err=>alert("Gagal update: "+err.message));
}

function successTopup(id){
  if(!confirm("Set topup ini menjadi SUCCESS dan tambah saldo user?")) return;

  db.collection("topups").doc(id).get().then(doc=>{
    if(!doc.exists){alert("Topup tidak ditemukan");return;}
    const t = doc.data();
    const userId = t.userId;
    const nominal = Number(t.nominal || 0);
    if(!userId || !nominal){
      alert("Data user/nominal tidak valid");
      return;
    }

    const userRef = db.collection("users").doc(userId);
    const topupRef = db.collection("topups").doc(id);

    return db.runTransaction(async tx=>{
      const userSnap = await tx.get(userRef);
      if(!userSnap.exists) throw new Error("User tidak ditemukan");
      const curr = Number(userSnap.data().balance || 0);
      tx.update(userRef,{balance: curr + nominal});
      tx.update(topupRef,{status:"success"});
    });
  }).then(()=>{
    alert("Topup success dan saldo ditambahkan.");
  }).catch(err=>{
    if(err) alert("Gagal proses: "+err.message);
  });
}

function deleteTopup(id){
  if(!confirm("Hapus data topup ini?")) return;
  db.collection("topups").doc(id).delete().catch(err=>alert("Gagal hapus: "+err.message));
}

/* ================== SALDO USER ================== */
function loadUsers(){
  const list = document.getElementById("userList");
  list.innerHTML = "Memuat user...";

  db.collection("users").orderBy("email").onSnapshot(snap=>{
    if(snap.empty){
      list.innerHTML = "Belum ada user.";
      return;
    }
    let html="";
    snap.forEach(doc=>{
      const u = doc.data();
      html += `
        <div class="card">
          <div class="title">${u.username || "(tanpa username)"} </div>
          <div class="label">Email</div>
          <div class="value">${u.email || "-"}</div>
          <div class="label">No HP</div>
          <div class="value">${u.phone || "-"}</div>
          <div class="label">Saldo</div>
          <input id="saldo-${doc.id}" class="input" type="number" value="${Number(u.balance||0)}">
          <button class="btn btn-primary" onclick="updateSaldoUser('${doc.id}')">Simpan Saldo</button>
        </div>
      `;
    });
    list.innerHTML = html;
  }, err=>{
    list.innerHTML = "Gagal memuat user: "+err.message;
  });
}

function updateSaldoUser(id){
  const val = Number(document.getElementById("saldo-"+id).value || 0);
  db.collection("users").doc(id).update({balance:val})
    .then(()=>alert("Saldo diupdate"))
    .catch(err=>alert("Gagal update: "+err.message));
}

/* ================== ORDERS ================== */
function loadOrders(){
  const list = document.getElementById("orderList");
  list.innerHTML = "Memuat orders...";

  db.collection("orders").orderBy("createdAt","desc").onSnapshot(snap=>{
    if(snap.empty){
      list.innerHTML = "Belum ada orders.";
      return;
    }
    let html = "";
    snap.forEach(doc=>{
      const o = doc.data();
      const harga = Number(o.price || 0);
      const status = o.status || "pending";
      let stClass="st-pending";
      if(status==="process") stClass="st-process";
      if(status==="success") stClass="st-success";

      let tgl="-";
      if(o.createdAt && typeof o.createdAt.toDate==="function"){
        tgl = o.createdAt.toDate().toLocaleString("id-ID");
      }

      html += `
        <div class="card">
          <div class="title">${o.productName || "(tanpa nama)"}</div>
          <div class="status-pill ${stClass}">${status.toUpperCase()}</div>

          <div class="label">UserID</div>
          <div class="value">${o.userId || "-"}</div>

          <div class="label">Harga</div>
          <div class="value">${rupiah(harga)}</div>

          <div class="label">Tanggal</div>
          <div class="value">${tgl}</div>

          <div class="label">Input User</div>
          <div class="value">${o.inputUser || "-"}</div>

          <div class="label">Status</div>
          <select id="status-${doc.id}" class="input">
            <option value="pending" ${status==="pending"?"selected":""}>pending</option>
            <option value="process" ${status==="process"?"selected":""}>process</option>
            <option value="success" ${status==="success"?"selected":""}>success</option>
          </select>

          <div class="label">Produk / Respon Admin</div>
          <textarea id="adminprod-${doc.id}">${o.adminProduct || ""}</textarea>

          <button class="btn btn-primary" onclick="updateOrder('${doc.id}')">Simpan Perubahan</button>
          <button class="btn btn-danger" onclick="deleteOrder('${doc.id}')">Hapus</button>
        </div>
      `;
    });
    list.innerHTML = html;
  }, err=>{
    list.innerHTML = "Gagal memuat orders: "+err.message;
  });
}

function updateOrder(id){
  const status = document.getElementById("status-"+id).value;
  const adminProduct = document.getElementById("adminprod-"+id).value;
  db.collection("orders").doc(id).update({status, adminProduct})
    .then(()=>alert("Order diupdate"))
    .catch(err=>alert("Gagal update: "+err.message));
}

function deleteOrder(id){
  if(!confirm("Hapus order ini?")) return;
  db.collection("orders").doc(id).delete()
    .catch(err=>alert("Gagal hapus: "+err.message));
}

/* ================== START ================== */
window.addEventListener("load", ()=>{
  try{
    loadProducts();
    loadTopups();
    loadUsers();
    loadOrders();
  }catch(e){
    console.error(e);
  }
});
</script>

</body>
</html>
