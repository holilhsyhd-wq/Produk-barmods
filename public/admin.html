<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Admin - Barmods Digital Store</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

<style>
body {
  margin:0;
  background:#0f172a;
  color:white;
  font-family:Arial;
}

nav {
  background:#1e293b;
  padding:12px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  border-bottom:1px solid rgba(255,255,255,.1);
}

nav .menu button {
  margin-left:6px;
  padding:8px 14px;
  background:#334155;
  border:none;
  color:white;
  border-radius:6px;
}

.card {
  background:#1e293b;
  margin:20px;
  padding:20px;
  border-radius:12px;
  border:1px solid rgba(255,255,255,.15);
}

input, select {
  width:100%;
  padding:10px;
  margin-top:8px;
  border-radius:6px;
  border:1px solid #334155;
  background:#0f172a;
  color:white;
}

table {
  width:100%;
  margin-top:10px;
  border-collapse:collapse;
}

th, td {
  padding:10px;
  border-bottom:1px solid rgba(255,255,255,.1);
}

button.action {
  background:#3b82f6;
  border:none;
  padding:6px 10px;
  margin:2px;
  border-radius:6px;
  color:white;
}

button.danger {
  background:#ef4444;
}
</style>
</head>
<body>

<!-- CEK LOGIN ADMIN -->
<script>
if(localStorage.getItem("adminLogged") !== "true"){
  window.location.href = "login-admin.html";
}
</script>

<nav>
  <div><b>Panel Admin — Barmods Digital Store</b></div>
  <div class="menu">
    <button onclick="showPage('produk')">Produk</button>
    <button onclick="showPage('saldo')">Saldo Pengguna</button>
    <button onclick="showPage('topup')">Topup</button>
    <button onclick="showPage('orders')">Pesanan</button>
    <button class="danger" onclick="logoutAdmin()">Logout</button>
  </div>
</nav>

<script>
function logoutAdmin(){
  localStorage.removeItem("adminLogged");
  window.location.href = "login-admin.html";
}
</script>

<!-- HALAMAN ADMIN -->
<div id="content"></div>

<script>
// ** Firebase Config **
const firebaseConfig = {
  apiKey: "AIzaSyD0BMCSL9cDOOlMiaSyARzc_JrUqibHIBg",
  authDomain: "toko-barmods.firebaseapp.com",
  projectId: "toko-barmods",
  storageBucket: "toko-barmods.appspot.com",
  messagingSenderId: "225431835852",
  appId: "1:225431835852:web:92e06d8f39b97f4745a1a4"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
</script>

<script>
function showPage(page){
  if(page === "produk"){ loadProduk(); }
  if(page === "saldo"){ loadSaldo(); }
  if(page === "topup"){ loadTopup(); }
  if(page === "orders"){ loadOrders(); }
}
</script>

<!-- ===================================== -->
<!-- PRODUK -->
<!-- ===================================== -->
<script>
function loadProduk(){
  db.collection("products")
    .orderBy("id")
    .get()
    .then(snap => {
      let html = `
      <div class='card'>
        <h2>Daftar Produk</h2>
        <table>
        <tr><th>ID</th><th>Nama</th><th>Harga</th><th>Stok</th><th>Aksi</th></tr>
      `;
      snap.forEach(doc => {
        let p = doc.data();
        html += `
          <tr>
            <td>${p.id}</td>
            <td><input id="name-${doc.id}" value="${p.name}"></td>
            <td><input id="price-${doc.id}" value="${p.price}"></td>
            <td><input id="stock-${doc.id}" value="${p.stock}"></td>
            <td>
              <button class="action" onclick="saveProduk('${doc.id}')">Simpan</button>
            </td>
          </tr>
        `;
      });
      html += `</table></div>`;
      document.getElementById("content").innerHTML = html;
    });
}

function saveProduk(docId){
  db.collection("products").doc(docId).update({
    name: document.getElementById(`name-${docId}`).value,
    price: document.getElementById(`price-${docId}`).value,
    stock: Number(document.getElementById(`stock-${docId}`).value)
  });
  alert("Berhasil disimpan!");
}
</script>

<!-- ===================================== -->
<!-- SALDO PENGGUNA -->
<!-- ===================================== -->
<script>
function loadSaldo(){
  db.collection("users").get().then(snap=>{
    let html = `
    <div class='card'>
      <h2>Saldo Pengguna</h2>
      <table>
      <tr><th>Email</th><th>Saldo</th><th>Aksi</th></tr>
    `;
    snap.forEach(doc=>{
      let u = doc.data();
      html += `
        <tr>
          <td>${doc.id}</td>
          <td><input id="saldo-${doc.id}" value="${u.saldo || 0}"></td>
          <td><button class="action" onclick="saveSaldo('${doc.id}')">Simpan</button></td>
        </tr>
      `;
    });
    html += `</table></div>`;
    document.getElementById("content").innerHTML = html;
  });
}

function saveSaldo(email){
  db.collection("users").doc(email).update({
    saldo: Number(document.getElementById(`saldo-${email}`).value)
  });
  alert("Saldo disimpan!");
}
</script>

<!-- ===================================== -->
<!-- TOPUP -->
<!-- ===================================== -->
<script>
function loadTopup(){
  db.collection("topups")
    .orderBy("time","desc")
    .get()
    .then(snap=>{
      let html = `
      <div class='card'>
        <h2>Permintaan Topup</h2>
        <table>
        <tr><th>Email</th><th>Nominal</th><th>DANA</th><th>Status</th><th>Aksi</th></tr>
      `;
      snap.forEach(doc=>{
        let t = doc.data();
        html += `
          <tr>
            <td>${t.email}</td>
            <td>${t.nominal}</td>
            <td>${t.dana}</td>
            <td>${t.status}</td>
            <td>
              <button class="action" onclick="setTopupStatus('${doc.id}','sukses')">✔</button>
              <button class="danger action" onclick="setTopupStatus('${doc.id}','error')">✖</button>
            </td>
          </tr>
        `;
      });
      html += `</table></div>`;
      document.getElementById("content").innerHTML = html;
    });
}

function setTopupStatus(id, status){
  db.collection("topups").doc(id).get().then(doc=>{
    let t = doc.data();
    if(status === "sukses"){
      db.collection("users").doc(t.email).update({
        saldo: firebase.firestore.FieldValue.increment(t.nominal)
      });
    }
    db.collection("topups").doc(id).update({status});
    alert("Topup diperbarui!");
    loadTopup();
  });
}
</script>

<!-- ===================================== -->
<!-- PESANAN -->
<!-- ===================================== -->
<script>
function loadOrders(){
  db.collection("orders")
    .orderBy("time","desc")
    .get()
    .then(snap=>{
      let html = `
      <div class='card'>
        <h2>Pesanan Pengguna</h2>
        <table>
        <tr><th>Email</th><th>Produk</th><th>Status</th><th>Produk Admin</th><th>Aksi</th></tr>
      `;
      snap.forEach(doc=>{
        let o = doc.data();
        html += `
          <tr>
            <td>${o.email}</td>
            <td>${o.productName}</td>
            <td>${o.status}</td>
            <td><input id="send-${doc.id}" value="${o.adminSend || ''}"></td>
            <td>
              <button class="action" onclick="updateOrder('${doc.id}','proses')">Proses</button>
              <button class="action" onclick="updateOrder('${doc.id}','sukses')">Sukses</button>
              <button class="danger action" onclick="updateOrder('${doc.id}','error')">Error</button>
            </td>
          </tr>
        `;
      });
      html += `</table></div>`;
      document.getElementById("content").innerHTML = html;
    });
}

function updateOrder(id, status){
  let sendData = document.getElementById(`send-${id}`).value;

  db.collection("orders").doc(id).update({
    status: status,
    adminSend: sendData
  });

  alert("Pesanan diperbarui!");
  loadOrders();
}
</script>

<script>
showPage("produk");
</script>

</body>
</html>
