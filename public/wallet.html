<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Wallet ‚Äî Barmods Digital Store</title>

<style>
*{
  margin:0;
  padding:0;
  box-sizing:border-box;
  font-family:Arial;
}
body{
  background:#ffffff;
  padding-bottom:70px;
}

/* HEADER */
.header{
  background:#1565c0;
  color:white;
  padding:20px;
  text-align:center;
  font-size:22px;
  font-weight:bold;
  box-shadow:0 4px 12px rgba(0,0,0,.25);
}

/* BALANCE BOX */
.balance-box{
  margin:18px;
  background:#e3f2fd;
  padding:18px;
  border-radius:14px;
  border:1px solid #90caf9;
  text-align:center;
}
.balance-box h2{
  color:#0d47a1;
  font-size:20px;
}
.balance-box span{
  font-size:28px;
  font-weight:bold;
  color:#2e7d32;
}

/* FORM TOPUP */
.form-box{
  margin:18px;
  padding:18px;
  background:#f5f5f5;
  border-radius:14px;
  border:1px solid #ddd;
}
.input{
  width:100%;
  padding:12px;
  border-radius:10px;
  border:1px solid #ccc;
  margin-bottom:12px;
}
.btn{
  width:100%;
  padding:12px;
  background:#0d47a1;
  color:white;
  border:none;
  border-radius:10px;
  cursor:pointer;
  font-size:16px;
}

/* RIWAYAT */
.title{
  margin:20px 18px 10px;
  font-size:18px;
  font-weight:bold;
  color:#0d47a1;
}
.history{
  margin:0 18px 18px;
}
.item{
  background:#fafafa;
  border:1px solid #ddd;
  padding:14px;
  border-radius:12px;
  margin-bottom:12px;
}
.status{
  padding:6px 10px;
  border-radius:8px;
  font-size:12px;
  color:white;
  display:inline-block;
}
.pending{ background:#ff9800; }
.proses{ background:#0288d1; }
.sukses{ background:#2e7d32; }
.error{ background:#c62828; }

/* NAVBAR */
.navbar{
  position:fixed;
  bottom:0;
  left:0;
  right:0;
  height:65px;
  background:#0d47a1;
  color:white;
  display:flex;
  justify-content:space-around;
  align-items:center;
  box-shadow:0 -4px 12px rgba(0,0,0,0.25);
}
.nav-btn{
  text-align:center;
  font-size:13px;
  cursor:pointer;
}
.nav-btn span{
  display:block;
  font-size:20px;
}
</style>
</head>

<body>

<div class="header">Dompet Digital</div>

<!-- SALDO -->
<div class="balance-box">
  <h2>Saldo Anda</h2>
  <span id="saldoText">Rp 0</span>
</div>

<!-- FORM TOPUP -->
<div class="form-box">
  <h3 style="margin-bottom:10px;color:#0d47a1;font-size:17px;">Top Up Saldo</h3>

  <input class="input" id="amount" type="number" placeholder="Nominal (contoh: 5000)">
  <input class="input" id="dana" type="text" placeholder="Nomor Dana Anda">

  <button class="btn" onclick="requestTopup()">Kirim Permintaan Topup</button>
</div>

<!-- RIWAYAT -->
<div class="title">Riwayat Topup</div>
<div id="history" class="history"></div>

<!-- NAVBAR -->
<div class="navbar">
  <div class="nav-btn" onclick="go('index.html')"><span>üè†</span>Home</div>
  <div class="nav-btn" onclick="go('wallet.html')"><span>üí≥</span>Wallet</div>
  <div class="nav-btn" onclick="go('orders.html')"><span>üì¶</span>Pesanan</div>
  <div class="nav-btn" onclick="go('profile.html')"><span>üë§</span>Profil</div>
</div>

<!-- FIREBASE SCRIPT -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
import {
  getFirestore, collection, addDoc, getDocs, doc, getDoc, query, where, orderBy
} from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";
import {
  getAuth, onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";

/* CONFIG */
const firebaseConfig = {
  apiKey: "AIzaSyBpsfDmupS9wq-iNge5aYvknmw5bSryd3A",
  authDomain: "toko-barmods.firebaseapp.com",
  projectId: "toko-barmods",
  storageBucket: "toko-barmods.firebasestorage.app",
  messagingSenderId: "284047189012",
  appId: "1:284047189012:web:6ef0c6891adab08a383301"
};

const app = initializeApp(firebaseConfig);
const db  = getFirestore(app);
const auth = getAuth(app);

let currentUser = null;

function go(x){ window.location.href=x; }

/* SAAT LOGIN */
onAuthStateChanged(auth, async (user)=>{
  if(!user){ window.location.href="login.html"; return; }
  currentUser = user;

  loadSaldo();
  loadHistory();
});

/* LOAD SALDO */
async function loadSaldo(){
  const ref = doc(db, "users", currentUser.uid);
  const snap = await getDoc(ref);

  let saldo = 0;
  if(snap.exists()) saldo = snap.data().balance || 0;

  document.getElementById("saldoText").innerText =
    "Rp " + saldo.toLocaleString("id-ID");
}

/* REQUEST TOPUP */
window.requestTopup = async function(){
  const amount = Number(document.getElementById("amount").value);
  const dana   = document.getElementById("dana").value.trim();

  if(amount <= 0 || !dana){
    alert("Nominal dan nomor DANA wajib diisi!");
    return;
  }

  await addDoc(collection(db, "topups"), {
    userId: currentUser.uid,
    userEmail: currentUser.email,
    amount: amount,
    danaNumber: dana,
    status: "pending",
    createdAt: new Date()
  });

  alert("Permintaan topup terkirim!");
  document.getElementById("amount").value = "";
  document.getElementById("dana").value = "";

  loadHistory();
};

/* LOAD RIWAYAT */
async function loadHistory(){
  const list = document.getElementById("history");
  list.innerHTML = "Memuat...";

  const q = query(
    collection(db, "topups"),
    where("userId", "==", currentUser.uid),
    orderBy("createdAt", "desc")
  );
  const snap = await getDocs(q);

  list.innerHTML = "";

  if(snap.empty){
    list.innerHTML = "<div style='color:#777;'>Belum ada riwayat topup.</div>";
    return;
  }

  snap.forEach(d=>{
    const t = d.data();

    let statusClass = t.status;
    if(!statusClass) statusClass = "pending";

    let waktu = "-";
    if(t.createdAt?.toDate){
      waktu = t.createdAt.toDate().toLocaleString();
    }

    const div = document.createElement("div");
    div.className = "item";
    div.innerHTML = `
      <div><b>Rp ${Number(t.amount).toLocaleString("id-ID")}</b></div>
      <div style="color:#444">${waktu}</div>
      <div class="status ${statusClass}">${t.status}</div>
    `;
    list.appendChild(div);
  });
}
</script>

</body>
</html>
