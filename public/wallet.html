<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Dompet Digital ‚Äî Barmods Digital Store</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --blue: #0052cc;
      --blue-soft: #e6f0ff;
      --gray-bg: #f5f5f5;
      --text: #222;
      --text-soft: #777;
      --green: #0a9f4a;
      --card-radius: 18px;
      --danger: #dc2626;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont,"Segoe UI",sans-serif;
      background: var(--gray-bg);
      color: var(--text);
    }

    header {
      background: var(--blue);
      color: #fff;
      padding: 14px 16px 18px;
      text-align: center;
      font-weight: 600;
      font-size: 18px;
      position: sticky;
      top: 0;
      z-index: 20;
    }

    .top-nav {
      background:#fff;
      display:flex;
      justify-content:center;
      gap:8px;
      padding:10px 8px;
      box-shadow:0 1px 3px rgba(0,0,0,.06);
      position:sticky;
      top:54px;
      z-index:19;
    }
    .top-nav button{
      border:none;
      padding:8px 16px;
      border-radius:999px;
      background:#eef1ff;
      color:#334;
      font-size:14px;
      cursor:pointer;
    }
    .top-nav button.active{
      background:var(--blue);
      color:#fff;
    }

    main{
      max-width:900px;
      margin:0 auto;
      padding:16px 12px 80px;
    }

    .card{
      background:#fff;
      border-radius:var(--card-radius);
      padding:16px 16px 14px;
      box-shadow:0 2px 6px rgba(0,0,0,.06);
      margin-bottom:12px;
    }

    .saldo-label{
      font-size:14px;
      color:var(--text-soft);
      margin-bottom:4px;
    }
    .saldo-value{
      font-size:26px;
      font-weight:700;
      color:var(--green);
    }

    .section-title{
      font-weight:600;
      margin-bottom:8px;
      font-size:16px;
    }
    .section-sub{
      font-size:13px;
      color:var(--text-soft);
      margin-bottom:12px;
    }

    .form-group{
      margin-bottom:10px;
    }
    .form-label{
      font-size:13px;
      margin-bottom:4px;
      display:block;
    }
    input{
      width:100%;
      border-radius:10px;
      border:1px solid #d4d4d4;
      padding:10px 12px;
      font-size:14px;
    }
    input:focus{
      outline:none;
      border-color:var(--blue);
      box-shadow:0 0 0 1px var(--blue-soft);
    }

    .btn-primary{
      width:100%;
      border:none;
      border-radius:999px;
      padding:11px 16px;
      background:var(--blue);
      color:#fff;
      font-size:15px;
      font-weight:500;
      cursor:pointer;
      margin-top:6px;
    }

    .history-list{
      font-size:13px;
    }
    .history-item{
      padding:8px 0;
      border-bottom:1px solid #eee;
    }
    .history-item:last-child{
      border-bottom:none;
    }
    .history-row-top{
      display:flex;
      justify-content:space-between;
      margin-bottom:2px;
    }
    .history-amount{
      font-weight:600;
    }
    .history-status{
      font-size:12px;
      padding:2px 8px;
      border-radius:999px;
      text-transform:capitalize;
    }
    .status-pending{ background:#fef3c7; color:#92400e; }
    .status-proses{ background:#dbeafe; color:#1d4ed8; }
    .status-sukses{ background:#dcfce7; color:#15803d; }
    .status-error{ background:#fee2e2; color:#b91c1c; }

    .bottom-nav{
      position:fixed;
      bottom:0;left:0;right:0;
      background:#fff;
      border-top:1px solid #e4e4e4;
      display:flex;
      justify-content:space-around;
      padding:6px 0 8px;
      z-index:30;
    }
    .bottom-nav button{
      background:none;
      border:none;
      font-size:11px;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:4px;
      color:#555;
      cursor:pointer;
    }
    .bottom-nav button span.icon{ font-size:20px; }
    .bottom-nav button.active{ color:var(--blue); }

    .error-msg{
      font-size:13px;
      color:var(--danger);
      margin-top:4px;
    }
  </style>
</head>
<body>
  <header>Dompet Digital</header>

  <nav class="top-nav">
    <button id="nav-home" type="button">Home</button>
    <button id="nav-wallet" class="active" type="button">Wallet</button>
    <button id="nav-orders" type="button">Pesanan</button>
    <button id="nav-profile" type="button">Profil</button>
  </nav>

  <main>
    <!-- Saldo -->
    <div class="card">
      <div class="section-title">Saldo Anda</div>
      <div class="saldo-label" id="wallet-email"></div>
      <div class="saldo-value" id="wallet-saldo">Rp 0</div>
      <div id="wallet-error" class="error-msg"></div>
    </div>

    <!-- Form topup -->
    <div class="card">
      <div class="section-title">Top Up Saldo</div>
      <div class="section-sub">
        Masukkan nominal dan nomor DANA kamu. Admin akan memproses permintaan dan menambah saldo setelah pembayaran dicek.
      </div>
      <div class="form-group">
        <label class="form-label" for="topup-amount">Nominal (contoh: 5000)</label>
        <input id="topup-amount" type="number" placeholder="Nominal dalam rupiah" />
      </div>
      <div class="form-group">
        <label class="form-label" for="topup-dana">Nomor DANA Anda</label>
        <input id="topup-dana" type="text" placeholder="08xxxxxxxxxx" />
      </div>
      <button id="btn-topup" class="btn-primary" type="button">
        Kirim Permintaan Topup
      </button>
      <div id="topup-msg" class="error-msg"></div>
    </div>

    <!-- Riwayat topup -->
    <div class="card">
      <div class="section-title">Riwayat Topup</div>
      <div id="topup-history" class="history-list">Memuat...</div>
    </div>
  </main>

  <nav class="bottom-nav">
    <button id="bottom-home" type="button">
      <span class="icon">üè†</span>
      Home
    </button>
    <button id="bottom-wallet" class="active" type="button">
      <span class="icon">üí≥</span>
      Wallet
    </button>
    <button id="bottom-orders" type="button">
      <span class="icon">üì¶</span>
      Pesanan
    </button>
    <button id="bottom-profile" type="button">
      <span class="icon">üë§</span>
      Profil
    </button>
  </nav>

  <!-- NAV SCRIPT (tanpa Firebase) -->
  <script>
    function go(path) { window.location.href = path; }

    function setActiveTopNav(id){
      document.querySelectorAll(".top-nav button").forEach(b=>b.classList.remove("active"));
      const t = document.getElementById(id);
      if(t) t.classList.add("active");

      document.querySelectorAll(".bottom-nav button").forEach(b=>b.classList.remove("active"));
      const map = {
        "nav-home":"bottom-home",
        "nav-wallet":"bottom-wallet",
        "nav-orders":"bottom-orders",
        "nav-profile":"bottom-profile",
      };
      const bottomId = map[id];
      if(bottomId){
        const b = document.getElementById(bottomId);
        if(b) b.classList.add("active");
      }
    }

    // Top nav
    document.getElementById("nav-home").onclick = ()=>{ setActiveTopNav("nav-home"); go("index.html"); };
    document.getElementById("nav-wallet").onclick = ()=>{ setActiveTopNav("nav-wallet"); go("wallet.html"); };
    document.getElementById("nav-orders").onclick = ()=>{ setActiveTopNav("nav-orders"); go("orders.html"); };
    document.getElementById("nav-profile").onclick = ()=>{ setActiveTopNav("nav-profile"); go("profile.html"); };

    // Bottom nav
    document.getElementById("bottom-home").onclick   = ()=>{ setActiveTopNav("nav-home"); go("index.html"); };
    document.getElementById("bottom-wallet").onclick = ()=>{ setActiveTopNav("nav-wallet"); go("wallet.html"); };
    document.getElementById("bottom-orders").onclick = ()=>{ setActiveTopNav("nav-orders"); go("orders.html"); };
    document.getElementById("bottom-profile").onclick= ()=>{ setActiveTopNav("nav-profile"); go("profile.html"); };

    // Halaman ini = wallet
    setActiveTopNav("nav-wallet");
  </script>

  <!-- FIREBASE SCRIPT -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
    import {
      getFirestore,
      collection,
      doc,
      addDoc,
      getDocs,
      query,
      where,
      getDoc,
      updateDoc,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBpsfDmupS9wq-iNge5aYvknmw5bSryd3A",
      authDomain: "toko-barmods.firebaseapp.com",
      projectId: "toko-barmods",
      storageBucket: "toko-barmods.firebasestorage.app",
      messagingSenderId: "284047189012",
      appId: "1:284047189012:web:6ef0c6891adab08a383301",
    };

    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);
    const USERS  = "users";
    const TOPUPS = "topups";

    const emailEl  = document.getElementById("wallet-email");
    const saldoEl  = document.getElementById("wallet-saldo");
    const wErrorEl = document.getElementById("wallet-error");
    const historyEl= document.getElementById("topup-history");
    const topupMsg = document.getElementById("topup-msg");

    // Ambil user dari localStorage
    const userEmail = localStorage.getItem("userEmail");
    const userId    = localStorage.getItem("userId");

    if (!userEmail) {
      // belum login
      window.location.href = "login.html";
    } else {
      emailEl.textContent = userEmail;
      loadSaldo();
      loadTopups();
    }

    async function loadSaldo(){
      try{
        saldoEl.textContent = "Rp 0";
        wErrorEl.textContent = "";

        // cari user by email (tanpa orderBy ‚Üí nggak perlu index tambahan)
        const qUser = query(collection(db, USERS), where("email","==",userEmail));
        const snap  = await getDocs(qUser);

        if (snap.empty){
          wErrorEl.textContent = "Akun belum terdaftar di database users.";
          return;
        }

        const docSnap = snap.docs[0];
        const data = docSnap.data();
        const balance = Number(data.balance ?? 0);
        saldoEl.textContent = "Rp " + balance.toLocaleString("id-ID");

        // Simpan id user doc kalau mau dipakai
        localStorage.setItem("userDocId", docSnap.id);
      }catch(e){
        console.error(e);
        wErrorEl.textContent = "Gagal memuat saldo: " + (e.message || e);
      }
    }

    async function loadTopups(){
      try{
        historyEl.textContent = "Memuat...";
        const snap = await getDocs(collection(db, TOPUPS));

        const list = [];
        snap.forEach(d=>{
          const t = d.data();
          if (t.userEmail === userEmail){
            list.push({id:d.id, ...t});
          }
        });

        if (!list.length){
          historyEl.textContent = "Belum ada riwayat topup.";
          return;
        }

        // sort terbaru dulu
        list.sort((a,b)=>{
          const ta = a.createdAt?.seconds || 0;
          const tb = b.createdAt?.seconds || 0;
          return tb - ta;
        });

        historyEl.innerHTML = "";
        list.forEach(t=>{
          const div = document.createElement("div");
          div.className="history-item";

          const created = t.createdAt?.toDate ? t.createdAt.toDate().toLocaleString("id-ID") : "-";

          const status = t.status || "pending";
          const statusClass =
            status === "sukses" ? "status-sukses" :
            status === "proses" ? "status-proses" :
            status === "error"  ? "status-error" :
                                  "status-pending";

          div.innerHTML = `
            <div class="history-row-top">
              <span class="history-amount">Rp ${Number(t.amount??0).toLocaleString("id-ID")}</span>
              <span class="history-status ${statusClass}">${status}</span>
            </div>
            <div>${t.danaNumber ?? "-"}</div>
            <div class="history-date">${created}</div>
          `;
          historyEl.appendChild(div);
        });
      }catch(e){
        console.error(e);
        historyEl.textContent = "Gagal memuat riwayat topup: " + (e.message || e);
      }
    }

    // Kirim topup
    document.getElementById("btn-topup").addEventListener("click", async ()=>{
      const amount = Number(document.getElementById("topup-amount").value || 0);
      const dana   = document.getElementById("topup-dana").value.trim();
      topupMsg.textContent = "";

      if (!amount || amount < 1000){
        topupMsg.textContent = "Nominal minimal 1000.";
        return;
      }
      if (!dana){
        topupMsg.textContent = "Nomor DANA tidak boleh kosong.";
        return;
      }

      try{
        await addDoc(collection(db, TOPUPS), {
          userEmail,
          userId: userId || null,
          amount,
          danaNumber: dana,
          status: "pending",
          createdAt: serverTimestamp(),
        });
        topupMsg.style.color = "#15803d";
        topupMsg.textContent = "Permintaan topup terkirim. Tunggu admin memproses.";
        document.getElementById("topup-amount").value = "";
        document.getElementById("topup-dana").value   = "";
        loadTopups();
      }catch(e){
        console.error(e);
        topupMsg.style.color = "#dc2626";
        topupMsg.textContent = "Gagal mengirim permintaan: " + (e.message || e);
      }
    });
  </script>
</body>
</html>
