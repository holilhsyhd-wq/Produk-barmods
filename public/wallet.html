<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import {
    getFirestore,
    collection,
    getDocs,
    doc,
    getDoc,
    setDoc,
    addDoc,
    query,
    where
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  import {
    getAuth,
    onAuthStateChanged,
    signOut
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBpsfDmupS9wq-iNge5aYvknmw5bSryd3A",
    authDomain: "toko-barmods.firebaseapp.com",
    projectId: "toko-barmods",
    storageBucket: "toko-barmods.appspot.com",
    messagingSenderId: "284047189012",
    appId: "1:284047189012:web:6ef0c6891adab08a383301"
  };

  const app  = initializeApp(firebaseConfig);
  const db   = getFirestore(app);
  const auth = getAuth(app);

  const saldoTextEl = document.getElementById('saldoText');
  const userEmailEl = document.getElementById('userEmail');
  const topupMsgEl  = document.getElementById('topupMsg');
  const tbodyTopup  = document.getElementById('topupTable').querySelector('tbody');

  let currentUser = null;
  let userBalance = 0;

  function formatRupiah(num){
    num = Math.floor(num || 0);
    return 'Rp ' + num.toString().replace(/\B(?=(\d{3})+(?!\d))/g,'.');
  }

  onAuthStateChanged(auth, async (user)=>{
    if(!user){
      window.location.href = 'login.html';
      return;
    }
    currentUser = user;
    userEmailEl.textContent = user.email || '-';
    await loadBalance();
    await loadTopups();
  });

  document.getElementById('logoutBtn').onclick = async ()=>{
    try{ await signOut(auth); }catch(e){}
  };

  async function loadBalance(){
    const ref = doc(db,'users',currentUser.uid);
    const snap = await getDoc(ref);
    if(!snap.exists()){
      await setDoc(ref,{
        email: currentUser.email || '',
        balance: 0,
        createdAt: new Date().toISOString()
      });
      userBalance = 0;
    } else {
      userBalance = snap.data().balance || 0;
    }
    saldoTextEl.textContent = formatRupiah(userBalance);
  }

  async function loadTopups(){
    if(!currentUser) return;

    tbodyTopup.innerHTML = '';

    const col = collection(db,'topups');
    // tanpa orderBy, jadi tidak perlu index gabungan
    const q   = query(col, where('userUid','==',currentUser.uid));
    const snap = await getDocs(q);

    const list = [];
    snap.forEach(d => list.push(d.data()));

    // sort di client berdasarkan createdAt desc
    list.sort((a,b) => {
      const aa = a.createdAt || '';
      const bb = b.createdAt || '';
      return bb.localeCompare(aa);
    });

    list.forEach((t,i)=>{
      const tr = document.createElement('tr');
      const dTime = new Date(t.createdAt || Date.now());
      tr.innerHTML = `
        <td>${i+1}</td>
        <td>${dTime.toLocaleString('id-ID')}</td>
        <td>${formatRupiah(t.amount || 0)}</td>
        <td>${t.danaNumber || ''}</td>
        <td>${t.status || 'pending'}</td>
      `;
      tbodyTopup.appendChild(tr);
    });
  }

  window.buatTopup = async function(){
    if(!currentUser) return;

    const amount = parseInt(document.getElementById('topupAmount').value,10);
    const dana   = document.getElementById('topupDana').value.trim();
    const nama   = document.getElementById('topupNama').value.trim();
    const note   = document.getElementById('topupNote').value.trim();

    topupMsgEl.textContent = '';
    topupMsgEl.className = 'msg';

    if(isNaN(amount) || amount < 1000){
      topupMsgEl.textContent = 'Nominal minimal 1000.';
      topupMsgEl.className = 'msg err';
      return;
    }
    if(!dana || !nama){
      topupMsgEl.textContent = 'Nomor DANA dan Atas nama wajib diisi.';
      topupMsgEl.className = 'msg err';
      return;
    }

    try{
      const obj = {
        userUid: currentUser.uid,
        userEmail: currentUser.email || '',
        amount,
        danaNumber: dana,
        danaName: nama,
        note: note || '',
        status: 'pending',
        createdAt: new Date().toISOString()
      };

      await addDoc(collection(db,'topups'), obj);

      topupMsgEl.textContent =
        'Permintaan topup dibuat. Status: pending. Kirim bukti transfer ke WhatsApp admin.';
      topupMsgEl.className = 'msg ok';

      // reset form
      document.getElementById('topupAmount').value = '';
      document.getElementById('topupDana').value = '';
      document.getElementById('topupNama').value = '';
      document.getElementById('topupNote').value = '';

      // kalau loadTopups error (misal index dsb), jangan bikin pesan gagal topup
      try {
        await loadTopups();
      } catch(e){
        console.error('Gagal load riwayat topup', e);
      }

    } catch(e){
      console.error(e);
      topupMsgEl.textContent = 'Gagal membuat permintaan topup. Coba lagi.';
      topupMsgEl.className = 'msg err';
    }
  };
</script>
