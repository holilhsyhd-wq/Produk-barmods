<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Barmods Digital Store</title>
  <style>
    :root {
      --blue: #0052cc;
      --blue-soft: #e3f0ff;
      --bg: #f3f4f6;
      --text: #111827;
      --muted: #6b7280;
      --card: #ffffff;
      --border: #e5e7eb;
      --primary: #2563eb;
      --danger: #dc2626;
      --success: #16a34a;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      background: var(--blue);
      color: #fff;
      padding: 14px 16px;
      text-align: center;
      font-size: 20px;
      font-weight: 700;
    }

    main {
      flex: 1;
      padding: 12px 12px 80px;
      max-width: 900px;
      margin: 0 auto;
      width: 100%;
    }

    .tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 10px;
    }

    .tab-btn {
      flex: 1;
      border-radius: 999px;
      border: 2px solid var(--blue);
      background: #fff;
      color: var(--blue);
      padding: 8px 4px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
    }

    .tab-btn.active {
      background: var(--blue);
      color: #fff;
    }

    .category-label {
      font-size: 14px;
      margin-bottom: 8px;
    }

    .product-error {
      color: var(--danger);
      font-size: 13px;
      margin-bottom: 6px;
      white-space: pre-wrap;
    }

    .products {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .card {
      background: var(--card);
      border-radius: 18px;
      padding: 12px 14px;
      border: 1px solid var(--border);
      box-shadow: 0 4px 12px rgba(15, 23, 42, 0.06);
    }

    .card-title {
      font-size: 16px;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .card-sub {
      font-size: 13px;
      color: var(--muted);
      margin-bottom: 4px;
    }

    .card-price {
      font-size: 14px;
      font-weight: 700;
      color: var(--success);
      margin-bottom: 4px;
    }

    .stock {
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 6px;
    }

    .btn-order {
      display: inline-block;
      border-radius: 999px;
      border: none;
      padding: 7px 14px;
      font-size: 14px;
      font-weight: 600;
      background: var(--blue);
      color: #fff;
      cursor: pointer;
    }

    .btn-order:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* bottom nav */
    .bottom-nav {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      background: #0052cc;
      display: flex;
      justify-content: space-around;
      padding: 6px 4px 8px;
      z-index: 50;
    }

    .nav-item {
      flex: 1;
      text-align: center;
      color: #e5e7eb;
      font-size: 11px;
      text-decoration: none;
    }

    .nav-item span {
      display: block;
    }

    .nav-item .icon {
      font-size: 18px;
      margin-bottom: 2px;
    }

    .nav-item.active {
      color: #ffffff;
      font-weight: 600;
    }

    /* modal */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.45);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 60;
    }

    .modal-backdrop.show {
      display: flex;
    }

    .modal {
      background: #ffffff;
      width: 100%;
      max-width: 420px;
      border-radius: 18px;
      padding: 14px 16px 16px;
    }

    .modal-header {
      font-size: 16px;
      font-weight: 700;
      margin-bottom: 6px;
    }

    .modal-sub {
      font-size: 13px;
      color: var(--muted);
      margin-bottom: 10px;
    }

    label {
      font-size: 13px;
      display: block;
      margin-bottom: 3px;
      margin-top: 6px;
    }

    input,
    textarea {
      width: 100%;
      border-radius: 10px;
      border: 1px solid var(--border);
      padding: 8px 9px;
      font-size: 14px;
    }

    textarea {
      resize: vertical;
      min-height: 60px;
    }

    .modal-actions {
      display: flex;
      gap: 8px;
      margin-top: 14px;
    }

    .btn-secondary,
    .btn-primary {
      flex: 1;
      border-radius: 999px;
      padding: 9px 10px;
      font-size: 14px;
      font-weight: 600;
      border: none;
      cursor: pointer;
    }

    .btn-secondary {
      background: #e5e7eb;
      color: #111827;
    }

    .btn-primary {
      background: var(--blue);
      color: #fff;
    }

    .modal-error {
      font-size: 13px;
      color: var(--danger);
      margin-top: 6px;
    }

    .badge-cat {
      display: inline-block;
      border-radius: 999px;
      padding: 2px 8px;
      font-size: 11px;
      background: #eff6ff;
      color: #1d4ed8;
      margin-left: 4px;
    }
  </style>
</head>
<body>
  <header>Barmods Digital Store</header>

  <main>
    <div class="tabs">
      <button id="tabPremium" class="tab-btn active" data-cat="premium">
        Premium Apps
      </button>
      <button id="tabSosmed" class="tab-btn" data-cat="sosmed">
        Sosial Media
      </button>
      <button id="tabPanel" class="tab-btn" data-cat="panel">
        Panel &amp; Tools
      </button>
    </div>

    <div id="categoryLabel" class="category-label">
      Menampilkan kategori: <strong>Premium Apps</strong>
    </div>

    <div id="productError" class="product-error" style="display:none;"></div>

    <div id="productList" class="products">
      <!-- cards produk -->
    </div>
  </main>

  <!-- bottom nav -->
  <nav class="bottom-nav">
    <a href="index.htn" class="nav-item active">
      <span class="icon">üè†</span>
      <span>Home</span>
    </a>
    <a href="wallet.html" class="nav-item">
      <span class="icon">üí≥</span>
      <span>Wallet</span>
    </a>
    <a href="orders.html" class="nav-item">
      <span class="icon">üì¶</span>
      <span>Pesanan</span>
    </a>
    <a href="profile.html" class="nav-item">
      <span class="icon">üë§</span>
      <span>Profil</span>
    </a>
  </nav>

  <!-- MODAL ORDER -->
  <div id="orderBackdrop" class="modal-backdrop">
    <div class="modal">
      <div class="modal-header" id="modalTitle">Order Produk</div>
      <div class="modal-sub" id="modalSub"></div>

      <div id="modalFields"><!-- dynamic fields --></div>

      <div class="modal-error" id="modalError" style="display:none;"></div>

      <div class="modal-actions">
        <button id="btnCancel" class="btn-secondary" type="button">Batal</button>
        <button id="btnSubmitOrder" class="btn-primary" type="button">
          Order Sekarang
        </button>
      </div>
    </div>
  </div>

  <script type="module">
    import {
      initializeApp
    } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";

    import {
      getFirestore,
      collection,
      getDocs,
      query,
      where,
      doc,
      getDoc,
      updateDoc,
      addDoc,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";

    // ===== FIREBASE CONFIG (SAMA DENGAN WALLET) =====
    const firebaseConfig = {
      apiKey: "AIzaSyBpsfDmupS9wq-iNge5aYvknmw5bSryd3A",
      authDomain: "toko-barmods.firebaseapp.com",
      projectId: "toko-barmods",
      storageBucket: "toko-barmods.firebasestorage.app",
      messagingSenderId: "284047189012",
      appId: "1:284047189012:web:6ef0c6891adab08a383301"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // ===== CEK LOGIN USER (PAKAI LOCALSTORAGE) =====
    const userUid = localStorage.getItem("userUid");
    const userEmail = localStorage.getItem("userEmail");
    if (!userUid || !userEmail) {
      window.location.href = "login.html";
    }

    // ===== DOM ELEMENTS =====
    const productList = document.getElementById("productList");
    const productError = document.getElementById("productError");
    const categoryLabel = document.getElementById("categoryLabel");

    const tabButtons = document.querySelectorAll(".tab-btn");

    const orderBackdrop = document.getElementById("orderBackdrop");
    const modalTitle = document.getElementById("modalTitle");
    const modalSub = document.getElementById("modalSub");
    const modalFields = document.getElementById("modalFields");
    const modalError = document.getElementById("modalError");
    const btnCancel = document.getElementById("btnCancel");
    const btnSubmitOrder = document.getElementById("btnSubmitOrder");

    let currentCategory = "premium";
    let currentProduct = null;
    let currentSaldo = 0;

    function formatRupiah(n) {
      const num = Number(n || 0);
      return "Rp " + num.toLocaleString("id-ID");
    }

    async function loadSaldo() {
      try {
        const ref = doc(db, "users", userUid);
        const snap = await getDoc(ref);
        if (snap.exists()) {
          const data = snap.data();
          currentSaldo = Number(data.balance || 0);
        }
      } catch (err) {
        console.error("Gagal ambil saldo:", err);
      }
    }

    // ===== LOAD PRODUK TANPA COMPOSITE INDEX =====
    async function loadProducts(category) {
      productError.style.display = "none";
      productError.textContent = "";
      productList.innerHTML = "<div class='card-sub'>Memuat produk...</div>";

      try {
        const col = collection(db, "products");
        let q;

        if (!category) category = currentCategory;

        if (category === "premium") {
          q = query(col, where("category", "==", "premium"));
        } else if (category === "sosmed") {
          q = query(col, where("category", "==", "sosmed"));
        } else {
          q = query(col, where("category", "==", "panel"));
        }

        const snap = await getDocs(q);

        if (snap.empty) {
          productList.innerHTML =
            "<div class='card-sub'>Tidak ada produk.</div>";
          return;
        }

        const items = [];
        snap.forEach((d) => {
          const data = d.data();
          items.push({
            _docId: d.id,
            ...data
          });
        });

        // Sort manual di client supaya tidak butuh composite index
        items.sort((a, b) => {
          const ida = Number(a.id || 0);
          const idb = Number(b.id || 0);
          return ida - idb;
        });

        renderProducts(items);
      } catch (err) {
        console.error(err);
        productList.innerHTML = "";
        productError.style.display = "block";
        productError.textContent =
          "Gagal memuat produk: " + (err.message || String(err));
      }
    }

    function renderProducts(items) {
      productList.innerHTML = "";
      items.forEach((p) => {
        const card = document.createElement("div");
        card.className = "card";

        const price = Number(p.price || 0);
        const stok = p.stock === 0 || p.stock === "0" ? 0 : (p.stock ?? "-");

        const catLabel =
          p.category === "sosmed"
            ? "Sosial Media"
            : p.category === "panel"
            ? "Panel & Tools"
            : "Premium Apps";

        card.innerHTML = `
          <div class="card-title">
            ${p.name || "-"}
            <span class="badge-cat">${catLabel}</span>
          </div>
          <div class="card-price">${formatRupiah(price)}</div>
          <div class="stock">Stok: ${stok}</div>
          <button class="btn-order" type="button">Order</button>
        `;

        const btn = card.querySelector(".btn-order");
        if (stok === 0 || stok === "0") {
          btn.disabled = true;
          btn.textContent = "Stok habis";
        } else {
          btn.addEventListener("click", () => openOrderModal(p));
        }

        productList.appendChild(card);
      });
    }

    // ===== MODAL ORDER =====
    function openOrderModal(product) {
      currentProduct = product;
      modalError.style.display = "none";
      modalError.textContent = "";

      modalTitle.textContent = "Order: " + (product.name || "-");

      modalSub.textContent =
        "Harga: " +
        formatRupiah(product.price || 0) +
        " ‚Ä¢ Saldo kamu: " +
        formatRupiah(currentSaldo) +
        " ‚Ä¢ Kategori: " +
        (product.category === "sosmed"
          ? "sosmed"
          : product.category === "panel"
          ? "panel"
          : "premium apps");

      buildModalFields(product.category || "premium");

      orderBackdrop.classList.add("show");
    }

    function closeOrderModal() {
      orderBackdrop.classList.remove("show");
      currentProduct = null;
    }

    btnCancel.addEventListener("click", closeOrderModal);

    function buildModalFields(category) {
      // semua input kita beri id supaya gampang diambil
      if (category === "sosmed") {
        modalFields.innerHTML = `
          <label for="field-username">Username akun (tidak boleh private)</label>
          <input id="field-username" placeholder="contoh: @username" />

          <label for="field-link">Link postingan / profil</label>
          <input id="field-link" placeholder="https://..." />

          <label for="field-note">Catatan tambahan (opsional)</label>
          <textarea id="field-note" placeholder="Misal: kirim pelan-pelan agar aman"></textarea>
        `;
      } else if (category === "panel") {
        modalFields.innerHTML = `
          <label for="field-user-panel">User panel</label>
          <input id="field-user-panel" placeholder="User panel" />

          <label for="field-pass-panel">Password panel</label>
          <input id="field-pass-panel" placeholder="Password panel" />

          <label for="field-note">Catatan tambahan (opsional)</label>
          <textarea id="field-note" placeholder="Misal: lokasi server, catatan lain"></textarea>
        `;
      } else {
        // premium apps
        modalFields.innerHTML = `
          <label for="field-dana-number">Nomor DANA kamu</label>
          <input id="field-dana-number" placeholder="Contoh: 08xxxxxxxxxx" />

          <label for="field-dana-name">Atas nama DANA</label>
          <input id="field-dana-name" placeholder="Nama sesuai akun DANA" />

          <label for="field-note">Catatan tambahan (opsional)</label>
          <textarea id="field-note" placeholder="Misal: email akun yang dipakai login, dsb."></textarea>
        `;
      }
    }

    btnSubmitOrder.addEventListener("click", submitOrder);

    async function submitOrder() {
      modalError.style.display = "none";
      modalError.textContent = "";

      if (!currentProduct) return;

      const cat = currentProduct.category || "premium";
      const extra = {};

      if (cat === "sosmed") {
        const username = document.getElementById("field-username").value.trim();
        const link = document.getElementById("field-link").value.trim();
        const note = document.getElementById("field-note").value.trim();

        if (!username || !link) {
          showModalError("Username dan link harus diisi.");
          return;
        }
        extra.sosmedUsername = username;
        extra.sosmedlink = link;
        if (note) extra.note = note;
      } else if (cat === "panel") {
        const userPanel = document
          .getElementById("field-user-panel")
          .value.trim();
        const passPanel = document
          .getElementById("field-pass-panel")
          .value.trim();
        const note = document.getElementById("field-note").value.trim();

        if (!userPanel || !passPanel) {
          showModalError("User dan password panel harus diisi.");
          return;
        }
        extra.panelUser = userPanel;
        extra.panelPass = passPanel;
        if (note) extra.note = note;
      } else {
        const danaNumber = document
          .getElementById("field-dana-number")
          .value.trim();
        const danaName = document
          .getElementById("field-dana-name")
          .value.trim();
        const note = document.getElementById("field-note").value.trim();

        if (!danaNumber || !danaName) {
          showModalError("Nomor dan nama DANA harus diisi.");
          return;
        }
        extra.danaNumber = danaNumber;
        extra.danaName = danaName;
        if (note) extra.note = note;
      }

      const price = Number(currentProduct.price || 0);
      if (!price || price <= 0) {
        showModalError("Harga produk tidak valid.");
        return;
      }

      // cek saldo
      await loadSaldo(); // refresh saldo terbaru
      if (currentSaldo < price) {
        showModalError(
          "Saldo tidak cukup. Harga: " +
            formatRupiah(price) +
            " ‚Ä¢ Saldo kamu: " +
            formatRupiah(currentSaldo)
        );
        return;
      }

      btnSubmitOrder.disabled = true;
      btnSubmitOrder.textContent = "Memproses...";

      try {
        // kurangi saldo user
        const userRef = doc(db, "users", userUid);
        const userSnap = await getDoc(userRef);
        if (!userSnap.exists()) {
          throw new Error("Data user tidak ditemukan.");
        }
        const udata = userSnap.data();
        const saldoNow = Number(udata.balance || 0);
        if (saldoNow < price) {
          throw new Error("Saldo kamu tidak cukup.");
        }
        await updateDoc(userRef, { balance: saldoNow - price });
        currentSaldo = saldoNow - price;

        // simpan order
        const orderData = {
          userId: userUid,
          userEmail,
          productId: currentProduct.id ?? null,
          productDocId: currentProduct._docId,
          productName: currentProduct.name || "-",
          category: currentProduct.category || "premium",
          price: price,
          status: "pending",
          createdAt: serverTimestamp(),
          ...extra
        };

        await addDoc(collection(db, "orders"), orderData);

        alert("Order berhasil dibuat. Status: pending.");
        closeOrderModal();
        // opsional: arahkan ke halaman pesanan
        // window.location.href = "orders.html";
      } catch (err) {
        console.error(err);
        showModalError(
          "Gagal membuat order: " + (err.message || String(err))
        );
      } finally {
        btnSubmitOrder.disabled = false;
        btnSubmitOrder.textContent = "Order Sekarang";
      }
    }

    function showModalError(msg) {
      modalError.style.display = "block";
      modalError.textContent = msg;
    }

    // ===== TAB HANDLER =====
    tabButtons.forEach((btn) => {
      btn.addEventListener("click", () => {
        const cat = btn.dataset.cat;
        currentCategory = cat;

        tabButtons.forEach((b) => b.classList.remove("active"));
        btn.classList.add("active");

        const labelText =
          cat === "sosmed"
            ? "Sosial Media"
            : cat === "panel"
            ? "Panel & Tools"
            : "Premium Apps";

        categoryLabel.innerHTML =
          'Menampilkan kategori: <strong>' + labelText + "</strong>";

        loadProducts(cat);
      });
    });

    // ===== INIT =====
    await loadSaldo();
    await loadProducts("premium");
  </script>
</body>
</html>
