<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Daftar Pesanan - Barmods</title>
  <style>
    body{
      margin:0;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:#020617;
      color:#e5e7eb;
      padding-bottom:60px;
    }
    header{
      text-align:center;
      padding:14px 0;
      background:#0f172a;
      border-bottom:1px solid #1f2937;
      font-weight:700;
    }
    .card{
      background:#0f172a;
      margin:10px;
      padding:12px;
      border-radius:12px;
      border:1px solid #1f2937;
      box-shadow:0 0 10px rgba(0,0,0,0.4);
      font-size:13px;
    }
    .title{
      font-weight:600;
      margin-bottom:4px;
    }
    .label{
      font-size:11px;
      color:#9ca3af;
      margin-top:4px;
    }
    .value{
      font-size:13px;
      margin-top:2px;
    }
    .status-pill{
      display:inline-block;
      padding:2px 8px;
      border-radius:999px;
      font-size:11px;
      margin-top:4px;
    }
    .st-pending{background:#facc15;color:#111827;}
    .st-process{background:#60a5fa;color:#111827;}
    .st-success{background:#22c55e;color:#052e16;}

    .btn{
      border:none;
      border-radius:999px;
      padding:8px 12px;
      font-size:12px;
      font-weight:600;
      margin-top:8px;
      cursor:pointer;
    }
    .btn-main{background:#2563eb;color:white;}
    .btn-disabled{background:#1f2937;color:#6b7280;}

    .bottom-nav{
      position:fixed;
      left:0;right:0;bottom:0;
      height:48px;
      background:#020617;
      border-top:1px solid #1f2937;
      display:flex;
      font-size:12px;
    }
    .nav-item{
      flex:1;
      display:flex;
      align-items:center;
      justify-content:center;
      color:#9ca3af;
      text-decoration:none;
    }
    .nav-item.active{
      color:#2563eb;
      font-weight:600;
    }
  </style>
</head>
<body>

<header>Daftar Pesanan</header>

<div id="ordersContainer">
  <div class="card">Memuat pesanan...</div>
</div>

<nav class="bottom-nav">
  <a href="index.html" class="nav-item">Produk</a>
  <a href="wallet.html" class="nav-item">Wallet</a>
  <a href="orders.html" class="nav-item active">Orders</a>
  <a href="profile.html" class="nav-item">Profile</a>
</nav>

<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyBpsfDmupS9wq-iNge5aYvknmw5bSryd3A",
  authDomain: "toko-barmods.firebaseapp.com",
  projectId: "toko-barmods",
  storageBucket: "toko-barmods.firebasestorage.app",
  messagingSenderId: "284047189012",
  appId: "1:284047189012:web:6ef0c6891adab08a383301"
};
firebase.initializeApp(firebaseConfig);
const db   = firebase.firestore();
const auth = firebase.auth();

function rupiah(n){
  n = Number(n || 0);
  return "Rp " + n.toLocaleString("id-ID");
}

// ambil milidetik dari field createdAt (apapun tipenya)
function getMillis(createdAt){
  if(!createdAt) return 0;
  if(typeof createdAt.toMillis === "function") return createdAt.toMillis();
  if(typeof createdAt.toDate   === "function") return createdAt.toDate().getTime();
  if(typeof createdAt === "number") return createdAt;
  if(typeof createdAt === "string"){
    const d = new Date(createdAt);
    if(!isNaN(d.getTime())) return d.getTime();
  }
  return 0;
}

function renderOrders(uid){
  const wrap = document.getElementById("ordersContainer");
  wrap.innerHTML = `<div class="card">Memuat pesanan...</div>`;

  db.collection("orders").where("userId","==",uid).get()
    .then(snap=>{
      if(snap.empty){
        wrap.innerHTML = `<div class="card">Kamu belum punya pesanan.</div>`;
        return;
      }

      const arr = [];
      snap.forEach(doc=>{
        const o = doc.data();
        o._id   = doc.id;
        arr.push(o);
      });

      // urutkan terbaru di atas
      arr.sort((a,b)=> getMillis(b.createdAt) - getMillis(a.createdAt));

      wrap.innerHTML = "";
      arr.forEach(o=>{
        const hargaNum = Number(o.price || 0);
        const status   = o.status || "pending";

        let stClass = "st-pending";
        if(status==="process") stClass = "st-process";
        if(status==="success") stClass = "st-success";

        let tglText = "-";
        const cAt = o.createdAt;
        if(cAt){
          if(typeof cAt.toDate === "function"){
            tglText = cAt.toDate().toLocaleString("id-ID");
          }else if(typeof cAt === "number"){
            tglText = new Date(cAt).toLocaleString("id-ID");
          }else if(typeof cAt === "string"){
            tglText = cAt;
          }
        }

        const adminProd = (o.adminProduct && o.adminProduct.trim()!=="")
          ? o.adminProduct
          : "Belum dikirim";

        let btn = "";
        if(status==="success" && !o.userReceived){
          btn = `<button class="btn btn-main" onclick="markReceived('${o._id}')">Tandai sudah diterima</button>`;
        }else if(status==="success" && o.userReceived){
          btn = `<button class="btn btn-disabled" disabled>Sudah diterima</button>`;
        }

        wrap.innerHTML += `
          <div class="card">
            <div class="title">${o.productName || "(tanpa nama)"}</div>
            <div class="status-pill ${stClass}">${status.toUpperCase()}</div>

            <div class="label">Tanggal</div>
            <div class="value">${tglText}</div>

            <div class="label">Harga</div>
            <div class="value">${rupiah(hargaNum)}</div>

            <div class="label">Data yang kamu kirim</div>
            <div class="value">${o.inputUser || "-"}</div>

            <div class="label">Produk dari admin</div>
            <div class="value">${adminProd}</div>

            ${btn}
          </div>
        `;
      });
    })
    .catch(err=>{
      wrap.innerHTML = `<div class="card">Gagal memuat pesanan: ${err.message}</div>`;
    });
}

function markReceived(orderId){
  if(!confirm("Tandai produk ini sudah kamu terima?")) return;
  db.collection("orders").doc(orderId).update({userReceived:true})
    .then(()=>{
      alert("Terima kasih, pesanan ditandai sudah diterima.");
      const u = auth.currentUser;
      if(u) renderOrders(u.uid);
    })
    .catch(err=>alert("Gagal update: "+err.message));
}

// wajib login
auth.onAuthStateChanged(user=>{
  if(!user){
    location.href = "login.html";
  }else{
    renderOrders(user.uid);
  }
});
</script>
</body>
</html>
