<!DOCTYPE html>
<html lang="id">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pesanan Saya - Barmods Digital Store</title>
  <link rel="stylesheet" href="style.css">
</head>

<body>
  <header class="header">
    <h2>Pesanan Saya</h2>
    <p>Barmods Digital Store</p>

    <div class="nav-buttons">
      <a href="index.html" class="btn">Produk</a>
      <a href="profile.html" class="btn">Profil Saya</a>
      <a href="admin.html" class="btn">Admin</a>
      <button id="logoutBtn" class="btn btn-red">Logout</button>
    </div>
  </header>

  <main class="container">
    <h3>Riwayat Pesanan</h3>

    <p class="desc">
      Semua order yang kamu buat akan muncul di sini. Status: 
      <b>pending • proses • sukses • error</b>.<br>
      Jika admin mengirim produk, hasilnya muncul di kolom <b>Produk dari admin</b>.
    </p>

    <p id="errorBox" class="error" style="display:none;"></p>

    <table class="table">
      <thead>
        <tr>
          <th>#</th>
          <th>Waktu</th>
          <th>Produk</th>
          <th>Status</th>
          <th>Data Order</th>
          <th>Produk dari admin</th>
        </tr>
      </thead>
      <tbody id="orders-body">
        <tr>
          <td colspan="6">Memuat pesanan...</td>
        </tr>
      </tbody>
    </table>
  </main>

  <script type="module">

    import {
      initializeApp
    } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";

    import {
      getFirestore,
      collection,
      getDocs,
    } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";

    import {
      getAuth,
      onAuthStateChanged,
      signOut
    } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";

    // ===================== FIREBASE CONFIG =====================
    const firebaseConfig = {
      apiKey: "AIzaSyBpsfDmupS9wq-iNge5aYvknmw5bSryd3A",
      authDomain: "toko-barmods.firebaseapp.com",
      projectId: "toko-barmods",
      storageBucket: "toko-barmods.firebasestorage.app",
      messagingSenderId: "284047189012",
      appId: "1:284047189012:web:6ef0c6891adab08a383301"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // ===================== LOGOUT =====================
    document.getElementById("logoutBtn").addEventListener("click", () => {
      signOut(auth).then(() => {
        localStorage.clear();
        window.location.href = "login.html";
      });
    });

    // ===================== LOAD ORDERS =====================
    function loadOrders(userId) {
      const tbody = document.getElementById("orders-body");
      tbody.innerHTML = `<tr><td colspan="6">Memuat pesanan...</td></tr>`;

      getDocs(collection(db, "orders"))
        .then((snap) => {
          let orders = [];

          snap.forEach((doc) => {
            const data = doc.data();
            if (data.userId === userId) {
              orders.push({
                id: doc.id,
                ...data
              });
            }
          });

          // sort manual, terbaru di atas
          orders.sort((a, b) => {
            if (!a.createdAt || !b.createdAt) return 0;
            return b.createdAt.seconds - a.createdAt.seconds;
          });

          if (orders.length === 0) {
            tbody.innerHTML = `<tr><td colspan="6">Belum ada pesanan.</td></tr>`;
            return;
          }

          tbody.innerHTML = "";
          let i = 1;

          orders.forEach((o) => {
            const waktu = o.createdAt
              ? new Date(o.createdAt.seconds * 1000).toLocaleString()
              : "-";

            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${i++}</td>
              <td>${waktu}</td>
              <td>${o.productName ?? "-"}</td>
              <td>${o.status ?? "-"}</td>
              <td>${o.dataInput ?? "-"}</td>
              <td>${o.adminProduct ?? "-"}</td>
            `;
            tbody.appendChild(tr);
          });

        })
        .catch((err) => {
          document.getElementById("errorBox").style.display = "block";
          document.getElementById("errorBox").innerText =
            "Terjadi error saat mengambil pesanan: " + err.message;

          tbody.innerHTML = `<tr><td colspan="6">Gagal memuat pesanan.</td></tr>`;
        });
    }

    // ===================== CHECK LOGIN =====================
    onAuthStateChanged(auth, (user) => {
      if (!user) {
        window.location.href = "login.html";
      } else {
        loadOrders(user.uid);
      }
    });

  </script>

</body>

</html>
