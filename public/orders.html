<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Pesanan Saya - Barmods Digital Store</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- ==== SIMPLE STYLE (DARK) ==== -->
  <style>
    :root {
      --bg: #050814;
      --card: #101522;
      --card-soft: #151b2b;
      --accent: #2563eb;
      --accent-soft: #1d4ed8;
      --danger: #ef4444;
      --text: #f9fafb;
      --muted: #9ca3af;
      --border: #1f2933;
      --radius: 14px;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
    }

    body {
      background: radial-gradient(circle at top, #1e293b 0, #020617 55%);
      color: var(--text);
      min-height: 100vh;
    }

    .wrapper {
      max-width: 960px;
      margin: 0 auto;
      padding: 20px 16px 48px;
    }

    /* NAVBAR */
    .navbar {
      display: flex;
      gap: 8px;
      justify-content: flex-start;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .nav-brand {
      font-weight: 700;
      font-size: 18px;
      margin-right: auto;
    }

    .nav-btn,
    .nav-btn:visited {
      padding: 8px 16px;
      border-radius: 999px;
      border: 1px solid transparent;
      background: #0f172a;
      color: var(--text);
      text-decoration: none;
      font-size: 14px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      transition: background 0.15s ease, transform 0.1s ease,
        border-color 0.15s ease;
      white-space: nowrap;
    }

    .nav-btn:hover {
      background: #1e293b;
      transform: translateY(-1px);
    }

    .nav-btn.logout {
      background: var(--danger);
      border-color: #b91c1c;
    }

    .nav-btn.logout:hover {
      background: #b91c1c;
    }

    /* HEADER */
    h1 {
      font-size: 26px;
      margin-bottom: 4px;
    }

    .subtitle {
      color: var(--muted);
      margin-bottom: 16px;
    }

    /* CARD */
    .card {
      background: linear-gradient(145deg, #020617, #020617ee);
      border-radius: 24px;
      padding: 20px 18px;
      border: 1px solid rgba(148, 163, 184, 0.15);
      box-shadow: 0 20px 40px rgba(15, 23, 42, 0.8);
      backdrop-filter: blur(18px);
      margin-bottom: 18px;
    }

    .card-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .card-text {
      font-size: 14px;
      color: var(--muted);
      line-height: 1.5;
    }

    .highlight-dot {
      font-weight: 600;
      color: #e5e7eb;
    }

    .error-text {
      margin-top: 10px;
      font-size: 14px;
      color: var(--danger);
      white-space: pre-wrap;
    }

    /* TABLE */
    .table-card {
      background: #020617ee;
      border-radius: 24px;
      padding: 0;
      border: 1px solid rgba(148, 163, 184, 0.18);
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.9);
      overflow: hidden;
    }

    .table-wrapper {
      width: 100%;
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
      min-width: 640px;
    }

    thead {
      background: #020617;
    }

    th,
    td {
      padding: 10px 10px;
      border-bottom: 1px solid rgba(30, 64, 100, 0.5);
      text-align: left;
    }

    th {
      font-weight: 500;
      color: #cbd5f5;
      font-size: 13px;
    }

    tbody tr:nth-child(even) {
      background: rgba(15, 23, 42, 0.75);
    }

    .status-badge {
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 600;
      text-transform: lowercase;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .status-pending {
      background: rgba(245, 158, 11, 0.15);
      color: #fbbf24;
    }

    .status-proses {
      background: rgba(59, 130, 246, 0.15);
      color: #60a5fa;
    }

    .status-sukses {
      background: rgba(16, 185, 129, 0.15);
      color: #34d399;
    }

    .status-error {
      background: rgba(239, 68, 68, 0.15);
      color: #f87171;
    }

    .muted {
      color: var(--muted);
      font-size: 13px;
    }

    .admin-product {
      font-size: 13px;
      white-space: pre-wrap;
    }

    .empty {
      padding: 14px 0;
      font-size: 14px;
      color: var(--muted);
      text-align: center;
    }

    @media (max-width: 640px) {
      .wrapper {
        padding-inline: 12px;
      }
      h1 {
        font-size: 22px;
      }
      .nav-brand {
        flex-basis: 100%;
        margin-bottom: 8px;
      }
      .navbar {
        gap: 6px;
      }
    }
  </style>
</head>
<body>
  <div class="wrapper">
    <!-- NAVBAR -->
    <nav class="navbar">
      <div class="nav-brand">Barmods Digital Store</div>
      <a href="index.html" class="nav-btn">Produk</a>
      <a href="profile.html" class="nav-btn">Profil Saya</a>
      <a href="orders.html" class="nav-btn">Pesanan Saya</a>
      <a href="wallet.html" class="nav-btn">Saldo</a>
      <a href="admin.html" class="nav-btn">Admin</a>
      <button id="logoutBtn" class="nav-btn logout">Logout</button>
    </nav>

    <!-- HEADER -->
    <h1>Pesanan Saya</h1>
    <p class="subtitle">
      Semua pesanan yang kamu buat akan muncul di sini. Akun:
      <span id="userEmail" class="highlight-dot">-</span>
    </p>

    <!-- INFO CARD -->
    <section class="card">
      <div class="card-title">Riwayat Pesanan</div>
      <p class="card-text">
        Semua order yang kamu buat akan muncul di sini. Status:
        <span class="highlight-dot">pending</span> •
        <span class="highlight-dot">proses</span> •
        <span class="highlight-dot">sukses</span> •
        <span class="highlight-dot">error</span>.
        Jika admin mengirim produk, hasilnya akan muncul di kolom
        <span class="highlight-dot">Produk dari admin</span>.
      </p>
      <div id="errorBox" class="error-text" style="display:none;"></div>
    </section>

    <!-- TABEL PESANAN -->
    <section class="table-card">
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>Waktu</th>
              <th>Produk</th>
              <th>Status</th>
              <th>Data Order</th>
              <th>Produk dari admin</th>
            </tr>
          </thead>
          <tbody id="ordersBody">
            <tr>
              <td colspan="6" class="empty">Memuat pesanan...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>
  </div>

  <!-- ================= FIREBASE SCRIPT ================= -->
  <script type="module">
    import {
      initializeApp
    } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";

    import {
      getAuth,
      onAuthStateChanged,
      signOut
    } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";

    import {
      getFirestore,
      collection,
      query,
      where,
      getDocs
    } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";

    // ==== KONFIGURASI FIREBASE (punyamu) ====
    const firebaseConfig = {
      apiKey: "AIzaSyBpsfDmupS9wq-iNge5aYvknmw5bSryd3A",
      authDomain: "toko-barmods.firebaseapp.com",
      projectId: "toko-barmods",
      storageBucket: "toko-barmods.firebasestorage.app",
      messagingSenderId: "284047189012",
      appId: "1:284047189012:web:6ef0c6891adab08a383301"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const tbody = document.getElementById("ordersBody");
    const errorBox = document.getElementById("errorBox");
    const emailSpan = document.getElementById("userEmail");

    // ===== LOGOUT =====
    document.getElementById("logoutBtn").addEventListener("click", async () => {
      try {
        await signOut(auth);
        window.location.href = "login.html";
      } catch (e) {
        alert("Gagal logout: " + e.message);
      }
    });

    // ===== CEK LOGIN DAN LOAD PESANAN =====
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        // belum login → pindah ke login
        window.location.href = "login.html";
        return;
      }

      emailSpan.textContent = user.email || "-";
      loadOrders(user);
    });

    async function loadOrders(user) {
      tbody.innerHTML = `<tr><td colspan="6" class="empty">Memuat pesanan...</td></tr>`;
      errorBox.style.display = "none";
      errorBox.textContent = "";

      try {
        // Ambil hanya pesanan milik user ini, TANPA orderBy → tidak perlu index
        const q = query(
          collection(db, "orders"),
          where("userId", "==", user.uid)
        );

        const snap = await getDocs(q);

        if (snap.empty) {
          tbody.innerHTML = `<tr><td colspan="6" class="empty">Belum ada pesanan.</td></tr>`;
          return;
        }

        // Sort manual by createdAt desc (kalau ada)
        const docs = [];
        snap.forEach((doc) => docs.push({ id: doc.id, ...doc.data() }));
        docs.sort((a, b) => {
          const ta = a.createdAt?.toMillis ? a.createdAt.toMillis() : 0;
          const tb = b.createdAt?.toMillis ? b.createdAt.toMillis() : 0;
          return tb - ta; // terbaru di atas
        });

        tbody.innerHTML = "";
        let i = 1;
        for (const o of docs) {
          const waktu = o.createdAt?.toDate
            ? o.createdAt.toDate().toLocaleString("id-ID")
            : "-";

          const status = (o.status || "pending").toLowerCase();
          let statusClass = "status-pending";
          if (status === "proses") statusClass = "status-proses";
          else if (status === "sukses") statusClass = "status-sukses";
          else if (status === "error") statusClass = "status-error";

          // build data order singkat (tanpa nomor DANA kalau bukan topup)
          let dataOrder = "";
          if (o.category === "sosmed") {
            if (o.sosmedUsername) dataOrder += `User: ${o.sosmedUsername}\n`;
            if (o.sosmedLink) dataOrder += `Link: ${o.sosmedLink}\n`;
          } else if (o.category === "panel") {
            if (o.panelUser) dataOrder += `User panel: ${o.panelUser}\n`;
            if (o.panelPass) dataOrder += `Pass panel: ${o.panelPass}\n`;
          } else if (o.category === "apk") {
            dataOrder += o.note ? o.note : "Order aplikasi premium";
          } else {
            // fallback
            if (o.danaNumber) dataOrder += `DANA: ${o.danaNumber}\n`;
            if (o.danaName) dataOrder += `Atas nama: ${o.danaName}\n`;
          }

          if (!dataOrder) dataOrder = "-";

          const adminProduct = o.adminProduct?.trim()
            ? o.adminProduct
            : "Belum ada. Tunggu admin mengirim produk.";

          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${i++}</td>
            <td class="muted">${waktu}</td>
            <td>${o.productName || "-"}</td>
            <td><span class="status-badge ${statusClass}">${status}</span></td>
            <td><pre class="muted" style="white-space:pre-wrap; margin:0;">${dataOrder}</pre></td>
            <td><div class="admin-product">${adminProduct}</div></td>
          `;
          tbody.appendChild(tr);
        }
      } catch (err) {
        console.error(err);
        errorBox.style.display = "block";
        errorBox.textContent =
          "Terjadi error saat mengambil pesanan: " + err.message;
        tbody.innerHTML = `<tr><td colspan="6" class="empty">Gagal memuat pesanan.</td></tr>`;
      }
    }
  </script>
</body>
</html>
